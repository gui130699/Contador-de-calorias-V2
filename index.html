<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <title>NutriX</title>
  <!-- Dexie.js DESABILITADO - Usando lista de 140 alimentos inline -->
  <!-- <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script> -->
  <!-- <script src="./db.js"></script> -->
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Vari√°veis CSS para cores e espa√ßamentos */
    :root {
      --bg-primary: #0a0f1c;
      --bg-secondary: #111827;
      --bg-glass: rgba(255, 255, 255, 0.08);
      --bg-glass-hover: rgba(255, 255, 255, 0.12);
      --border-glass: rgba(255, 255, 255, 0.1);
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --accent-primary: #06b6d4;
      --accent-secondary: #0891b2;
      --accent-tertiary: #22d3ee;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --radius-sm: 0.5rem;
      --radius-md: 0.75rem;
      --radius-lg: 1rem;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
    }

    /* Base styles */
    html, body {
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* Background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 20%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(34, 211, 238, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
      z-index: -1;
      pointer-events: none;
    }

    /* Glass effect cards */
    .glass {
      backdrop-filter: blur(20px) saturate(180%);
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      box-shadow: var(--shadow-lg);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .glass:hover {
      background: var(--bg-glass-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-md);
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      border: none;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--accent-secondary) 0%, var(--accent-primary) 100%);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-ghost {
      background: var(--bg-glass);
      color: var(--text-secondary);
      border: 1px solid var(--border-glass);
    }

    .btn-ghost:hover {
      background: var(--bg-glass-hover);
      color: var(--text-primary);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-glass);
      color: var(--text-primary);
      border: 1px solid var(--border-glass);
      box-shadow: var(--shadow-sm);
      transition: transform .15s ease, background .15s ease;
    }

    .btn-secondary:hover {
      background: var(--bg-glass-hover);
      transform: translateY(-1px);
    }

    /* Form elements */
    input, select {
      background: var(--bg-glass) !important;
      border: 1px solid var(--border-glass) !important;
      color: var(--text-primary) !important;
      border-radius: var(--radius-md);
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-soft);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent-primary) !important;
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1), var(--shadow-glow);
      background: rgba(255, 255, 255, 0.1) !important;
      transform: translateY(-1px);
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    /* Cards e containers */
    .card {
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      border-radius: var(--radius-lg);
      backdrop-filter: blur(15px);
      box-shadow: var(--shadow-soft);
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      border-color: var(--accent-primary);
    }

    /* Navega√ß√£o com efeitos */
    nav button {
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    nav button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    nav button:hover::before {
      left: 100%;
    }

    /* Modal com glassmorphism */
    #foodModal > div {
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      backdrop-filter: blur(20px);
      box-shadow: var(--shadow-glow);
    }

    /* Bot√µes especiais */
    .btn-gradient {
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(var(--rgb-accent-primary), 0.3);
      position: relative;
      overflow: hidden;
    }

    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(var(--rgb-accent-primary), 0.4);
    }

    .btn-gradient::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s ease;
    }

    .btn-gradient:hover::before {
      left: 100%;
    }

    /* Anima√ß√µes e transi√ß√µes globais */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .animate-fade-in {
      animation: fadeInUp 0.5s ease-out;
    }

    .animate-slide-in {
      animation: slideInRight 0.4s ease-out;
    }

    .animate-pulse-soft {
      animation: pulse 2s infinite;
    }

    /* Efeitos de hover especiais */
    .hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }

    .hover-glow:hover {
      box-shadow: 0 0 30px rgba(var(--rgb-accent-primary), 0.4);
    }

    /* Scrollbar personalizada */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--accent-primary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-secondary);
    }

    /* Estilos do Dashboard */
    .macro-card {
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      border-radius: var(--radius-lg);
      padding: 0.75rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(15px);
      box-shadow: var(--shadow-soft);
    }

    .macro-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-glow);
      border-color: rgba(255, 255, 255, 0.3);
    }

    /* Ocultar por padr√£o */
    .tab-content.hidden {
      display: none !important;
    }

    /* Anima√ß√µes para containers de √°gua */
    #waterVisualization button {
      animation: fadeInUp 0.3s ease-out;
    }

    #waterVisualization button:hover {
      animation: pulse 0.6s infinite;
    }

    select option {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    /* Chips and tags */
    .chip {
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      border-radius: var(--radius-lg);
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .chip:hover {
      background: var(--bg-glass-hover);
      transform: translateY(-1px);
    }

    .tag {
      font-size: 0.625rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(34, 211, 238, 0.1));
      border: 1px solid rgba(6, 182, 212, 0.3);
      color: var(--accent-tertiary);
      font-weight: 500;
      backdrop-filter: blur(10px);
    }

    /* Navigation */
    nav {
      backdrop-filter: blur(20px) saturate(180%);
      background: rgba(17, 24, 39, 0.8);
      border-top: 1px solid var(--border-glass);
    }

    nav button {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    nav button.font-medium {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      box-shadow: var(--shadow-md);
    }

    /* Header */
    header {
      backdrop-filter: blur(20px) saturate(180%);
      background: rgba(17, 24, 39, 0.8);
      border-bottom: 1px solid var(--border-glass);
    }

    /* Donut chart */
    .donut-ring {
      stroke: rgba(255, 255, 255, 0.1);
    }

    .donut-segment {
      stroke: var(--accent-primary);
      transition: stroke-dashoffset 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      filter: drop-shadow(0 0 6px rgba(6, 182, 212, 0.3));
    }

    .donut-text {
      font-weight: 700;
      fill: var(--text-primary);
    }

    .donut-sub {
      fill: var(--text-muted);
      font-size: 10px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      animation: fadeIn 0.3s ease;
    }
    
    .modal-backdrop.hidden {
      display: none;
    }

    .modal {
      width: 100%;
      max-width: 26rem;
      animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Food search dropdown */
    .search-wrap {
      position: relative;
    }

    #foodList {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin-top: 0.5rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-glass);
      border-radius: var(--radius-lg);
      max-height: 14rem;
      overflow: auto;
      z-index: 60;
      box-shadow: var(--shadow-xl);
      backdrop-filter: blur(20px);
      pointer-events: auto;
      animation: dropDown 0.2s ease;
    }

    @keyframes dropDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Status indicators */
    .status-success {
      color: var(--success);
    }

    .status-warning {
      color: var(--warning);
    }

    .status-error {
      color: var(--error);
    }

    /* Hover effects for interactive elements */
    .hover-lift {
      transition: transform 0.2s ease;
    }

    .hover-lift:hover {
      transform: translateY(-2px);
    }

    /* Loading states */
    .loading {
      position: relative;
      overflow: hidden;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, var(--accent-secondary), var(--accent-primary));
    }

    /* Typography improvements */
    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
      letter-spacing: -0.025em;
    }

    .text-gradient {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Pulse animation for loading states */
    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    /* Auth Screen Styles */
    #authScreen input {
      background: rgba(15, 23, 42, 0.6);
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    #authScreen input:focus {
      background: rgba(15, 23, 42, 0.8);
      transform: translateY(-1px);
    }

    #authScreen input::placeholder {
      color: var(--text-muted);
    }

    #authScreen button[type="submit"] {
      position: relative;
      overflow: hidden;
    }

    #authScreen button[type="submit"]:active {
      transform: scale(0.98);
    }

    .text-gradient {
      background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 50%, #8b5cf6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #authScreen .glass {
      animation: slideInUp 0.6s ease-out;
    }
  </style>

  <!-- Gradientes SVG para os gr√°ficos -->
  <svg width="0" height="0" style="position: absolute;">
    <defs>
      <linearGradient id="gradientKcal" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#06b6d4;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
      </linearGradient>
    </defs>
  </svg>
</head>
<body class="min-h-screen">
  <div class="fixed inset-0 -z-10 bg-gradient-to-br from-sky-500/20 via-cyan-500/10 to-fuchsia-500/10"></div>

  <!-- Tela de Login/Cadastro -->
  <div id="authScreen" class="min-h-screen flex items-center justify-center px-4 hidden">
    <div class="w-full max-w-md">
      <div class="glass rounded-3xl p-8 shadow-2xl">
        <!-- Logo e T√≠tulo -->
        <div class="text-center mb-8">
          <div class="text-6xl mb-4">üçΩÔ∏è</div>
          <h1 class="text-3xl font-bold text-gradient mb-2">NutriX</h1>
          <p class="text-sm text-slate-400">Nutri√ß√£o Inteligente</p>
        </div>

        <!-- Tabs Login/Cadastro -->
        <div class="flex gap-2 mb-6">
          <button id="loginTabBtn" onclick="switchAuthTab('login')" class="flex-1 py-2.5 px-4 rounded-lg font-medium transition-all text-sm">
            Entrar
          </button>
          <button id="signupTabBtn" onclick="switchAuthTab('signup')" class="flex-1 py-2.5 px-4 rounded-lg font-medium transition-all text-sm">
            Cadastrar
          </button>
        </div>

        <!-- Formul√°rio de Login -->
        <form id="loginForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
              üìß Email ou Usu√°rio
            </label>
            <input 
              type="text" 
              id="loginUsername" 
              required
              class="w-full px-4 py-3 rounded-lg bg-slate-800/50 border border-slate-700 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all outline-none"
              placeholder="seu@email.com"
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
              üîí Senha
            </label>
            <input 
              type="password" 
              id="loginPassword" 
              required
              class="w-full px-4 py-3 rounded-lg bg-slate-800/50 border border-slate-700 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all outline-none"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>

          <div class="flex items-center">
            <input 
              type="checkbox" 
              id="rememberLogin" 
              class="w-4 h-4 rounded border-slate-700 bg-slate-800/50 text-cyan-500 focus:ring-2 focus:ring-cyan-500/20"
            />
            <label for="rememberLogin" class="ml-2 text-sm text-slate-300">
              Lembrar dados de login
            </label>
          </div>

          <button 
            type="submit" 
            class="w-full btn-gradient py-3 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all"
          >
            Entrar
          </button>
        </form>

        <!-- Formul√°rio de Cadastro -->
        <form id="signupForm" class="space-y-4 hidden">
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
              üë§ Nome Completo
            </label>
            <input 
              type="text" 
              id="signupName" 
              required
              class="w-full px-4 py-3 rounded-lg bg-slate-800/50 border border-slate-700 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all outline-none"
              placeholder="Jo√£o Silva"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
              üìß Email
            </label>
            <input 
              type="email" 
              id="signupEmail" 
              required
              class="w-full px-4 py-3 rounded-lg bg-slate-800/50 border border-slate-700 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all outline-none"
              placeholder="seu@email.com"
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
              üîí Senha
            </label>
            <input 
              type="password" 
              id="signupPassword" 
              required
              minlength="6"
              class="w-full px-4 py-3 rounded-lg bg-slate-800/50 border border-slate-700 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all outline-none"
              placeholder="M√≠nimo 6 caracteres"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
              üîí Confirmar Senha
            </label>
            <input 
              type="password" 
              id="signupPasswordConfirm" 
              required
              minlength="6"
              class="w-full px-4 py-3 rounded-lg bg-slate-800/50 border border-slate-700 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all outline-none"
              placeholder="Digite a senha novamente"
            />
          </div>

          <button 
            type="submit" 
            class="w-full btn-gradient py-3 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all"
          >
            Criar Conta
          </button>
        </form>

        <!-- Mensagens de erro/sucesso -->
        <div id="authMessage" class="mt-4 p-3 rounded-lg text-sm text-center hidden"></div>

        <!-- Link para demonstra√ß√£o -->
        <div class="mt-6 pt-6 border-t border-slate-700/50 text-center">
          <button 
            onclick="loginAsDemo()" 
            class="text-sm text-cyan-400 hover:text-cyan-300 transition-colors"
          >
            üéØ Entrar como Demo (sem cadastro)
          </button>
        </div>
      </div>
    </div>
  </div>

  <header class="sticky top-0 z-20 glass" id="mainHeader">
    <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <h1 class="text-lg font-semibold tracking-tight">
          <span class="text-gradient">üçΩÔ∏è NutriX</span>
        </h1>
        <div class="text-[10px] text-slate-400" id="userGreeting">
          <!-- Nome do usu√°rio ser√° inserido aqui -->
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="installBtn" class="text-xs px-3 py-1.5 rounded-lg chip hover-lift flex items-center gap-1">
          üì± Instalar App
        </button>
        <button onclick="console.log('üîò Bot√£o Configurar clicado'); if(typeof window.showTab === 'function') { window.showTab('config'); } else { console.error('‚ùå showTab n√£o est√° definido'); alert('Erro: fun√ß√£o showTab n√£o encontrada. Recarregue a p√°gina (F5)'); }" class="text-xs px-3 py-1.5 rounded-lg chip hover-lift flex items-center gap-1">
          ‚öôÔ∏è Config
        </button>
        <button onclick="logout()" class="text-xs px-3 py-1.5 rounded-lg chip hover-lift flex items-center gap-1" title="Sair">
          üö™
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-md mx-auto px-4 pb-28 pt-4">
    <!-- Dashboard Home -->
    <div id="homePage" class="tab-content">
      <!-- Stats gerais do dia -->
      <section class="mb-4">
        <div class="glass rounded-2xl p-4 hover-lift">
          <div class="flex items-center justify-between gap-3 mb-4">
            <div>
              <div class="text-xs text-slate-300 flex items-center gap-1">
                üìÖ Hoje
              </div>
              <div class="text-lg font-semibold" id="homeDate">30 de outubro, 2025</div>
            </div>
            <button onclick="toggleDashboardCustomize()" class="text-xs px-3 py-1.5 rounded-lg chip hover-lift flex items-center gap-1">
              üé® Personalizar
            </button>
          </div>
          
          <!-- Painel de Personaliza√ß√£o (oculto por padr√£o) -->
          <div id="customizePanel" class="hidden mb-4 p-3 rounded-xl bg-slate-800/50 border border-slate-700/50">
            <div class="text-sm font-semibold mb-3 text-slate-200">üé® Personalizar Dashboard</div>
            <div class="text-xs text-slate-400 mb-3">Selecione quais macronutrientes deseja visualizar:</div>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-slate-700/30">
                <input type="checkbox" id="showKcal" checked onchange="toggleMacroVisibility('kcal', this.checked)" class="w-4 h-4">
                <span class="text-xs">üî• Calorias</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-slate-700/30">
                <input type="checkbox" id="showProtein" checked onchange="toggleMacroVisibility('protein', this.checked)" class="w-4 h-4">
                <span class="text-xs">ü•© Prote√≠nas</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-slate-700/30">
                <input type="checkbox" id="showCarbs" checked onchange="toggleMacroVisibility('carbs', this.checked)" class="w-4 h-4">
                <span class="text-xs">üåæ Carboidratos</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-slate-700/30">
                <input type="checkbox" id="showFiber" checked onchange="toggleMacroVisibility('fiber', this.checked)" class="w-4 h-4">
                <span class="text-xs">ü•¨ Fibras</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer p-2 rounded-lg hover:bg-slate-700/30">
                <input type="checkbox" id="showFat" checked onchange="toggleMacroVisibility('fat', this.checked)" class="w-4 h-4">
                <span class="text-xs">ü•ë Gorduras</span>
              </label>
            </div>
            <button onclick="toggleDashboardCustomize()" class="mt-3 w-full text-xs px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors">
              Fechar
            </button>
          </div>
          
          <!-- Macronutrientes Grid -->
          <div class="grid grid-cols-2 gap-3 mb-4">
            <!-- Calorias -->
            <div id="macroCardKcal" class="macro-card hover-glow">
              <div class="text-xs text-slate-300 flex items-center gap-1 mb-1">
                üî• Calorias
              </div>
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-lg font-bold text-gradient">
                    <span id="homeTotalKcal">0</span>
                  </div>
                  <div class="text-[10px] text-slate-400">de <span id="homeGoalKcal">2000</span></div>
                </div>
                <div class="w-10 h-10 relative">
                  <svg class="w-10 h-10 transform -rotate-90" viewBox="0 0 36 36">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                          fill="none" stroke="rgba(255, 255, 255, 0.1)" stroke-width="2"/>
                    <path id="homeKcalProgress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                          fill="none" stroke="url(#gradientKcal)" stroke-width="2" stroke-dasharray="0, 100"/>
                    <text id="homeKcalPercent" x="18" y="21" class="text-[6px] font-bold" fill="currentColor" text-anchor="middle" transform="rotate(90 18 18)">0%</text>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Prote√≠nas -->
            <div id="macroCardProtein" class="macro-card hover-glow">
              <div class="text-xs text-slate-300 flex items-center gap-1 mb-1">
                ü•© Prote√≠nas
              </div>
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-lg font-bold text-emerald-400">
                    <span id="homeTotalProtein">0</span>g
                  </div>
                  <div class="text-[10px] text-slate-400">de <span id="homeGoalProtein">150</span>g</div>
                </div>
                <div class="w-10 h-10 relative">
                  <svg class="w-10 h-10 transform -rotate-90" viewBox="0 0 36 36">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                          fill="none" stroke="rgba(255, 255, 255, 0.1)" stroke-width="2"/>
                    <path id="homeProteinProgress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                          fill="none" stroke="#10b981" stroke-width="2" stroke-dasharray="0, 100"/>
                    <text id="homeProteinPercent" x="18" y="21" class="text-[6px] font-bold" fill="currentColor" text-anchor="middle" transform="rotate(90 18 18)">0%</text>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Carboidratos -->
            <div id="macroCardCarbs" class="macro-card hover-glow">
              <div class="text-xs text-slate-300 flex items-center gap-1 mb-1">
                üçû Carboidratos
              </div>
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-lg font-bold text-amber-400">
                    <span id="homeTotalCarbs">0</span>g
                  </div>
                  <div class="text-[10px] text-slate-400">de <span id="homeGoalCarbs">250</span>g</div>
                </div>
                <div class="w-10 h-10 relative">
                  <svg class="w-10 h-10 transform -rotate-90" viewBox="0 0 36 36">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                          fill="none" stroke="rgba(255, 255, 255, 0.1)" stroke-width="2"/>
                    <path id="homeCarbsProgress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                          fill="none" stroke="#f59e0b" stroke-width="2" stroke-dasharray="0, 100"/>
                    <text id="homeCarbsPercent" x="18" y="21" class="text-[6px] font-bold" fill="currentColor" text-anchor="middle" transform="rotate(90 18 18)">0%</text>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Fibras -->
            <div id="macroCardFiber" class="macro-card hover-glow">
              <div class="text-xs text-slate-300 flex items-center gap-1 mb-1">
                üåæ Fibras
              </div>
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-lg font-bold text-green-400">
                    <span id="homeTotalFiber">0</span>g
                  </div>
                  <div class="text-[10px] text-slate-400">de <span id="homeGoalFiber">25</span>g</div>
                </div>
                <div class="w-10 h-10 relative">
                  <svg class="w-10 h-10 transform -rotate-90" viewBox="0 0 36 36">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                          fill="none" stroke="rgba(255, 255, 255, 0.1)" stroke-width="2"/>
                    <path id="homeFiberProgress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                          fill="none" stroke="#22c55e" stroke-width="2" stroke-dasharray="0, 100"/>
                    <text id="homeFiberPercent" x="18" y="21" class="text-[6px] font-bold" fill="currentColor" text-anchor="middle" transform="rotate(90 18 18)">0%</text>
                  </svg>
                </div>
              </div>
            </div>

            <!-- Gorduras -->
            <div id="macroCardFat" class="macro-card hover-glow col-span-2">
              <div class="text-xs text-slate-300 flex items-center gap-1 mb-1">
                ü•ë Gorduras
              </div>
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-lg font-bold text-purple-400">
                    <span id="homeTotalFat">0</span>g
                  </div>
                  <div class="text-[10px] text-slate-400">de <span id="homeGoalFat">67</span>g</div>
                </div>
                <div class="w-10 h-10 relative">
                  <svg class="w-10 h-10 transform -rotate-90" viewBox="0 0 36 36">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                          fill="none" stroke="rgba(255, 255, 255, 0.1)" stroke-width="2"/>
                    <path id="homeFatProgress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                          fill="none" stroke="#a855f7" stroke-width="2" stroke-dasharray="0, 100"/>
                    <text id="homeFatPercent" x="18" y="21" class="text-[6px] font-bold" fill="currentColor" text-anchor="middle" transform="rotate(90 18 18)">0%</text>
                  </svg>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- P√°gina de Lan√ßamentos -->
    <div id="lancamentosPage" class="tab-content hidden">
    <!-- Data de sele√ß√£o -->
    <section class="mb-4">
      <div class="glass rounded-2xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-300 flex items-center gap-1">
              üìÖ Data para lan√ßamento
            </div>
            <input id="dateInput" type="date" class="mt-1 w-40 rounded-lg px-3 py-2 text-sm" />
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-300">Refei√ß√£o selecionada</div>
            <div class="text-sm font-medium" id="selectedMealDisplay">Caf√© da manh√£</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Lan√ßamento -->
    <section class="mb-4">
      <div class="glass rounded-2xl p-4">
        <h2 class="font-semibold mb-3">Novo lan√ßamento</h2>
        <div class="grid grid-cols-1 gap-3">
          <!-- WRAP relativo -->
          <div class="search-wrap">
            <label class="text-xs text-slate-300">Alimento</label>
            <input id="foodSearch" class="w-full rounded-lg px-3 py-2" placeholder="Buscar alimento..." autocomplete="off" />
            <div id="foodList" class="hidden"></div>
          </div>

          <div>
            <label class="text-xs text-slate-300">Refei√ß√£o</label>
            <select id="mealSelect" class="w-full rounded-lg px-3 py-2">
              <option value="cafe">Caf√© da manh√£</option>
              <option value="lanche_manha">Lanche da manh√£</option>
              <option value="almoco">Almo√ßo</option>
              <option value="lanche_tarde">Lanche da tarde</option>
              <option value="jantar">Jantar</option>
              <option value="ceia">Ceia</option>
            </select>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div class="col-span-2">
              <label class="text-xs text-slate-300">Quantidade</label>
              <input id="qtyInput" type="number" min="0.01" step="0.01" class="w-full rounded-lg px-3 py-2" placeholder="Ex.: 120" />
            </div>
            <div>
              <label class="text-xs text-slate-300">Unidade</label>
              <select id="unitSelect" class="w-full rounded-lg px-3 py-2">
                <option value="g">g</option>
                <option value="ml">ml</option>
                <option value="un">un</option>
              </select>
            </div>
          </div>

          <!-- UN tools -->
          <div id="unTools" class="hidden glass rounded-xl p-3">
            <div class="text-xs text-slate-300 mb-2">Este alimento n√£o tem ‚Äúgramas por unidade‚Äù. Informe para salvar:</div>
            <div class="grid gap-2 items-end" style="grid-template-columns: 1fr auto auto;">
              <div>
                <label class="text-xs text-slate-300">Gramas em 1 UN</label>
                <input id="inpGpu" type="number" step="0.1" class="w-full rounded-lg px-3 py-2 h-[42px]" placeholder="Ex.: 50" />
              </div>
              <button id="btnSaveGpu" class="btn-gradient">üíæ Salvar</button>
              <button id="btnClearGpu" class="btn btn-ghost">Limpar</button>
            </div>
            <div class="text-[10px] text-slate-400 mt-2">Fica salvo apenas para este alimento.</div>
          </div>

          <div class="text-sm text-slate-300" id="calcPreview">‚Äî</div>
          <button id="addBtn" class="w-full btn-gradient text-base font-semibold">
            ‚ú® Adicionar Alimento
          </button>
          <button id="saveMealBtn" class="w-full btn-secondary text-base mt-2 flex items-center justify-center gap-2">
            üíæ Salvar Refei√ß√£o
          </button>
        </div>
      </div>
    </section>

    <!-- Lista do dia -->
    <section>
      <div class="glass rounded-2xl p-2">
        <ul id="itemsList" class="divide-y divide-white/10"></ul>
      </div>
    </section>
  </main>

  <!-- Aba Refei√ß√µes -->
  <main id="refeicoes-tab" class="max-w-md mx-auto px-4 pb-28 pt-4 hidden">
    <section class="mb-4">
      <div class="glass rounded-2xl p-4">
        <h2 class="font-semibold mb-3">Refei√ß√µes do dia</h2>
        <div class="text-sm text-slate-300 mb-3">
          <span id="refeicoesDate">‚Äî</span>
        </div>
        <div id="refeicoesContainer">
          <div class="text-center text-slate-400 py-8">
            Nenhuma refei√ß√£o salva ainda
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- P√°gina de configura√ß√µes -->
  <main id="configPage" class="max-w-md mx-auto px-4 pb-28 pt-4 hidden">
      <section class="mb-4">
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-semibold flex items-center gap-2">
              ‚öôÔ∏è Configura√ß√µes
            </h2>
            <button onclick="showTab('home')" class="text-xs px-3 py-1.5 rounded-lg chip hover-lift">
              ‚Üê Voltar
            </button>
          </div>

          <!-- Informa√ß√µes da Conta -->
          <div class="mb-6 p-4 rounded-xl bg-gradient-to-r from-cyan-500/10 to-blue-500/10 border border-cyan-500/20">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-medium text-slate-200">üë§ Sua Conta</h3>
              <span class="text-xs px-2 py-1 rounded-full bg-cyan-500/20 text-cyan-300" id="userBadge">Usu√°rio</span>
            </div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-slate-400">Nome:</span>
                <span class="font-medium" id="profileName">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-400">Email:</span>
                <span class="font-medium" id="profileEmail">-</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-400">Membro desde:</span>
                <span class="font-medium" id="profileSince">-</span>
              </div>
            </div>
            <button onclick="logout()" class="w-full mt-4 btn bg-red-500/80 hover:bg-red-600 text-white text-sm">
              üö™ Sair da Conta
            </button>
          </div>
          
          <!-- Metas de Macronutrientes -->
          <div class="mb-6">
            <h3 class="text-sm font-medium mb-3 text-slate-300">Metas Di√°rias</h3>
            <div class="space-y-3">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="text-xs text-slate-400">üî• Calorias (kcal)</label>
                  <input id="configKcal" type="number" class="w-full rounded-lg px-3 py-2 text-sm mt-1" value="2000" />
                </div>
                <div>
                  <label class="text-xs text-slate-400">ü•© Prote√≠nas (g)</label>
                  <input id="configProtein" type="number" class="w-full rounded-lg px-3 py-2 text-sm mt-1" value="150" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="text-xs text-slate-400">üçû Carboidratos (g)</label>
                  <input id="configCarbs" type="number" class="w-full rounded-lg px-3 py-2 text-sm mt-1" value="250" />
                </div>
                <div>
                  <label class="text-xs text-slate-400">ü•ë Gorduras (g)</label>
                  <input id="configFat" type="number" class="w-full rounded-lg px-3 py-2 text-sm mt-1" value="67" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="text-xs text-slate-400">üåæ Fibras (g)</label>
                  <input id="configFiber" type="number" class="w-full rounded-lg px-3 py-2 text-sm mt-1" value="25" />
                </div>
              </div>
            </div>
          </div>

          <!-- Configura√ß√µes de Tipos de Refei√ß√µes -->
          <div class="mb-6">
            <h3 class="text-sm font-medium mb-3 text-slate-300">Tipos de Refei√ß√µes</h3>
            
            <div class="mb-3">
              <div class="flex gap-2">
                <input id="newMealType" type="text" class="flex-1 rounded-lg px-3 py-2 text-sm" placeholder="Ex: Lanche da Tarde" />
                <button onclick="addMealType()" class="px-4 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-white text-sm">
                  ‚ûï Adicionar
                </button>
              </div>
            </div>
            
            <div id="mealTypesList" class="space-y-2">
              <!-- Lista de tipos de refei√ß√µes ser√° gerada dinamicamente -->
            </div>
          </div>

          <!-- Trocar Senha -->
          <div class="mb-6">
            <h3 class="text-sm font-medium mb-3 text-slate-300">ÔøΩ Seguran√ßa</h3>
            
            <button onclick="openChangePasswordModal()" class="w-full btn bg-cyan-500 hover:bg-cyan-600 text-white">
              üîë Trocar Senha
            </button>
          </div>

          <!-- Limpeza de Dados -->
          <div class="mb-6">
            <h3 class="text-sm font-medium mb-3 text-slate-300">Limpeza de Dados</h3>
            <button onclick="clearAllData()" class="w-full btn bg-red-500 hover:bg-red-600 text-white">
              üóëÔ∏è Limpar Todos os Dados
            </button>
            <div class="text-xs text-slate-400 mt-2">
              Remove todos os lan√ßamentos, refei√ß√µes e configura√ß√µes. Use apenas se houver problemas.
            </div>
          </div>

          <button onclick="saveConfiguration()" class="btn-gradient w-full">
            üíæ Salvar Configura√ß√µes
          </button>
        </div>
      </section>
  </main>

  <!-- Aba Alimentos -->
  <main id="alimentos-tab" class="max-w-md mx-auto px-4 pb-28 pt-4 hidden">
    <section class="mb-4">
      <div class="glass rounded-2xl p-4">
        <!-- Cabe√ßalho com t√≠tulo e contador -->
        <div class="flex justify-between items-center mb-3">
          <div>
            <h2 class="font-semibold">Alimentos cadastrados</h2>
            <div class="text-xs text-slate-400 mt-1">
              <span id="alimentosCounter">0</span> alimentos dispon√≠veis
            </div>
          </div>
          <button id="btnNovoAlimento" class="btn btn-primary text-xs" onclick="window.abrirModalNovoAlimento && window.abrirModalNovoAlimento()">
            <span class="text-sm">‚ûï</span> Novo alimento
          </button>
        </div>
        
        <!-- Bot√µes de a√ß√£o -->
        <div class="flex gap-2 mb-3">
          <button id="btnExibirLista" class="btn btn-ghost flex-1 text-sm">
            üìã Exibir lista
          </button>
          <button id="btnOcultarLista" class="btn btn-ghost flex-1 text-sm hidden">
            üëÅÔ∏è Ocultar lista
          </button>
        </div>
        
        <!-- Container da lista (inicialmente oculto) -->
        <div id="alimentosListWrapper" class="hidden">
          <div class="mb-3">
            <input id="searchAlimentos" class="w-full rounded-lg px-3 py-2 text-sm" placeholder="üîç Buscar alimentos..." />
          </div>
          
          <div id="alimentosContainer" class="space-y-2 max-h-96 overflow-y-auto">
            <!-- Lista de alimentos ser√° preenchida dinamicamente -->
          </div>
          
          <div id="alimentoActions" class="hidden mt-4 flex gap-2">
            <button id="btnEditarAlimento" class="btn btn-ghost flex-1">Editar</button>
            <button id="btnExcluirAlimento" class="btn-secondary flex-1 text-red-400 hover:text-red-300 hover:bg-red-500/10">
              üóëÔ∏è Excluir
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Aba Relat√≥rios -->
  <main id="relatorios-tab" class="max-w-md mx-auto px-4 pb-28 pt-4 hidden">
    <section class="mb-4">
      <div class="glass rounded-2xl p-4">
        <h2 class="font-semibold mb-3">Relat√≥rios</h2>
        
        <!-- Sele√ß√£o do tipo de relat√≥rio -->
        <div class="mb-4">
          <label class="text-xs text-slate-300">Tipo de relat√≥rio</label>
          <div class="grid grid-cols-2 gap-2 mt-1">
            <button id="btnPorPeriodo" class="btn btn-primary text-sm">Por per√≠odo</button>
            <button id="btnPorDia" class="btn btn-ghost text-sm">Por dia</button>
          </div>
        </div>
        
        <!-- Campos de data -->
        <div id="camposPeriodo" class="grid grid-cols-2 gap-3 mb-4">
          <div>
            <label class="text-xs text-slate-300">Data inicial</label>
            <input id="dataInicial" type="date" class="w-full rounded-lg px-3 py-2 text-sm" />
          </div>
          <div>
            <label class="text-xs text-slate-300">Data final</label>
            <input id="dataFinal" type="date" class="w-full rounded-lg px-3 py-2 text-sm" />
          </div>
        </div>
        
        <div id="camposDia" class="hidden mb-4">
          <label class="text-xs text-slate-300">Data</label>
          <input id="dataEspecifica" type="date" class="w-full rounded-lg px-3 py-2 text-sm" />
        </div>
        
        <button id="btnGerarRelatorio" class="w-full btn btn-primary">Gerar relat√≥rio</button>
      </div>
    </section>
    
    <!-- Resultados do relat√≥rio -->
    <section id="resultadosRelatorio" class="hidden">
      <div class="glass rounded-2xl p-4">
        <div class="flex justify-between items-center mb-3">
          <h3 class="font-semibold">Resultados</h3>
          <span id="periodoRelatorio" class="text-xs text-slate-400"></span>
        </div>
        <div id="relatorioContainer">
          <!-- Conte√∫do ser√° preenchido dinamicamente -->
        </div>
      </div>
    </section>
  </main>

  <!-- Modal: variantes -->
  <div id="variantModal" class="modal-backdrop hidden">
    <div class="modal glass rounded-2xl p-4">
      <h3 id="vmTitle" class="text-lg font-semibold mb-2">Cadastrar variante</h3>
      <div class="text-xs text-slate-300 mb-3" id="vmDesc"></div>
      <div class="grid grid-cols-2 gap-3">
        <div class="col-span-2"><label class="text-xs text-slate-300">Nome</label><input id="vmName" class="w-full rounded-lg px-3 py-2" /></div>
        <div><label class="text-xs text-slate-300">Base (por 100)</label><input id="vmBase" class="w-full rounded-lg px-3 py-2" disabled /></div>
        <div><label class="text-xs text-slate-300">Kcal / 100</label><input id="vmKcal" type="number" step="0.1" class="w-full rounded-lg px-3 py-2" /></div>
        <div><label class="text-xs text-slate-300">Prote√≠na (g) / 100</label><input id="vmProt" type="number" step="0.01" class="w-full rounded-lg px-3 py-2" /></div>
        <div><label class="text-xs text-slate-300">Carbo (g) / 100</label><input id="vmCarb" type="number" step="0.01" class="w-full rounded-lg px-3 py-2" /></div>
        <div><label class="text-xs text-slate-300">Gordura (g) / 100</label><input id="vmFat" type="number" step="0.01" class="w-full rounded-lg px-3 py-2" /></div>
        <div><label class="text-xs text-slate-300">Fibra (g) / 100</label><input id="vmFib" type="number" step="0.01" class="w-full rounded-lg px-3 py-2" /></div>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="vmCancel" class="btn btn-ghost">Cancelar</button>
        <button id="vmSave" class="btn-gradient">üíæ Salvar Variante</button>
      </div>
    </div>
  </div>

  <!-- Modal: Cadastrar/Editar Alimento -->
  <div id="alimentoModal" class="modal-backdrop hidden">
    <div class="modal glass rounded-2xl p-4">
      <h3 id="amTitle" class="text-lg font-semibold mb-2">Cadastrar novo alimento</h3>
      <div class="grid grid-cols-1 gap-3">
        <div>
          <label class="text-xs text-slate-300">Nome do alimento</label>
          <input id="amName" class="w-full rounded-lg px-3 py-2" placeholder="Ex: Banana nanica" />
        </div>
        <div>
          <label class="text-xs text-slate-300">Unidade base</label>
          <select id="amUnitBase" class="w-full rounded-lg px-3 py-2">
            <option value="g">Gramas (g)</option>
            <option value="ml">Mililitros (ml)</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-300">Kcal / 100</label>
            <input id="amKcal" type="number" step="0.1" class="w-full rounded-lg px-3 py-2" placeholder="Ex: 89" />
          </div>
          <div>
            <label class="text-xs text-slate-300">Prote√≠na (g) / 100</label>
            <input id="amProt" type="number" step="0.01" class="w-full rounded-lg px-3 py-2" placeholder="Ex: 1.1" />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-slate-300">Carboidrato (g) / 100</label>
            <input id="amCarb" type="number" step="0.01" class="w-full rounded-lg px-3 py-2" placeholder="Ex: 23" />
          </div>
          <div>
            <label class="text-xs text-slate-300">Gordura (g) / 100</label>
            <input id="amFat" type="number" step="0.01" class="w-full rounded-lg px-3 py-2" placeholder="Ex: 0.3" />
          </div>
        </div>
        <div>
          <label class="text-xs text-slate-300">Fibra (g) / 100</label>
          <input id="amFiber" type="number" step="0.01" class="w-full rounded-lg px-3 py-2" placeholder="Ex: 2.6" />
        </div>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="amCancel" onclick="closeAlimentoModal()" class="btn btn-ghost">Cancelar</button>
        <button id="amSave" onclick="saveAlimento()" class="btn-gradient">üçé Salvar Alimento</button>
      </div>
    </div>
  </div>

  <!-- Modal de recipientes removida -->

  <nav class="fixed bottom-0 inset-x-0 glass">
    <div class="max-w-md mx-auto px-6 py-3 grid grid-cols-5 gap-1 text-center text-sm">
      <button id="tabHome" onclick="goHome()" class="nav-btn py-2 rounded-xl chip font-medium flex flex-col items-center gap-1">
        <span class="text-lg">üè†</span>
        <span class="text-xs">Home</span>
      </button>
      <button id="tabLancamentos" onclick="goLancamentos()" class="nav-btn py-2 rounded-xl chip opacity-80 flex flex-col items-center gap-1">
        <span class="text-lg">üçΩÔ∏è</span>
        <span class="text-xs">Lan√ßar</span>
      </button>
      <button id="tabRefeicoes" onclick="goRefeicoes()" class="nav-btn py-2 rounded-xl chip opacity-80 flex flex-col items-center gap-1">
        <span class="text-lg">ü•™</span>
        <span class="text-xs">Refei√ß√µes</span>
      </button>
      <button id="tabAlimentos" onclick="goAlimentos()" class="nav-btn py-2 rounded-xl chip opacity-80 flex flex-col items-center gap-1">
        <span class="text-lg">ü•ó</span>
        <span class="text-xs">Alimentos</span>
      </button>
      <button id="tabRelatorios" onclick="goRelatorios()" class="nav-btn py-2 rounded-xl chip opacity-80 flex flex-col items-center gap-1">
        <span class="text-lg">üìä</span>
        <span class="text-xs">Relat√≥rios</span>
      </button>
    </div>
  </nav>

  <script>
    /* EMERGENCY FIX - Corre√ß√µes cr√≠ticas */
    (function emergencyFix() {
      // Force UTF-8
      document.charset = 'UTF-8';
      
      // Override console para debug detalhado
      const originalLog = console.log;
      const originalError = console.error;
      const originalWarn = console.warn;
      
      console.log = function(...args) {
        originalLog('[NUTRIX]', new Date().toISOString(), ...args);
      };
      
      console.error = function(...args) {
        originalError('[NUTRIX ERROR]', new Date().toISOString(), ...args);
      };
      
      console.warn = function(...args) {
        originalWarn('[NUTRIX WARN]', new Date().toISOString(), ...args);
      };
      
      console.log('Emergency fix applied - UTF-8 forced, console enhanced');
    })();
    
    /* === VARI√ÅVEIS GLOBAIS (devem estar no topo) === */
    let state = {};
    let currentTab = 'home';
    let currentUser = null;
    let builtinFoods = []; // Inicializar vazio, ser√° preenchido logo abaixo
    
    /* Debug: Verificar Dexie */
    console.log('=== IN√çCIO DO SCRIPT ===');
    console.log('Dexie dispon√≠vel?', typeof Dexie !== 'undefined');
    console.log('window.NutriDB dispon√≠vel?', typeof window.NutriDB !== 'undefined');
    console.log('document.readyState:', document.readyState);
    
    /* Fun√ß√µes globais para modal (dispon√≠veis imediatamente para onclick) */
    window.abrirModalNovoAlimento = function() {
      console.log('üîµ window.abrirModalNovoAlimento chamado!');
      const modal = document.getElementById('newFoodModal');
      if (!modal) {
        console.error('‚ùå Modal n√£o encontrado!');
        alert('Erro: Modal n√£o encontrado. Recarregue a p√°gina.');
        return;
      }
      // Limpar campos
      ['nfName', 'nfKcal', 'nfProt', 'nfCarb', 'nfFat', 'nfFiber'].forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.value = '';
      });
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      console.log('‚úÖ Modal aberto via fun√ß√£o global');
      const nfName = document.getElementById('nfName');
      if (nfName) nfName.focus();
    };
    
    window.fecharModalNovoAlimento = function() {
      console.log('üîµ Fechando modal...');
      const modal = document.getElementById('newFoodModal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        console.log('‚úÖ Modal fechado');
      }
    };
    
    window.salvarNovoAlimento = function() {
      console.log('üîµ window.salvarNovoAlimento chamado!');
      
      const nfName = document.getElementById('nfName');
      const nfKcal = document.getElementById('nfKcal');
      const nfProt = document.getElementById('nfProt');
      const nfCarb = document.getElementById('nfCarb');
      const nfFat = document.getElementById('nfFat');
      const nfFiber = document.getElementById('nfFiber');
      
      const name = (nfName?.value || '').trim();
      const kcal = parseFloat(nfKcal?.value || '0') || 0;
      const prot = parseFloat(nfProt?.value || '0') || 0;
      const carb = parseFloat(nfCarb?.value || '0') || 0;
      const fat = parseFloat(nfFat?.value || '0') || 0;
      const fiber = parseFloat(nfFiber?.value || '0') || 0;
      
      console.log('üìù Dados coletados:', {name, kcal, prot, carb, fat, fiber});
      
      if (!name) {
        alert('‚ö†Ô∏è Informe o nome do alimento');
        if (nfName) nfName.focus();
        return;
      }
      
      // Gerar ID est√°vel (slug)
      const id = 'cf_' + name.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_|_$/g, '');
      
      // Criar alimento
      const newFood = {
        id,
        name,
        nameLower: name.toLowerCase(),
        unitBase: 'g',
        kcal100: kcal,
        prot100: prot,
        carb100: carb,
        fat100: fat,
        fiber100: fiber
      };
      
      console.log('üçΩÔ∏è Novo alimento criado:', newFood);
      
      // Usar state global se dispon√≠vel, sen√£o buscar do localStorage
      const LS_KEY = 'caloria-pwa-v5';
      let stateObj;
      
      if (typeof window.state !== 'undefined' && window.state) {
        stateObj = window.state;
        console.log('üì¶ Usando state global');
      } else {
        try {
          stateObj = JSON.parse(localStorage.getItem(LS_KEY)) || {};
          console.log('üì¶ Carregou state do localStorage');
        } catch {
          stateObj = {};
        }
      }
      
      // Adicionar ao state
      if (!Array.isArray(stateObj.customFoods)) {
        stateObj.customFoods = [];
      }
      
      // Verificar se j√° existe e substituir, ou adicionar novo
      const existingIndex = stateObj.customFoods.findIndex(f => f.id === id);
      if (existingIndex >= 0) {
        stateObj.customFoods[existingIndex] = newFood;
        console.log('‚ôªÔ∏è Alimento existente atualizado');
      } else {
        stateObj.customFoods.push(newFood);
        console.log('‚ûï Novo alimento adicionado ao array');
      }
      
      // Salvar no localStorage
      localStorage.setItem(LS_KEY, JSON.stringify(stateObj));
      console.log('üíæ Estado salvo no localStorage');
      
      // Atualizar state global se existir
      if (typeof window.state !== 'undefined' && window.state) {
        window.state.customFoods = stateObj.customFoods;
        console.log('üîÑ State global atualizado');
      }
      
      // Fechar modal
      window.fecharModalNovoAlimento();
      
      // Feedback visual
      alert('‚úÖ Alimento "' + name + '" salvo com sucesso!');
      
      // For√ßar atualiza√ß√£o do contador (usar setTimeout para garantir que DOM atualizou)
      setTimeout(() => {
        console.log('‚è∞ Atualizando contador ap√≥s salvar...');
        
        // Atualizar contador
        const counter = document.getElementById('alimentosCounter');
        if (counter && typeof window.state !== 'undefined') {
          const builtinCount = window.builtinFoods ? window.builtinFoods.length : 5;
          const customCount = window.state.customFoods ? window.state.customFoods.length : 0;
          const totalFoods = builtinCount + customCount;
          counter.textContent = totalFoods;
          console.log('‚úÖ Contador atualizado para:', totalFoods, '(builtin:', builtinCount, ', custom:', customCount, ')');
        }
        
        // Se fun√ß√£o updateAlimentosCounter existir, chamar tamb√©m
        if (typeof window.updateAlimentosCounter === 'function') {
          window.updateAlimentosCounter();
        }
        
        // Recarregar lista se estiver vis√≠vel
        const listWrapper = document.getElementById('alimentosListWrapper');
        if (listWrapper && !listWrapper.classList.contains('hidden')) {
          console.log('üìã Lista vis√≠vel, recarregando...');
          if (typeof window.loadAlimentosTab === 'function') {
            window.loadAlimentosTab();
          }
        } else {
          console.log('üìã Lista oculta, n√£o precisa recarregar');
        }
      }, 100);
      
      console.log('‚úÖ ALIMENTO SALVO COM SUCESSO!');
    };
    
    /* SW/PWA */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        console.log('üì¶ Registrando Service Worker...');
        
        // Detectar base path automaticamente
        const basePath = document.querySelector('base')?.href || window.location.pathname.replace(/\/[^/]*$/, '');
        const swPath = `${basePath}/sw.js`.replace(/\/\//g, '/');
        
        console.log('   Base path:', basePath);
        console.log('   SW path:', swPath);
        
        navigator.serviceWorker.register(swPath, { scope: basePath || '/' })
          .then(registration => {
            console.log('‚úÖ Service Worker registrado:', registration.scope);
            console.log('   Estado:', registration.active ? 'Ativo' : 'Aguardando');
            
            // For√ßar atualiza√ß√£o se houver novo SW
            if (registration.waiting) {
              console.log('üîÑ Nova vers√£o dispon√≠vel, atualizando...');
              registration.waiting.postMessage({ type: 'SKIP_WAITING' });
            }
          })
          .catch(error => {
            console.error('‚ùå Erro ao registrar Service Worker:', error);
          });
        
        // Diagn√≥stico ap√≥s carregar
        console.log('üîç DIAGN√ìSTICO P√ìS-LOAD:');
        console.log('  builtinFoods.length:', window.builtinFoods?.length);
        console.log('  Primeiros 3:', window.builtinFoods?.slice(0,3).map(f => f.name));
      });
    } else {
      console.warn('‚ö†Ô∏è Service Worker n√£o suportado neste navegador');
    }
    
    /* PWA Installation */
    window.deferredPrompt = null;
    
    // Fun√ß√£o de diagn√≥stico PWA
    window.diagnosticoPWA = function() {
      console.log('=== DIAGN√ìSTICO PWA ===');
      console.log('‚úì Service Worker suportado:', 'serviceWorker' in navigator);
      console.log('‚úì HTTPS ou localhost:', location.protocol === 'https:' || location.hostname === 'localhost');
      console.log('‚úì Manifest link:', !!document.querySelector('link[rel="manifest"]'));
      console.log('‚úì deferredPrompt dispon√≠vel:', !!window.deferredPrompt);
      console.log('‚úì Display mode:', window.matchMedia('(display-mode: standalone)').matches ? 'Instalado' : 'Navegador');
      console.log('‚úì User Agent:', navigator.userAgent);
      
      // Verificar Service Worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(regs => {
          console.log('‚úì Service Workers registrados:', regs.length);
          regs.forEach((reg, i) => {
            console.log(`  [${i}] Scope: ${reg.scope}, Estado: ${reg.active ? 'Ativo' : 'Inativo'}`);
          });
        });
      }
      
      // Verificar Manifest
      fetch('./manifest.webmanifest')
        .then(r => r.json())
        .then(manifest => {
          console.log('‚úì Manifest carregado:', manifest.name);
          console.log('  - Icons:', manifest.icons?.length || 0);
          console.log('  - Start URL:', manifest.start_url);
          console.log('  - Display:', manifest.display);
        })
        .catch(e => console.error('‚ùå Erro ao carregar manifest:', e));
      
      console.log('======================');
      console.log('üí° Use esta fun√ß√£o para diagnosticar problemas de instala√ß√£o');
    };
    const installBtn = document.getElementById('installBtn');
    
    // Verificar se app est√° instalada
    function isAppInstalled() {
      // Desktop/Android: display-mode standalone
      if (window.matchMedia('(display-mode: standalone)').matches) {
        return true;
      }
      // iOS Safari: navigator.standalone
      if (navigator.standalone === true) {
        return true;
      }
      return false;
    }
    
    // Atualizar estado do bot√£o de instala√ß√£o
    function atualizarEstadoInstalacao() {
      if (!installBtn) return;
      
      console.log('üîç Verificando estado de instala√ß√£o...');
      console.log('   isAppInstalled:', isAppInstalled());
      console.log('   deferredPrompt:', !!window.deferredPrompt);
      console.log('   location.protocol:', location.protocol);
      
      if (isAppInstalled()) {
        // App j√° instalada
        installBtn.textContent = '‚úì App Instalado';
        installBtn.disabled = true;
        installBtn.style.opacity = '0.6';
        installBtn.style.cursor = 'not-allowed';
        installBtn.style.display = 'flex';
        console.log('‚úÖ App j√° est√° instalado');
      } else if (window.deferredPrompt) {
        // Pode instalar
        installBtn.textContent = 'üì± Instalar App';
        installBtn.disabled = false;
        installBtn.style.opacity = '1';
        installBtn.style.cursor = 'pointer';
        installBtn.style.display = 'flex';
        console.log('‚úÖ Bot√£o de instala√ß√£o ativo');
      } else {
        // Prompt n√£o dispon√≠vel ainda - mostrar bot√£o mesmo assim
        installBtn.textContent = 'üì± Instalar App';
        installBtn.disabled = false;
        installBtn.style.opacity = '1';
        installBtn.style.cursor = 'pointer';
        installBtn.style.display = 'flex';
        installBtn.title = 'Instalar como aplicativo';
        console.log('‚ö†Ô∏è Prompt de instala√ß√£o n√£o dispon√≠vel ainda (aguardando)');
      }
    }
    
    // Capturar evento beforeinstallprompt
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('üéØ beforeinstallprompt disparado!');
      e.preventDefault();
      window.deferredPrompt = e;
      console.log('‚úÖ deferredPrompt armazenado');
      atualizarEstadoInstalacao();
    });
    
    // Log se o evento n√£o for disparado em 5 segundos
    setTimeout(() => {
      if (!window.deferredPrompt) {
        console.log('‚ö†Ô∏è beforeinstallprompt n√£o foi disparado ap√≥s 5 segundos');
        console.log('   Poss√≠veis motivos:');
        console.log('   - App j√° est√° instalado');
        console.log('   - Navegador n√£o suporta (Safari iOS)');
        console.log('   - Crit√©rios PWA n√£o atendidos');
        console.log('   - Manifest ou Service Worker com problema');
      }
    }, 5000);
    
    // Handler do bot√£o de instala√ß√£o
    if (installBtn) {
      installBtn.addEventListener('click', async () => {
        console.log('üì± Bot√£o Instalar clicado');
        console.log('   deferredPrompt dispon√≠vel?', !!window.deferredPrompt);
        console.log('   User Agent:', navigator.userAgent);
        
        try {
          // Verificar se √© iOS Safari (n√£o suporta beforeinstallprompt)
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
          const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
          
          if (isIOS || (isSafari && !window.deferredPrompt)) {
            // Instru√ß√µes especiais para iOS/Safari
            const msg = 'üì± Como instalar no iOS/Safari:\n\n' +
                       '1. Toque no bot√£o "Compartilhar" (‚ñ°‚Üë) na barra inferior\n' +
                       '2. Role para baixo e toque em "Adicionar √† Tela Inicial"\n' +
                       '3. Toque em "Adicionar" no canto superior direito\n\n' +
                       'O app aparecer√° na sua tela inicial! üéâ';
            alert(msg);
            return;
          }
          
          if (!window.deferredPrompt) {
            // Chrome/Edge/Firefox Android - verificar se j√° est√° instalado
            if (window.matchMedia('(display-mode: standalone)').matches) {
              alert('‚úÖ O app j√° est√° instalado!\n\nVoc√™ est√° usando a vers√£o instalada agora.');
              return;
            }
            
            // Instru√ß√µes para outros navegadores
            const userAgent = navigator.userAgent.toLowerCase();
            let msg = 'üì± Como instalar:\n\n';
            
            if (userAgent.includes('firefox')) {
              msg += 'ü¶ä Firefox:\n' +
                    '‚Ä¢ Toque no √≠cone de casa na barra de endere√ßo\n' +
                    '‚Ä¢ Ou v√° em Menu (‚ãÆ) ‚Üí "Instalar"\n\n';
            } else if (userAgent.includes('chrome') || userAgent.includes('edg')) {
              msg += 'üåê Chrome/Edge:\n' +
                    '‚Ä¢ Toque em Menu (‚ãÆ) no canto superior\n' +
                    '‚Ä¢ Selecione "Instalar app" ou "Adicionar √† tela inicial"\n\n';
            } else {
              msg += '‚Ä¢ Procure a op√ß√£o "Instalar" ou "Adicionar √† tela inicial" no menu do navegador\n\n';
            }
            
            msg += 'Aguarde alguns segundos ap√≥s carregar a p√°gina ou recarregue (F5).';
            alert(msg);
            return;
          }
          
          // Prompt dispon√≠vel - usar API nativa
          console.log('‚úÖ Mostrando prompt de instala√ß√£o...');
          await window.deferredPrompt.prompt();
          
          // Aguardar escolha do usu√°rio
          const { outcome } = await window.deferredPrompt.userChoice;
          console.log(`üìä Resultado da instala√ß√£o: ${outcome}`);
          
          if (outcome === 'accepted') {
            console.log('‚úÖ Usu√°rio aceitou instalar!');
          } else {
            console.log('‚ùå Usu√°rio recusou a instala√ß√£o');
          }
          
          // Limpar prompt usado
          window.deferredPrompt = null;
          atualizarEstadoInstalacao();
          
        } catch (e) {
          console.error('‚ùå Erro ao instalar PWA:', e);
          alert('‚ùå Erro ao instalar. Tente usar a op√ß√£o de instala√ß√£o do menu do navegador.');
        }
      });
    }
    
    // Detectar quando app √© instalada
    window.addEventListener('appinstalled', () => {
      console.log('PWA instalada com sucesso');
      window.deferredPrompt = null;
      atualizarEstadoInstalacao();
    });
    
    // Verificar estado inicial
    atualizarEstadoInstalacao();
    
    // Salvar estado ao fechar/recarregar p√°gina
    window.addEventListener('beforeunload', () => {
      console.log('üíæ Salvando estado antes de fechar...');
      saveState(window.state || state);
    });
    
    // Salvar estado periodicamente (a cada 30 segundos)
    setInterval(() => {
      if (window.state || state) {
        console.log('üíæ Auto-salvando estado...');
        saveState(window.state || state);
      }
    }, 30000);

    // FUN√á√ïES DE NAVEGA√á√ÉO SUPER SIMPLES
    // DEPRECATED: N√£o usar mais - usar showTab() em vez disso
    function hideAllPages() {
      console.warn('‚ö†Ô∏è hideAllPages() est√° deprecated - use showTab() em vez disso');
      // Mantido para compatibilidade, mas vazio
    }

    /* === HANDLERS DE NAVEGA√á√ÉO === */
    function onEnterHome() {
      // Sempre for√ßar o dia atual ao entrar na Home (sem sujeira de dias anteriores)
      state.selectedDate = getTodayStringLocal();
      updateHomeDashboard();
    }
    
    function onEnterLancamentos() {
      // Preencher data com hoje se estiver vazio
      const dateInput = el('dateInput');
      if (dateInput && !dateInput.value) {
        // Se for <input type="date"> usa YYYY-MM-DD, sen√£o usa DD/MM/YYYY
        if (dateInput.type === 'date') {
          dateInput.value = getTodayStringLocal('YYYY-MM-DD');
        } else {
          dateInput.value = getTodayStringLocal();
        }
      }
    }
    
    function goHome() {
      showTab('home');
    }

    function goLancamentos() {
      showTab('lancamentos');
    }

    function goRefeicoes() {
      console.log('üçΩÔ∏è goRefeicoes() chamado');
      showTab('refeicoes');
    }

    function goAlimentos() {
      console.log('üçé goAlimentos() chamado');
      console.log('üìä window.builtinFoods:', window.builtinFoods?.length);
      
      // FOR√áAR uso do window.builtinFoods
      if (!window.builtinFoods || window.builtinFoods.length === 0) {
        console.error('‚ùå window.builtinFoods n√£o est√° carregado!');
        alert('ERRO: Alimentos n√£o carregados! Recarregue a p√°gina (F5)');
        return;
      }
      
      console.log('‚úÖ Alimentos dispon√≠veis:', window.builtinFoods.length);
      
      showTab('alimentos');
      
      // Exibir lista automaticamente ap√≥s mostrar a tab
      setTimeout(() => {
        if (alimentosListWrapper) {
          alimentosListWrapper.classList.remove('hidden');
          if (btnExibirLista) btnExibirLista.classList.add('hidden');
          if (btnOcultarLista) btnOcultarLista.classList.remove('hidden');
        }
      }, 0);
    }

    function goRelatorios() {
      showTab('relatorios');
    }

    /* Helper function para buscar elementos com seguran√ßa */
    // Safe element getter com warning
    const el = (id) => {
      const elem = document.getElementById(id);
      if (!elem) console.warn(`‚ö†Ô∏è Elemento n√£o encontrado: ${id}`);
      return elem;
    };
    
    // Tornar el() dispon√≠vel globalmente
    window.el = el;
    
    /* Mapeamento de elementos do dashboard home (IDs corretos do HTML) */
    const elHome = {
      kcal:  { cur: el('homeTotalKcal'),  goal: el('homeGoalKcal'),  bar: el('homeKcalProgress') },
      prot:  { cur: el('homeTotalProtein'), goal: el('homeGoalProtein'), bar: el('homeProteinProgress') },
      carb:  { cur: el('homeTotalCarbs'), goal: el('homeGoalCarbs'), bar: el('homeCarbsProgress') },
      fat:   { cur: el('homeTotalFat'),   goal: el('homeGoalFat'),   bar: el('homeFatProgress') },
      fiber: { cur: el('homeTotalFiber'), goal: el('homeGoalFiber'), bar: el('homeFiberProgress') },
    };
    
    /* Refs */
    const dateInput=el('dateInput');
    const foodSearch=el('foodSearch');
    const foodList=el('foodList');
    const mealSelect=el('mealSelect');
    const qtyInput=el('qtyInput');

    // Estado global
    /* === CONFIGURA√á√ÉO DO SUPABASE === */
    const SUPABASE_URL = 'https://trdqrhazbnpshhtkyklv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRyZHFyaGF6Ym5wc2hodGt5a2x2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMjY0MTksImV4cCI6MjA3NzYwMjQxOX0.kvdyL003-nL4KbwVlWS5j7FKQk70eO_mqPQKb_3tiRE';
    
    let supabase = null;
    let isOnline = navigator.onLine;
    
    // Inicializar Supabase
    function initSupabase() {
      try {
        if (typeof window.supabase === 'undefined') {
          console.error('‚ùå Supabase library n√£o carregada');
          return false;
        }
        
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true
          }
        });
        console.log('‚úÖ Supabase inicializado com persist√™ncia de sess√£o');
        return true;
      } catch(e) {
        console.error('‚ùå Erro ao inicializar Supabase:', e);
        return false;
      }
    }
    
    // Monitorar status online/offline
    window.addEventListener('online', () => {
      isOnline = true;
      console.log('üåê Online - sincroniza√ß√£o habilitada');
      updateOnlineStatus();
      syncPendingData();
    });
    
    window.addEventListener('offline', () => {
      isOnline = false;
      console.log('üì¥ Offline - modo local');
      updateOnlineStatus();
    });
    
    function updateOnlineStatus() {
      const onlineIndicator = document.querySelector('.bg-green-400');
      const onlineText = onlineIndicator?.parentElement?.querySelector('span:last-child');
      
      if (isOnline) {
        onlineIndicator?.classList.remove('bg-red-400');
        onlineIndicator?.classList.add('bg-green-400');
        if (onlineText) onlineText.textContent = 'Online';
      } else {
        onlineIndicator?.classList.remove('bg-green-400');
        onlineIndicator?.classList.add('bg-red-400');
        if (onlineText) onlineText.textContent = 'Offline';
      }
    }

    /* === SISTEMA DE AUTENTICA√á√ÉO === */
    const USERS_KEY = 'nutrix-users';
    const CURRENT_USER_KEY = 'nutrix-current-user';
    
    // Inicializar sistema de autentica√ß√£o
    async function initAuth() {
      console.log('üîê Inicializando sistema de autentica√ß√£o...');
      
      // Tentar restaurar sess√£o do Supabase
      if (supabase) {
        try {
          const { data: { session }, error } = await supabase.auth.getSession();
          
          if (session && session.user) {
            console.log('‚úÖ Sess√£o Supabase restaurada:', session.user.email);
            
            currentUser = {
              id: session.user.id,
              name: session.user.user_metadata?.name || session.user.email.split('@')[0],
              email: session.user.email,
              createdAt: session.user.created_at,
              isDemo: false,
              supabaseId: session.user.id,
              session: session
            };
            
            localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
            
            showMainApp();
            updateUserGreeting();
            updateProfileInfo();
            await syncFromSupabase();
            return true;
          }
        } catch(e) {
          console.error('‚ùå Erro ao restaurar sess√£o:', e);
        }
      }
      
      // Verificar se h√° usu√°rio logado localmente (fallback)
      const savedUser = localStorage.getItem(CURRENT_USER_KEY);
      console.log('üîç Verificando usu√°rio local...', savedUser ? 'Encontrado' : 'N√£o encontrado');
      
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          console.log('üìã Usu√°rio local:', currentUser.email, '| isDemo:', currentUser.isDemo, '| supabaseId:', currentUser.supabaseId);
          
          // Se tem usu√°rio local mas sem sess√£o Supabase, tentar login autom√°tico
          if (currentUser.supabaseId && !currentUser.isDemo) {
            console.log('‚ö†Ô∏è Sess√£o Supabase expirada. Verificando login autom√°tico...');
            
            // Verificar se tem credenciais salvas para login autom√°tico
            const rememberLogin = localStorage.getItem('nutrix-remember-login');
            const savedEmail = localStorage.getItem('nutrix-saved-email');
            const savedPassword = localStorage.getItem('nutrix-saved-password');
            
            console.log('üîë Status credenciais:', {
              rememberLogin: rememberLogin,
              temEmail: !!savedEmail,
              temSenha: !!savedPassword
            });
            
            if (rememberLogin === 'true' && savedEmail && savedPassword) {
              console.log('üîÑ Fazendo login autom√°tico com credenciais salvas...');
              console.log('üìß Email salvo:', savedEmail);
              console.log('üîê Senha salva (encriptada):', savedPassword.substring(0, 10) + '...');
              
              try {
                const decodedPassword = atob(savedPassword);
                console.log('üîì Senha descriptografada (length):', decodedPassword.length, 'caracteres');
                
                const { data, error } = await supabase.auth.signInWithPassword({
                  email: savedEmail,
                  password: decodedPassword
                });
                
                if (error) {
                  console.error('‚ùå Erro no signInWithPassword:', error.message);
                  throw error;
                }
                
                if (data.user) {
                  console.log('‚úÖ Login autom√°tico realizado com sucesso!');
                  console.log('üë§ Usu√°rio logado:', data.user.email);
                  
                  currentUser = {
                    id: data.user.id,
                    name: data.user.user_metadata?.name || data.user.email.split('@')[0],
                    email: data.user.email,
                    createdAt: data.user.created_at,
                    isDemo: false,
                    supabaseId: data.user.id,
                    session: data.session
                  };
                  
                  localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
                  
                  showMainApp();
                  updateUserGreeting();
                  updateProfileInfo();
                  await syncFromSupabase();
                  return true;
                }
              } catch(autoLoginError) {
                console.error('‚ùå Erro no login autom√°tico:', autoLoginError);
                console.error('‚ùå Detalhes:', autoLoginError.message || autoLoginError);
                
                // Se falhar, limpar dados e pedir login manual
                localStorage.removeItem(CURRENT_USER_KEY);
                localStorage.removeItem('nutrix-remember-login');
                localStorage.removeItem('nutrix-saved-email');
                localStorage.removeItem('nutrix-saved-password');
                currentUser = null;
                showAuthScreen();
                showAuthMessage('‚ö†Ô∏è N√£o foi poss√≠vel fazer login autom√°tico. Fa√ßa login novamente.', 'warning');
                return false;
              }
            } else {
              // Sem credenciais salvas, pedir login
              console.log('‚ÑπÔ∏è Sem credenciais salvas (rememberLogin n√£o est√° true ou dados faltando)');
              console.log('üìù Pr√©-preenchendo campos com dados salvos...');
              
              // N√ÉO apagar o usu√°rio local ainda - deixar para quando usu√°rio fizer logout
              // Apenas mostrar tela de login com campos pr√©-preenchidos
              showAuthScreen();
              
              // Pr√©-preencher campos se tiver dados
              if (savedEmail) {
                document.getElementById('loginUsername').value = savedEmail;
              }
              if (savedPassword) {
                document.getElementById('loginPassword').value = atob(savedPassword);
              }
              if (rememberLogin === 'true') {
                document.getElementById('rememberLogin').checked = true;
              }
              
              showAuthMessage('‚ö†Ô∏è Sua sess√£o expirou. Fa√ßa login novamente.', 'warning');
              return false;
            }
          }
          
          console.log('‚úÖ Usu√°rio demo ou sem Supabase:', currentUser.email);
          showMainApp();
          updateUserGreeting();
          updateProfileInfo();
          return true;
        } catch(e) {
          console.error('‚ùå Erro ao carregar usu√°rio:', e);
          localStorage.removeItem(CURRENT_USER_KEY);
        }
      }
      
      // Nenhum usu√°rio logado
      console.log('‚ÑπÔ∏è Nenhum usu√°rio logado. Mostrando tela de login...');
      showAuthScreen();
      return false;
    }
    
    // Mostrar tela de autentica√ß√£o
    function showAuthScreen() {
      document.getElementById('authScreen').classList.remove('hidden');
      document.getElementById('mainHeader').classList.add('hidden');
      document.querySelectorAll('.tab-content, #configPage, #alimentos-tab, #lancamentos-tab, #refeicoes-tab, #relatorios-tab').forEach(el => {
        el.classList.add('hidden');
      });
      document.querySelector('nav')?.classList.add('hidden');
      
      // Mostrar tab de login por padr√£o
      switchAuthTab('login');
    }
    
    // Mostrar aplica√ß√£o principal
    function showMainApp() {
      document.getElementById('authScreen').classList.add('hidden');
      document.getElementById('mainHeader').classList.remove('hidden');
      document.querySelector('nav')?.classList.remove('hidden');
      
      // Mostrar home
      showTab('home');
    }
    
    // Alternar entre tabs de login/cadastro
    function switchAuthTab(tab) {
      const loginTab = document.getElementById('loginTabBtn');
      const signupTab = document.getElementById('signupTabBtn');
      const loginForm = document.getElementById('loginForm');
      const signupForm = document.getElementById('signupForm');
      const authMessage = document.getElementById('authMessage');
      
      // Limpar mensagens
      authMessage.classList.add('hidden');
      
      if (tab === 'login') {
        loginTab.classList.add('bg-cyan-500', 'text-white');
        loginTab.classList.remove('bg-slate-800/30', 'text-slate-300');
        signupTab.classList.add('bg-slate-800/30', 'text-slate-300');
        signupTab.classList.remove('bg-cyan-500', 'text-white');
        
        loginForm.classList.remove('hidden');
        signupForm.classList.add('hidden');
      } else {
        signupTab.classList.add('bg-cyan-500', 'text-white');
        signupTab.classList.remove('bg-slate-800/30', 'text-slate-300');
        loginTab.classList.add('bg-slate-800/30', 'text-slate-300');
        loginTab.classList.remove('bg-cyan-500', 'text-white');
        
        signupForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
      }
    }
    
    // Mostrar mensagem de auth
    function showAuthMessage(message, type = 'error') {
      const authMessage = document.getElementById('authMessage');
      authMessage.textContent = message;
      authMessage.className = `mt-4 p-3 rounded-lg text-sm text-center ${
        type === 'success' ? 'bg-green-500/20 text-green-300 border border-green-500/30' : 
        type === 'error' ? 'bg-red-500/20 text-red-300 border border-red-500/30' :
        'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30'
      }`;
      authMessage.classList.remove('hidden');
    }
    
    // Cadastrar novo usu√°rio
    async function signup(name, email, password, passwordConfirm) {
      console.log('üìù Tentando cadastrar:', email);
      
      // Valida√ß√µes
      if (!name || !email || !password) {
        showAuthMessage('‚ö†Ô∏è Preencha todos os campos', 'error');
        return false;
      }
      
      if (password.length < 6) {
        showAuthMessage('‚ö†Ô∏è A senha deve ter no m√≠nimo 6 caracteres', 'error');
        return false;
      }
      
      if (password !== passwordConfirm) {
        showAuthMessage('‚ö†Ô∏è As senhas n√£o coincidem', 'error');
        return false;
      }
      
      // Tentar cadastrar no Supabase se estiver online
      if (isOnline && supabase) {
        try {
          showAuthMessage('‚è≥ Criando conta...', 'info');
          
          const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
              data: {
                name: name
              }
            }
          });
          
          if (error) {
            console.error('‚ùå Erro Supabase:', error);
            // Continuar com m√©todo local se Supabase falhar
          } else {
            console.log('‚úÖ Usu√°rio criado no Supabase:', data);
            
            // Salvar localmente tamb√©m
            const newUser = {
              id: data.user.id,
              name: name,
              email: email,
              password: btoa(password),
              createdAt: data.user.created_at,
              isDemo: false,
              supabaseId: data.user.id
            };
            
            let users = [];
            try {
              const savedUsers = localStorage.getItem(USERS_KEY);
              if (savedUsers) users = JSON.parse(savedUsers);
            } catch(e) {}
            
            users.push(newUser);
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
            
            showAuthMessage('‚úÖ Conta criada com sucesso! Fa√ßa login.', 'success');
            
            setTimeout(() => {
              switchAuthTab('login');
              document.getElementById('loginUsername').value = email;
            }, 1500);
            
            return true;
          }
        } catch(e) {
          console.error('‚ùå Erro ao cadastrar no Supabase:', e);
          // Continuar com m√©todo local
        }
      }
      
      // M√©todo local (fallback ou offline)
      let users = [];
      try {
        const savedUsers = localStorage.getItem(USERS_KEY);
        if (savedUsers) {
          users = JSON.parse(savedUsers);
        }
      } catch(e) {
        console.error('‚ùå Erro ao carregar usu√°rios:', e);
      }
      
      // Verificar se email j√° existe
      if (users.some(u => u.email.toLowerCase() === email.toLowerCase())) {
        showAuthMessage('‚ö†Ô∏è Este email j√° est√° cadastrado', 'error');
        return false;
      }
      
      // Criar novo usu√°rio
      const newUser = {
        id: 'user_' + Date.now(),
        name: name,
        email: email,
        password: btoa(password),
        createdAt: new Date().toISOString(),
        isDemo: false
      };
      
      users.push(newUser);
      
      try {
        localStorage.setItem(USERS_KEY, JSON.stringify(users));
        console.log('‚úÖ Usu√°rio cadastrado localmente');
        
        showAuthMessage('‚úÖ Conta criada com sucesso! Fa√ßa login.', 'success');
        
        setTimeout(() => {
          switchAuthTab('login');
          document.getElementById('loginUsername').value = email;
        }, 1500);
        
        return true;
      } catch(e) {
        console.error('‚ùå Erro ao salvar usu√°rio:', e);
        showAuthMessage('‚ùå Erro ao criar conta. Tente novamente.', 'error');
        return false;
      }
    }
    
    // Login
    async function login(username, password) {
      console.log('üîë Tentando login:', username);
      
      if (!username || !password) {
        showAuthMessage('‚ö†Ô∏è Preencha email e senha', 'error');
        return false;
      }
      
      // Tentar login no Supabase se estiver online
      if (isOnline && supabase) {
        try {
          showAuthMessage('‚è≥ Entrando...', 'info');
          
          const { data, error } = await supabase.auth.signInWithPassword({
            email: username,
            password: password
          });
          
          if (error) {
            console.error('‚ùå Erro no login:', error.message);
            
            // Se o erro for "email not confirmed", mostrar mensagem espec√≠fica
            if (error.message && error.message.includes('Email not confirmed')) {
              showAuthMessage('‚ö†Ô∏è Email n√£o confirmado. Verifique sua caixa de entrada ou contate o suporte.', 'warning');
              return false;
            }
            
            // Continuar com m√©todo local se Supabase falhar
          } else {
            console.log('‚úÖ Login realizado com sucesso');
            
            currentUser = {
              id: data.user.id,
              name: data.user.user_metadata?.name || username.split('@')[0],
              email: data.user.email,
              createdAt: data.user.created_at,
              isDemo: false,
              supabaseId: data.user.id,
              session: data.session
            };
            
            localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
            
            // Salvar credenciais se "lembrar login" estiver marcado (AP√ìS login bem-sucedido)
            const rememberCheckbox = document.getElementById('rememberLogin');
            console.log('üîç Estado do checkbox "Lembrar dados":', {
              existe: !!rememberCheckbox,
              marcado: rememberCheckbox ? rememberCheckbox.checked : 'N/A'
            });
            
            if (rememberCheckbox && rememberCheckbox.checked) {
              console.log('üíæ Salvando credenciais para login autom√°tico...');
              localStorage.setItem('nutrix-remember-login', 'true');
              localStorage.setItem('nutrix-saved-email', username);
              localStorage.setItem('nutrix-saved-password', btoa(password));
              
              // Confirmar salvamento
              console.log('‚úÖ Credenciais salvas:', {
                rememberLogin: localStorage.getItem('nutrix-remember-login'),
                email: localStorage.getItem('nutrix-saved-email'),
                senhaSalva: !!localStorage.getItem('nutrix-saved-password')
              });
            } else {
              console.log('üîì Checkbox desmarcado ou n√£o encontrado. Removendo credenciais...');
              localStorage.removeItem('nutrix-remember-login');
              localStorage.removeItem('nutrix-saved-email');
              localStorage.removeItem('nutrix-saved-password');
            }
            
            showAuthMessage('‚úÖ Login bem-sucedido!', 'success');
            
            setTimeout(async () => {
              showMainApp();
              updateUserGreeting();
              updateProfileInfo();
              await syncFromSupabase(); // Sincronizar dados do servidor
              loadUserData();
            }, 800);
            
            return true;
          }
        } catch(e) {
          console.error('‚ùå Erro ao fazer login no Supabase:', e);
          // Continuar com m√©todo local
        }
      }
      
      // M√©todo local (fallback ou offline)
      let users = [];
      try {
        const savedUsers = localStorage.getItem(USERS_KEY);
        if (savedUsers) {
          users = JSON.parse(savedUsers);
        }
      } catch(e) {
        console.error('‚ùå Erro ao carregar usu√°rios:', e);
      }
      
      // Buscar usu√°rio
      const user = users.find(u => 
        u.email.toLowerCase() === username.toLowerCase() &&
        atob(u.password) === password
      );
      
      if (!user) {
        showAuthMessage('‚ùå Email ou senha incorretos', 'error');
        return false;
      }
      
      // Login bem-sucedido
      currentUser = {
        id: user.id,
        name: user.name,
        email: user.email,
        createdAt: user.createdAt,
        isDemo: user.isDemo || false
      };
      
      localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
      console.log('‚úÖ Login local bem-sucedido');
      
      showAuthMessage('‚úÖ Login bem-sucedido!', 'success');
      
      setTimeout(() => {
        showMainApp();
        updateUserGreeting();
        updateProfileInfo();
        loadUserData();
      }, 800);
      
      return true;
    }
    
    // Login como demo
    function loginAsDemo() {
      console.log('üéØ Login como demonstra√ß√£o');
      
      currentUser = {
        id: 'demo_user',
        name: 'Usu√°rio Demo',
        email: 'demo@nutrix.app',
        createdAt: new Date().toISOString(),
        isDemo: true
      };
      
      localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
      
      showAuthMessage('‚úÖ Entrando como demonstra√ß√£o...', 'success');
      
      setTimeout(() => {
        showMainApp();
        updateUserGreeting();
        updateProfileInfo();
        loadUserData();
      }, 800);
    }
    
    // Logout
    async function logout() {
      if (!confirm('Tem certeza que deseja sair?')) {
        return;
      }
      
      console.log('üö™ Fazendo logout...');
      
      // Salvar e sincronizar dados antes de sair
      if (currentUser && !currentUser.isDemo) {
        await saveUserData();
        
        // Fazer logout do Supabase
        if (supabase && currentUser.supabaseId) {
          try {
            await supabase.auth.signOut();
            console.log('‚úÖ Logout Supabase conclu√≠do');
          } catch(e) {
            console.error('‚ùå Erro ao fazer logout do Supabase:', e);
          }
        }
      }
      
      // Limpar usu√°rio atual
      localStorage.removeItem(CURRENT_USER_KEY);
      currentUser = null;
      
      // Resetar estado para vazio
      state = {
        entries: {},
        goal: 2000,
        customFoods: [],
        overrides: {},
        savedMeals: {},
        goals: {}
      };
      
      showAuthScreen();
    }
    
    // Abrir modal de trocar senha
    function openChangePasswordModal() {
      console.log('üîê Abrindo modal de trocar senha...');
      const modal = document.getElementById('changePasswordModal');
      if (!modal) {
        console.error('‚ùå Modal changePasswordModal n√£o encontrado!');
        return;
      }
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      
      // Limpar formul√°rio
      const form = document.getElementById('changePasswordForm');
      if (form) {
        form.reset();
        console.log('‚úÖ Formul√°rio limpo');
      }
      
      const messageEl = document.getElementById('changePasswordMessage');
      if (messageEl) {
        messageEl.classList.add('hidden');
      }
      
      console.log('‚úÖ Modal aberto com sucesso');
    }
    
    // Fechar modal de trocar senha
    function closeChangePasswordModal() {
      const modal = document.getElementById('changePasswordModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    // Trocar senha
    async function changePassword(currentPass, newPass, confirmPass) {
      const messageEl = document.getElementById('changePasswordMessage');
      
      // Valida√ß√µes
      if (!currentPass || !newPass || !confirmPass) {
        messageEl.textContent = '‚ö†Ô∏è Preencha todos os campos';
        messageEl.className = 'p-3 rounded-lg text-sm text-center bg-yellow-500/20 text-yellow-300 border border-yellow-500/30';
        messageEl.classList.remove('hidden');
        return false;
      }
      
      if (newPass.length < 6) {
        messageEl.textContent = '‚ö†Ô∏è A nova senha deve ter no m√≠nimo 6 caracteres';
        messageEl.className = 'p-3 rounded-lg text-sm text-center bg-yellow-500/20 text-yellow-300 border border-yellow-500/30';
        messageEl.classList.remove('hidden');
        return false;
      }
      
      if (newPass !== confirmPass) {
        messageEl.textContent = '‚ö†Ô∏è As senhas n√£o coincidem';
        messageEl.className = 'p-3 rounded-lg text-sm text-center bg-yellow-500/20 text-yellow-300 border border-yellow-500/30';
        messageEl.classList.remove('hidden');
        return false;
      }
      
      if (!currentUser) {
        messageEl.textContent = '‚ùå Usu√°rio n√£o autenticado';
        messageEl.className = 'p-3 rounded-lg text-sm text-center bg-red-500/20 text-red-300 border border-red-500/30';
        messageEl.classList.remove('hidden');
        return false;
      }
      
      try {
        // Se usu√°rio tem conta Supabase, trocar senha l√°
        if (currentUser.supabaseId && supabase) {
          console.log('üîê Tentando atualizar senha no Supabase...');
          const { data, error } = await supabase.auth.updateUser({
            password: newPass
          });
          
          if (error) {
            console.error('‚ùå Erro Supabase:', error);
            throw new Error('Erro no Supabase: ' + error.message);
          }
          
          console.log('‚úÖ Senha atualizada no Supabase:', data);
        } else {
          console.log('‚ÑπÔ∏è Usu√°rio n√£o tem conta Supabase, apenas local');
        }
        
        // Atualizar senha local
        const users = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
        const userIndex = users.findIndex(u => u.id === currentUser.id);
        
        if (userIndex !== -1) {
          console.log('üîç Verificando senha atual...');
          console.log('   Senha armazenada (decodificada):', atob(users[userIndex].password));
          console.log('   Senha digitada:', currentPass);
          
          // Verificar senha atual
          if (atob(users[userIndex].password) !== currentPass) {
            messageEl.textContent = '‚ùå Senha atual incorreta';
            messageEl.className = 'p-3 rounded-lg text-sm text-center bg-red-500/20 text-red-300 border border-red-500/30';
            messageEl.classList.remove('hidden');
            return false;
          }
          
          // Atualizar senha
          console.log('‚úÖ Senha atual correta! Atualizando...');
          users[userIndex].password = btoa(newPass);
          localStorage.setItem(USERS_KEY, JSON.stringify(users));
          
          console.log('‚úÖ Senha atualizada localmente');
          console.log('   Nova senha (codificada):', users[userIndex].password);
        } else {
          console.error('‚ùå Usu√°rio n√£o encontrado no array local!');
        }
        
        messageEl.textContent = '‚úÖ Senha alterada com sucesso!';
        messageEl.className = 'p-3 rounded-lg text-sm text-center bg-green-500/20 text-green-300 border border-green-500/30';
        messageEl.classList.remove('hidden');
        
        // Limpar dados salvos de login
        localStorage.removeItem('nutrix-remember-login');
        localStorage.removeItem('nutrix-saved-email');
        localStorage.removeItem('nutrix-saved-password');
        
        setTimeout(() => {
          closeChangePasswordModal();
        }, 2000);
        
        return true;
        
      } catch(e) {
        console.error('‚ùå Erro ao trocar senha:', e);
        messageEl.textContent = '‚ùå Erro ao trocar senha: ' + e.message;
        messageEl.className = 'p-3 rounded-lg text-sm text-center bg-red-500/20 text-red-300 border border-red-500/30';
        messageEl.classList.remove('hidden');
        return false;
      }
    }
    
    // Atualizar sauda√ß√£o do usu√°rio
    function updateUserGreeting() {
      const greetingEl = document.getElementById('userGreeting');
      if (greetingEl && currentUser) {
        const firstName = currentUser.name.split(' ')[0];
        greetingEl.textContent = `Ol√°, ${firstName}!`;
      }
    }
    
    // Atualizar informa√ß√µes do perfil
    function updateProfileInfo() {
      if (!currentUser) return;
      
      document.getElementById('profileName').textContent = currentUser.name;
      document.getElementById('profileEmail').textContent = currentUser.email;
      
      const badge = document.getElementById('userBadge');
      if (currentUser.isDemo) {
        badge.textContent = 'üéØ Demo';
        badge.className = 'text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-300';
      } else {
        badge.textContent = '‚úÖ Ativo';
        badge.className = 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-300';
      }
      
      const since = new Date(currentUser.createdAt);
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('profileSince').textContent = since.toLocaleDateString('pt-BR', options);
    }
    
    // Carregar dados do usu√°rio
    function loadUserData() {
      if (!currentUser) return;
      
      const userDataKey = `nutrix-data-${currentUser.id}`;
      try {
        const savedData = localStorage.getItem(userDataKey);
        if (savedData) {
          const userData = JSON.parse(savedData);
          state = userData;
          window.state = state;
          console.log('üìÇ Dados do usu√°rio carregados:', currentUser.email);
        } else {
          console.log('‚ÑπÔ∏è Nenhum dado encontrado para este usu√°rio');
        }
      } catch(e) {
        console.error('‚ùå Erro ao carregar dados do usu√°rio:', e);
      }
      
      // Atualizar UI
      updateHomeDashboard();
    }
    
    // Salvar dados do usu√°rio
    async function saveUserData() {
      if (!currentUser) return;
      
      const userDataKey = `nutrix-data-${currentUser.id}`;
      try {
        localStorage.setItem(userDataKey, JSON.stringify(state));
        console.log('üíæ Dados do usu√°rio salvos localmente:', currentUser.email);
        
        // Sincronizar com Supabase se estiver online
        if (isOnline && supabase && !currentUser.isDemo) {
          await syncToSupabase();
        }
      } catch(e) {
        console.error('‚ùå Erro ao salvar dados do usu√°rio:', e);
      }
    }
    
    // Sincronizar dados PARA o Supabase
    async function syncToSupabase() {
      if (!currentUser || currentUser.isDemo || !supabase) {
        console.log('‚ö†Ô∏è Sync para servidor cancelado:', !currentUser ? 'Sem usu√°rio' : currentUser.isDemo ? 'Modo demo' : 'Sem Supabase');
        return;
      }
      
      if (!isOnline) {
        console.log('üì¥ Offline - sync adiado');
        return;
      }
      
      try {
        const dataToSync = {
          user_id: currentUser.supabaseId || currentUser.id,
          email: currentUser.email,
          data: state,
          updated_at: new Date().toISOString()
        };
        
        // Salvar dados do usu√°rio
        const { data: result, error: userError } = await supabase
          .from('user_data')
          .upsert(dataToSync, {
            onConflict: 'user_id'
          })
          .select();
        
        if (userError) {
          console.error('‚ùå Erro ao sincronizar com Supabase:', userError.message);
        } else {
          console.log('‚úÖ Dados sincronizados com sucesso');
          
          // Atualizar timestamp local
          localStorage.setItem(`nutrix-last-update-${currentUser.id}`, dataToSync.updated_at);
        }
        
        // Sincronizar alimentos customizados
        if (state.customFoods && state.customFoods.length > 0) {
          await syncCustomFoods();
        }
        
      } catch(e) {
        console.error('‚ùå Exce√ß√£o ao sincronizar:', e);
        console.error('   Stack:', e.stack);
      }
    }
    
    // Sincronizar alimentos customizados
    async function syncCustomFoods() {
      if (!currentUser || !supabase || !state.customFoods) return;
      
      try {
        console.log('üçé Sincronizando alimentos customizados...');
        
        for (const food of state.customFoods) {
          const { error } = await supabase
            .from('custom_foods')
            .upsert({
              id: food.id,
              user_id: currentUser.supabaseId || currentUser.id,
              name: food.name,
              unit_base: food.unitBase,
              kcal_100: food.kcal100,
              prot_100: food.prot100,
              carb_100: food.carb100,
              fat_100: food.fat100,
              fiber_100: food.fiber100,
              category: food.category || 'Personalizado',
              created_at: food.createdAt || new Date().toISOString()
            }, {
              onConflict: 'id'
            });
          
          if (error) {
            console.error('‚ùå Erro ao sincronizar alimento:', food.name, error);
          }
        }
        
        console.log('‚úÖ Alimentos customizados sincronizados');
      } catch(e) {
        console.error('‚ùå Erro ao sincronizar alimentos:', e);
      }
    }
    
    // Sincronizar dados DO Supabase
    async function syncFromSupabase() {
      if (!currentUser || currentUser.isDemo || !supabase) {
        console.log('‚ö†Ô∏è Sync cancelado:', !currentUser ? 'Sem usu√°rio' : currentUser.isDemo ? 'Modo demo' : 'Sem Supabase');
        return;
      }
      
      try {
        console.log('üì• Sincronizando dados do Supabase...');
        console.log('   User ID:', currentUser.supabaseId || currentUser.id);
        console.log('   Email:', currentUser.email);
        
        // Buscar dados do usu√°rio
        const { data: userData, error: userError } = await supabase
          .from('user_data')
          .select('*')
          .eq('user_id', currentUser.supabaseId || currentUser.id)
          .single();
        
        console.log('üìä Resposta do servidor:', { userData, userError });
        
        if (userError) {
          if (userError.code === 'PGRST116') {
            console.log('‚ÑπÔ∏è Primeira vez - nenhum dado no servidor ainda');
            console.log('üíæ Usando dados locais iniciais');
          } else {
            console.error('‚ùå Erro ao buscar dados:', userError);
            console.log('üíæ Usando dados locais como fallback');
          }
          
          // Carregar dados locais
          loadUserData();
          
        } else if (userData && userData.data) {
          console.log('‚úÖ Dados encontrados no servidor!');
          console.log('   Entries:', Object.keys(userData.data.entries || {}).length, 'dias');
          console.log('   Meals:', Object.keys(userData.data.savedMeals || {}).length, 'dias');
          console.log('   Updated at:', userData.updated_at);
          
          // Sempre usar dados do servidor (√∫ltima fonte da verdade)
          state = userData.data;
          
          // Garantir estrutura m√≠nima
          if (!state.entries) state.entries = {};
          if (!state.goal) state.goal = 2000;
          if (!state.customFoods) state.customFoods = [];
          if (!state.overrides) state.overrides = {};
          if (!state.savedMeals) state.savedMeals = {};
          if (!state.goals) state.goals = {};
          if (!state.selectedDate) state.selectedDate = getTodayStringLocal();
          
          window.state = state;
          
          // Salvar localmente
          localStorage.setItem(`nutrix-data-${currentUser.id}`, JSON.stringify(state));
          localStorage.setItem(`nutrix-last-update-${currentUser.id}`, userData.updated_at);
          
          console.log('üíæ Dados do servidor salvos localmente');
        } else {
          console.log('‚ö†Ô∏è Resposta inesperada do servidor');
          loadUserData();
        }
        
        // Buscar alimentos customizados
        const { data: customFoods, error: foodsError } = await supabase
          .from('custom_foods')
          .select('*')
          .eq('user_id', currentUser.supabaseId || currentUser.id);
        
        if (foodsError) {
          console.error('‚ùå Erro ao buscar alimentos customizados:', foodsError);
        } else if (customFoods && customFoods.length > 0) {
          console.log(`‚úÖ ${customFoods.length} alimentos customizados encontrados`);
          
          // Converter formato do banco para formato do app
          state.customFoods = customFoods.map(f => ({
            id: f.id,
            name: f.name,
            unitBase: f.unit_base,
            kcal100: f.kcal_100,
            prot100: f.prot_100,
            carb100: f.carb_100,
            fat100: f.fat_100,
            fiber100: f.fiber_100,
            category: f.category,
            createdAt: f.created_at
          }));
          
          window.state = state;
        }
        
      } catch(e) {
        console.error('‚ùå Erro ao sincronizar do Supabase:', e);
      }
    }
    
    // Sincronizar dados pendentes quando voltar online
    async function syncPendingData() {
      if (!isOnline || !currentUser || currentUser.isDemo) return;
      
      console.log('üîÑ Sincronizando dados pendentes...');
      
      await syncToSupabase();
      await syncFromSupabase();
      
      console.log('‚úÖ Sincroniza√ß√£o completa');
    }

    /* === SISTEMA DE PERSIST√äNCIA DUAL (LocalStorage + IndexedDB) === */
    const LS_KEY='caloria-pwa-v5';
    const DB_NAME = 'NutriXDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'appState';
    
    let db = null;
    
    // Inicializar IndexedDB
    function initDB() {
      return new Promise((resolve, reject) => {
        console.log('üóÑÔ∏è Inicializando IndexedDB...');
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => {
          console.error('‚ùå Erro ao abrir IndexedDB:', request.error);
          reject(request.error);
        };
        
        request.onsuccess = () => {
          db = request.result;
          console.log('‚úÖ IndexedDB inicializado');
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          console.log('üîß Criando/atualizando estrutura do IndexedDB...');
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME);
            console.log('‚úÖ Object Store criado:', STORE_NAME);
          }
        };
      });
    }
    
    // Salvar no IndexedDB
    function saveToIndexedDB(key, data) {
      return new Promise((resolve, reject) => {
        if (!db) {
          console.warn('‚ö†Ô∏è IndexedDB n√£o inicializado');
          resolve(false);
          return;
        }
        
        try {
          const transaction = db.transaction([STORE_NAME], 'readwrite');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.put(data, key);
          
          request.onsuccess = () => {
            console.log('‚úÖ Dados salvos no IndexedDB');
            resolve(true);
          };
          
          request.onerror = () => {
            console.error('‚ùå Erro ao salvar no IndexedDB:', request.error);
            resolve(false);
          };
        } catch(e) {
          console.error('‚ùå Erro ao acessar IndexedDB:', e);
          resolve(false);
        }
      });
    }
    
    // Carregar do IndexedDB
    function loadFromIndexedDB(key) {
      return new Promise((resolve, reject) => {
        if (!db) {
          console.warn('‚ö†Ô∏è IndexedDB n√£o inicializado');
          resolve(null);
          return;
        }
        
        try {
          const transaction = db.transaction([STORE_NAME], 'readonly');
          const store = transaction.objectStore(STORE_NAME);
          const request = store.get(key);
          
          request.onsuccess = () => {
            if (request.result) {
              console.log('‚úÖ Dados carregados do IndexedDB');
              resolve(request.result);
            } else {
              console.log('‚ÑπÔ∏è Nenhum dado encontrado no IndexedDB');
              resolve(null);
            }
          };
          
          request.onerror = () => {
            console.error('‚ùå Erro ao carregar do IndexedDB:', request.error);
            resolve(null);
          };
        } catch(e) {
          console.error('‚ùå Erro ao acessar IndexedDB:', e);
          resolve(null);
        }
      });
    }
    
    // Carregar estado (LocalStorage + IndexedDB como fallback)
    async function loadState() {
      try {
        // Tentar localStorage primeiro
        const lsData = localStorage.getItem(LS_KEY);
        if (lsData) {
          console.log('üìÇ Carregando do localStorage:', LS_KEY);
          console.log('   Tamanho:', lsData.length, 'bytes');
          const parsed = JSON.parse(lsData);
          
          // Salvar tamb√©m no IndexedDB para backup
          if (db) {
            await saveToIndexedDB(LS_KEY, parsed);
          }
          
          return parsed;
        }
        
        // Se n√£o encontrou no localStorage, tentar IndexedDB
        console.log('‚ÑπÔ∏è Nada no localStorage, tentando IndexedDB...');
        const idbData = await loadFromIndexedDB(LS_KEY);
        if (idbData) {
          console.log('‚úÖ Dados recuperados do IndexedDB');
          // Restaurar no localStorage
          try {
            localStorage.setItem(LS_KEY, JSON.stringify(idbData));
          } catch(e) {
            console.warn('‚ö†Ô∏è N√£o foi poss√≠vel restaurar no localStorage');
          }
          return idbData;
        }
        
        console.log('‚ÑπÔ∏è Nenhum dado salvo encontrado');
        return {};
      } catch(e) {
        console.error('‚ùå Erro ao carregar estado:', e);
        return {};
      }
    }
    
    // Atualizar indicador visual de salvamento
    function updateSaveIndicator(status) {
      const indicator = document.getElementById('saveIndicator');
      const text = document.getElementById('saveText');
      if (!indicator || !text) return;
      
      const dot = indicator.querySelector('.w-2');
      
      if (status === 'saving') {
        dot.className = 'w-2 h-2 bg-yellow-400 rounded-full animate-pulse';
        text.textContent = 'Salvando...';
      } else if (status === 'success') {
        dot.className = 'w-2 h-2 bg-green-400 rounded-full';
        text.textContent = 'Salvo';
        // Voltar para "Pronto" ap√≥s 2 segundos
        setTimeout(() => {
          dot.className = 'w-2 h-2 bg-blue-400 rounded-full';
          text.textContent = 'Pronto';
        }, 2000);
      } else if (status === 'error') {
        dot.className = 'w-2 h-2 bg-red-400 rounded-full';
        text.textContent = 'Erro';
      }
    }
    
    // Salvar estado (LocalStorage + IndexedDB)
    async function saveState(s) {
      if (!s) {
        console.warn('‚ö†Ô∏è Tentativa de salvar estado vazio/nulo');
        return;
      }
      
      updateSaveIndicator('saving');
      
      let successCount = 0;
      const dataStr = JSON.stringify(s);
      
      console.log('üíæ Salvando estado...');
      console.log('   Tamanho:', dataStr.length, 'bytes');
      console.log('   Entries:', Object.keys(s.entries || {}).length, 'dias');
      console.log('   Meals:', Object.keys(s.savedMeals || {}).length, 'dias');
      
      // Tentar localStorage
      try {
        localStorage.setItem(LS_KEY, dataStr);
        console.log('‚úÖ Salvo no localStorage');
        successCount++;
      } catch(e) {
        console.error('‚ùå Erro ao salvar no localStorage:', e);
        if (e.name === 'QuotaExceededError') {
          console.error('‚ö†Ô∏è Quota excedida! Tentando limpar dados antigos...');
          // Tentar limpar dados muito antigos (mais de 90 dias)
          await cleanOldData(s);
        }
      }
      
      // Tentar IndexedDB
      try {
        const idbSuccess = await saveToIndexedDB(LS_KEY, s);
        if (idbSuccess) {
          console.log('‚úÖ Salvo no IndexedDB');
          successCount++;
        }
      } catch(e) {
        console.error('‚ùå Erro ao salvar no IndexedDB:', e);
      }
      
      // Salvar tamb√©m nos dados do usu√°rio
      if (currentUser && !currentUser.isDemo) {
        try {
          saveUserData();
        } catch(e) {
          console.error('‚ùå Erro ao salvar dados do usu√°rio:', e);
        }
      }
      
      if (successCount === 0) {
        console.error('‚ùå‚ùå FALHA CR√çTICA: Dados n√£o foram salvos!');
        updateSaveIndicator('error');
        alert('‚ö†Ô∏è ERRO: N√£o foi poss√≠vel salvar os dados!\n\nVerifique:\n- Se o modo privado est√° desativado\n- Se h√° espa√ßo dispon√≠vel\n- As permiss√µes do navegador');
      } else {
        console.log(`‚úÖ Dados salvos com sucesso (${successCount}/2 m√©todos)`);
        updateSaveIndicator('success');
      }
    }
    
    // Limpar dados antigos para liberar espa√ßo
    async function cleanOldData(s) {
      const today = new Date();
      const ninetyDaysAgo = new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
      
      let cleaned = false;
      
      // Limpar entries antigas
      if (s.entries) {
        const oldKeys = Object.keys(s.entries).filter(dateKey => {
          try {
            const date = new Date(dateKey);
            return date < ninetyDaysAgo;
          } catch {
            return false;
          }
        });
        
        oldKeys.forEach(key => {
          delete s.entries[key];
          cleaned = true;
        });
        
        if (oldKeys.length > 0) {
          console.log(`üßπ Removidos ${oldKeys.length} dias antigos de entries`);
        }
      }
      
      // Limpar refei√ß√µes antigas
      if (s.savedMeals) {
        const oldKeys = Object.keys(s.savedMeals).filter(dateKey => {
          try {
            const date = new Date(dateKey);
            return date < ninetyDaysAgo;
          } catch {
            return false;
          }
        });
        
        oldKeys.forEach(key => {
          delete s.savedMeals[key];
          cleaned = true;
        });
        
        if (oldKeys.length > 0) {
          console.log(`üßπ Removidos ${oldKeys.length} dias antigos de refei√ß√µes`);
        }
      }
      
      if (cleaned) {
        // Tentar salvar novamente
        try {
          localStorage.setItem(LS_KEY, JSON.stringify(s));
          console.log('‚úÖ Dados salvos ap√≥s limpeza');
        } catch(e) {
          console.error('‚ùå Ainda assim falhou ao salvar:', e);
        }
      }
    }
    
    // Verificar se est√° sendo executado via file://
    if (window.location.protocol === 'file:') {
      console.warn('‚ö†Ô∏è APP rodando via file:// - Sincroniza√ß√£o com nuvem desabilitada');
      console.warn('üí° Para habilitar: python -m http.server 8080 e acesse http://localhost:8080');
    }
    
    // Inicializar Supabase
    console.log('üöÄ Inicializando NutriX...');
    initSupabase();

    // Event listeners para formul√°rios de auth
    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      
      // A l√≥gica de salvar credenciais foi movida para dentro da fun√ß√£o login()
      // para garantir que s√≥ salva AP√ìS login bem-sucedido
      login(username, password);
    });
    
    document.getElementById('signupForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('signupName').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
      signup(name, email, password, passwordConfirm);
    });
    
    // Carregar dados salvos de login ao iniciar
    window.addEventListener('DOMContentLoaded', () => {
      // Event listener para formul√°rio de trocar senha (dentro do DOMContentLoaded)
      const changePasswordForm = document.getElementById('changePasswordForm');
      if (changePasswordForm) {
        console.log('‚úÖ Event listener do changePasswordForm registrado');
        changePasswordForm.addEventListener('submit', (e) => {
          e.preventDefault();
          console.log('üîê Formul√°rio de trocar senha enviado!');
          const currentPass = document.getElementById('currentPassword').value;
          const newPass = document.getElementById('newPassword').value;
          const confirmPass = document.getElementById('confirmNewPassword').value;
          changePassword(currentPass, newPass, confirmPass);
        });
      } else {
        console.warn('‚ö†Ô∏è changePasswordForm n√£o encontrado no DOM');
      }
      
      // Carregar dados salvos de login
      const rememberLogin = localStorage.getItem('nutrix-remember-login');
      if (rememberLogin === 'true') {
        const savedEmail = localStorage.getItem('nutrix-saved-email');
        const savedPassword = localStorage.getItem('nutrix-saved-password');
        
        if (savedEmail) {
          document.getElementById('loginUsername').value = savedEmail;
        }
        if (savedPassword) {
          document.getElementById('loginPassword').value = atob(savedPassword); // Descriptografar
        }
        document.getElementById('rememberLogin').checked = true;
      }
    });

    // Inicializar autentica√ß√£o (agora √© async)
    let isLoggedIn = false;
    (async () => {
      isLoggedIn = await initAuth();
    })();

    // Inicializar IndexedDB antes de carregar o estado
    (async () => {
      try {
        await initDB();
      } catch(e) {
        console.warn('‚ö†Ô∏è IndexedDB n√£o dispon√≠vel, usando apenas localStorage');
      }
      
      // Inicializar state
      state = await loadState();
      if(!state.entries) state.entries={};
      if(!state.goal) state.goal=2000;
      if(!state.customFoods) state.customFoods=[];
      if(!state.overrides) state.overrides={};
      if(!state.savedMeals) state.savedMeals={};
      // selectedDate sempre em DD/MM/YYYY
      if(!state.selectedDate) state.selectedDate = getTodayStringLocal();
      if(!state.goals) state.goals = {}; // metas para helpers
      
      // Tornar state global para acesso em fun√ß√µes globais
      window.state = state;
      
      // Carregar dados do usu√°rio logado
      if (isLoggedIn && currentUser) {
        // Sincronizar com Supabase se estiver online
        if (isOnline && supabase && !currentUser.isDemo) {
          console.log('üîÑ Buscando dados do servidor...');
          await syncFromSupabase();
          // Atualizar refer√™ncia global ap√≥s sync
          window.state = state;
        } else {
          // Se offline, carregar dados locais
          loadUserData();
        }
      }
      
      console.log('üéØ Estado inicial carregado:');
      console.log('   Entries:', Object.keys(state.entries).length, 'dias');
      console.log('   Meals:', Object.keys(state.savedMeals).length, 'dias');
      console.log('   Custom Foods:', state.customFoods.length);
      console.log('   Data selecionada:', state.selectedDate);
      
      // Auto-salvar a cada 20 segundos
      setInterval(async () => {
        console.log('üíæ Auto-save (20s)...');
        await saveState(state);
      }, 20000);
      
      // Salvar antes de fechar/recarregar
      window.addEventListener('beforeunload', async (e) => {
        console.log('üíæ Salvando antes de fechar...');
        await saveState(state);
      });
      
      // Salvar quando a aba perde o foco
      document.addEventListener('visibilitychange', async () => {
        if (document.hidden) {
          console.log('üíæ Salvando ao minimizar...');
          await saveState(state);
        }
      });
      
      // Salvar quando detectar pause (mobile)
      window.addEventListener('pagehide', async () => {
        console.log('üíæ Salvando ao pausar (mobile)...');
        await saveState(state);
      });
    })();

    // Refer√™ncias para o dashboard
    let nutritionGoals = {
      kcal: 2000,
      protein: 150,
      carbs: 250,
      fat: 67,
      fiber: 25
    };
    let mealTypes = [
      'üåÖ Caf√© da Manh√£',
      'ü•™ Lanche da Manh√£', 
      'üçΩÔ∏è Almo√ßo',
      'üç∞ Lanche da Tarde',
      'üåô Jantar',
      'üåú Ceia'
    ];
    const unitSelect=document.getElementById('unitSelect');
    const addBtn=document.getElementById('addBtn');
    const saveMealBtn=document.getElementById('saveMealBtn');
    const itemsList=document.getElementById('itemsList');
    const calcPreview=document.getElementById('calcPreview');
    const unTools=document.getElementById('unTools');
    const inpGpu=document.getElementById('inpGpu');
    const btnSaveGpu=document.getElementById('btnSaveGpu');
    const btnClearGpu=document.getElementById('btnClearGpu');
    const donutSeg=document.getElementById('donutSeg');
    const donutPct=document.getElementById('donutPct');
    const donutSub=document.getElementById('donutSub');
    const CIRC=2*Math.PI*52;
    const variantModal=document.getElementById('variantModal');
    const vmTitle=document.getElementById('vmTitle');
    const vmDesc=document.getElementById('vmDesc');
    const vmName=document.getElementById('vmName');
    const vmBase=document.getElementById('vmBase');
    const vmKcal=document.getElementById('vmKcal');
    const vmProt=document.getElementById('vmProt');
    const vmCarb=document.getElementById('vmCarb');
    const vmFat=document.getElementById('vmFat');
    const vmFib=document.getElementById('vmFib');
    const vmCancel=document.getElementById('vmCancel');
    const vmSave=document.getElementById('vmSave');

    // Navega√ß√£o e tabs
    const tabHome=document.getElementById('tabHome');
    const tabLancamentos=document.getElementById('tabLancamentos');
    const tabRefeicoes=document.getElementById('tabRefeicoes');
    const tabAlimentos=document.getElementById('tabAlimentos');
    const tabRelatorios=document.getElementById('tabRelatorios');
    const refeicoesTab=document.getElementById('refeicoes-tab');
    const relatoriosTab=document.getElementById('relatorios-tab');

    /* === FUN√á√ïES DE NAVEGA√á√ÉO === */
    function showTab(tabName) {
      console.log('=== SHOW TAB:', tabName, '===');
      currentTab = tabName;
      
      // Fechar painel de personaliza√ß√£o se estiver aberto
      const customizePanel = el('customizePanel');
      if (customizePanel && !customizePanel.classList.contains('hidden')) {
        customizePanel.classList.add('hidden');
      }
      
      // Esconder todas as p√°ginas principais (com guards)
      const homePage = el('homePage');
      const lancamentosPage = el('lancamentosPage');
      const configPage = el('configPage');
      
      if (homePage) homePage.classList.add('hidden');
      if (lancamentosPage) lancamentosPage.classList.add('hidden');
      if (configPage) configPage.classList.add('hidden');
      
      // Esconder outras abas espec√≠ficas (com guards)
      const refeicoesTab = el('refeicoes-tab');
      const alimentosTab = el('alimentos-tab');
      const relatoriosTab = el('relatorios-tab');
      if (refeicoesTab) refeicoesTab.classList.add('hidden');
      if (alimentosTab) alimentosTab.classList.add('hidden');
      if (relatoriosTab) relatoriosTab.classList.add('hidden');
      
      // Resetar todos os bot√µes da navega√ß√£o (com guard)
      const navButtons = document.querySelectorAll('nav button');
      if (navButtons) {
        navButtons.forEach(btn => {
          btn.classList.remove('font-medium');
          btn.classList.add('opacity-80');
        });
      }
      
      // Mostrar p√°gina correta e ativar bot√£o (com guards defensivos)
      if (tabName === 'home') {
        if (homePage) homePage.classList.remove('hidden');
        const tabHome = el('tabHome');
        if (tabHome) {
          tabHome.classList.add('font-medium');
          tabHome.classList.remove('opacity-80');
        }
        updateHomeDashboard();
      } else if (tabName === 'lancamentos') {
        if (lancamentosPage) lancamentosPage.classList.remove('hidden');
        const tabLancamentos = el('tabLancamentos');
        if (tabLancamentos) {
          tabLancamentos.classList.add('font-medium');
          tabLancamentos.classList.remove('opacity-80');
        }
        if (dateInput) bindDay(dateInput.value);
      } else if (tabName === 'config') {
        console.log('üîß Abrindo p√°gina de configura√ß√£o...');
        console.log('  configPage existe?', !!configPage);
        console.log('  configPage classes antes:', configPage ? configPage.className : 'N/A');
        if (configPage) {
          configPage.classList.remove('hidden');
          console.log('  configPage classes depois:', configPage.className);
        }
        loadConfiguration();
      } else if (tabName === 'refeicoes') {
        if (refeicoesTab) refeicoesTab.classList.remove('hidden');
        const tabRefeicoes = el('tabRefeicoes');
        if (tabRefeicoes) {
          tabRefeicoes.classList.add('font-medium');
          tabRefeicoes.classList.remove('opacity-80');
        }
        // Carregar refei√ß√µes
        if (typeof window.loadRefeicoesTab === 'function') {
          window.loadRefeicoesTab();
        }
      } else if (tabName === 'alimentos') {
        if (alimentosTab) alimentosTab.classList.remove('hidden');
        const tabAlimentos = el('tabAlimentos');
        if (tabAlimentos) {
          tabAlimentos.classList.add('font-medium');
          tabAlimentos.classList.remove('opacity-80');
        }
        // Atualizar lista de alimentos
        if (typeof window.updateAlimentosCounter === 'function') {
          window.updateAlimentosCounter();
        }
        if (typeof window.displayAlimentos === 'function') {
          const foods = window.allFoods ? window.allFoods() : (window.builtinFoods || []);
          window.displayAlimentos(foods);
        }
      } else if (tabName === 'relatorios') {
        if (relatoriosTab) relatoriosTab.classList.remove('hidden');
        const tabRelatorios = el('tabRelatorios');
        if (tabRelatorios) {
          tabRelatorios.classList.add('font-medium');
          tabRelatorios.classList.remove('opacity-80');
        }
      }
      
      console.log('Tab ativada:', tabName);
    }
    
    // Tornar showTab global para uso no onclick
    window.showTab = showTab;
    console.log('‚úÖ window.showTab definido:', typeof window.showTab);

    /* === FUN√á√ïES DE √ÅGUA REMOVIDAS === */

    /* === FUN√á√ïES DE TIPOS DE REFEI√á√ïES === */
    function loadMealTypes() {
      const saved = localStorage.getItem('mealTypes');
      if (saved) {
        mealTypes = JSON.parse(saved);
      }
      updateMealTypesList();
      updateMealSelects(); // Atualizar os selects de refei√ß√£o em outras p√°ginas
    }

    function saveMealTypes() {
      localStorage.setItem('mealTypes', JSON.stringify(mealTypes));
    }

    function updateMealTypesList() {
      const container = document.getElementById('mealTypesList');
      if (!container) return;
      
      container.innerHTML = '';
      
      mealTypes.forEach((mealType, index) => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between bg-white/5 rounded-lg p-3';
        
        item.innerHTML = `
          <span class="text-sm">${mealType}</span>
          <div class="flex items-center gap-2">
            <button onclick="moveMealType(${index}, -1)" class="p-1 rounded text-xs hover:bg-white/10 ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === 0 ? 'disabled' : ''}>
              ‚¨ÜÔ∏è
            </button>
            <button onclick="moveMealType(${index}, 1)" class="p-1 rounded text-xs hover:bg-white/10 ${index === mealTypes.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === mealTypes.length - 1 ? 'disabled' : ''}>
              ‚¨áÔ∏è
            </button>
            <button onclick="removeMealType(${index})" class="p-1 rounded text-xs hover:bg-red-500/20 text-red-400">
              üóëÔ∏è
            </button>
          </div>
        `;
        
        container.appendChild(item);
      });
    }

    function addMealType() {
      const input = document.getElementById('newMealType');
      const newType = input.value.trim();
      
      if (!newType) {
        alert('Digite um nome para o tipo de refei√ß√£o');
        return;
      }
      
      if (mealTypes.includes(newType)) {
        alert('Este tipo de refei√ß√£o j√° existe');
        return;
      }
      
      mealTypes.push(newType);
      saveMealTypes();
      updateMealTypesList();
      updateMealSelects();
      input.value = '';
    }

    function removeMealType(index) {
      if (mealTypes.length <= 1) {
        alert('Deve haver pelo menos um tipo de refei√ß√£o');
        return;
      }
      
      if (confirm('Tem certeza que deseja remover este tipo de refei√ß√£o?')) {
        mealTypes.splice(index, 1);
        saveMealTypes();
        updateMealTypesList();
        updateMealSelects();
      }
    }

    function moveMealType(index, direction) {
      const newIndex = index + direction;
      
      if (newIndex < 0 || newIndex >= mealTypes.length) return;
      
      // Trocar posi√ß√µes
      const temp = mealTypes[index];
      mealTypes[index] = mealTypes[newIndex];
      mealTypes[newIndex] = temp;
      
      saveMealTypes();
      updateMealTypesList();
      updateMealSelects();
    }

    function updateMealSelects() {
      const mealSelects = document.querySelectorAll('#mealType, #saveMealType, #mealSelect');
      
      mealSelects.forEach(select => {
        if (!select) return;
        
        const currentValue = select.value;
        select.innerHTML = '';
        
        mealTypes.forEach(mealType => {
          const option = document.createElement('option');
          option.value = mealType;
          option.textContent = mealType;
          select.appendChild(option);
        });
        
        // Restaurar valor selecionado se ainda existir
        if (mealTypes.includes(currentValue)) {
          select.value = currentValue;
        } else if (mealTypes.length > 0) {
          select.value = mealTypes[0];
        }
      });
    }

    /* === FUN√á√ïES DE CONFIGURA√á√ÉO === */
    function loadNutritionGoals() {
      const saved = localStorage.getItem('nutritionGoals');
      if (saved) {
        nutritionGoals = JSON.parse(saved);
      }
    }

    function loadConfiguration() {
      loadNutritionGoals();
      
      document.getElementById('configKcal').value = nutritionGoals.kcal;
      document.getElementById('configProtein').value = nutritionGoals.protein;
      document.getElementById('configCarbs').value = nutritionGoals.carbs;
      document.getElementById('configFat').value = nutritionGoals.fat;
      document.getElementById('configFiber').value = nutritionGoals.fiber;
    }

    function saveConfiguration() {
      console.log('üíæ Salvando configura√ß√µes...');
      
      // Validar valores
      const kcal = parseInt(document.getElementById('configKcal').value);
      const protein = parseInt(document.getElementById('configProtein').value);
      const carbs = parseInt(document.getElementById('configCarbs').value);
      const fat = parseInt(document.getElementById('configFat').value);
      const fiber = parseInt(document.getElementById('configFiber').value);
      
      if (isNaN(kcal) || isNaN(protein) || isNaN(carbs) || isNaN(fat) || isNaN(fiber)) {
        alert('‚ö†Ô∏è Por favor, preencha todos os campos com valores v√°lidos.');
        return;
      }
      
      if (kcal <= 0 || protein <= 0 || carbs <= 0 || fat <= 0 || fiber < 0) {
        alert('‚ö†Ô∏è Os valores devem ser maiores que zero.');
        return;
      }
      
      // Atualizar metas
      nutritionGoals.kcal = kcal;
      nutritionGoals.protein = protein;
      nutritionGoals.carbs = carbs;
      nutritionGoals.fat = fat;
      nutritionGoals.fiber = fiber;
      
      // Salvar no localStorage
      localStorage.setItem('nutritionGoals', JSON.stringify(nutritionGoals));
      
      // Atualizar state.goal (para compatibilidade)
      state.goal = kcal;
      saveState(state);
      
      // Atualizar dashboard
      updateHomeDashboard();
      
      console.log('‚úÖ Configura√ß√µes salvas:', nutritionGoals);
      alert('‚úÖ Configura√ß√µes salvas com sucesso!');
      showTab('home');
    }
    
    // Tornar saveConfiguration global para uso no onclick
    window.saveConfiguration = saveConfiguration;

    /* === FUN√á√ïES DE DASHBOARD === */
    /* === HELPERS PARA DASHBOARD === */
    function mapKey(k) {
      // kcal->Kcal, prot->Protein, carb->Carbs, fat->Fat, fiber->Fiber
      return ({ kcal: 'Kcal', prot: 'Protein', carb: 'Carbs', fat: 'Fat', fiber: 'Fiber' })[k] || k;
    }
    
    function formatMacro(key, v) {
      // N√£o adiciona "g" porque j√° est√° no HTML ap√≥s o span
      return `${Math.round(v)}`;
    }
    
    function setHomeCard(key, current, goal) {
      const curEl = el(`homeTotal${mapKey(key)}`);
      const goalEl = el(`homeGoal${mapKey(key)}`);
      const barEl = el(`home${mapKey(key)}Progress`);
      const percentEl = el(`home${mapKey(key)}Percent`);
      
      if (curEl) curEl.textContent = formatMacro(key, current);
      if (goalEl) goalEl.textContent = goal ? formatMacro(key, goal) : formatMacro(key, 0);
      
      const pct = goal > 0 ? Math.max(0, Math.min(100, (current / goal) * 100)) : 0;
      if (barEl) barEl.style.strokeDasharray = `${pct}, 100`; // path normalizado p/100
      
      // Atualizar texto de porcentagem
      if (percentEl) {
        const displayPct = Math.round(pct);
        
        // Visual de conclus√£o: quando atingir 100%, mostra checkmark ‚úì
        if (displayPct >= 100) {
          percentEl.textContent = '‚úì';
          percentEl.classList.add('text-green-400', 'text-[10px]');
          percentEl.classList.remove('text-slate-400', 'text-[6px]');
        } else {
          percentEl.textContent = `${displayPct}%`;
          percentEl.classList.add('text-slate-400', 'text-[6px]');
          percentEl.classList.remove('text-green-400', 'text-[10px]');
        }
      }
    }
    
    /* === PERSONALIZA√á√ÉO DO DASHBOARD === */
    function toggleDashboardCustomize() {
      const panel = el('customizePanel');
      if (panel) {
        panel.classList.toggle('hidden');
      }
    }
    
    function toggleMacroVisibility(macroKey, isVisible) {
      const cardId = `macroCard${macroKey.charAt(0).toUpperCase() + macroKey.slice(1)}`;
      const card = el(cardId);
      
      if (card) {
        if (isVisible) {
          card.classList.remove('hidden');
        } else {
          card.classList.add('hidden');
        }
      }
      
      // Salvar prefer√™ncias no localStorage
      const prefs = JSON.parse(localStorage.getItem('dashboardPrefs') || '{}');
      prefs[macroKey] = isVisible;
      localStorage.setItem('dashboardPrefs', JSON.stringify(prefs));
      
      console.log(`üé® Macro ${macroKey} ${isVisible ? 'vis√≠vel' : 'oculto'}`);
    }
    
    function loadDashboardPreferences() {
      const prefs = JSON.parse(localStorage.getItem('dashboardPrefs') || '{}');
      
      // Aplicar prefer√™ncias salvas
      ['kcal', 'protein', 'carbs', 'fiber', 'fat'].forEach(macro => {
        if (prefs.hasOwnProperty(macro)) {
          const checkbox = el(`show${macro.charAt(0).toUpperCase() + macro.slice(1)}`);
          const cardId = `macroCard${macro.charAt(0).toUpperCase() + macro.slice(1)}`;
          const card = el(cardId);
          
          if (checkbox) checkbox.checked = prefs[macro];
          if (card && !prefs[macro]) card.classList.add('hidden');
        }
      });
      
      console.log('üé® Prefer√™ncias de dashboard carregadas:', prefs);
    }
    
    // Tornar fun√ß√µes globais
    window.toggleDashboardCustomize = toggleDashboardCustomize;
    window.toggleMacroVisibility = toggleMacroVisibility;
    
    /* === UPDATE HOME DASHBOARD (somente dia atual, sem sujeira) === */
    function updateHomeDashboard() {
      console.log('=== UPDATE DASHBOARD CHAMADO ===');
      
      // Verificar se state existe
      if (!state) {
        console.error('‚ùå State n√£o inicializado!');
        return;
      }
      
      const day = state.selectedDate || getTodayStringLocal();
      console.log('Data selecionada:', day);
      
      // Filtrar APENAS os lan√ßamentos do dia (suporta YYYY-MM-DD e DD/MM/YYYY)
      const entriesToday = Object.keys(state.entries || {}).reduce((acc, dateKey) => {
        if (sameDay(dateKey, day)) {
          const entries = state.entries[dateKey] || [];
          return acc.concat(entries.filter(e => e && typeof e.kcal === 'number'));
        }
        return acc;
      }, []);
      
      // Filtrar refei√ß√µes salvas do dia
      const mealsToday = Object.keys(state.savedMeals || {}).reduce((acc, dateKey) => {
        if (sameDay(dateKey, day)) {
          const meals = state.savedMeals[dateKey] || [];
          meals.forEach(meal => {
            if (meal && meal.items && Array.isArray(meal.items)) {
              const validItems = meal.items.filter(item => item && typeof item.kcal === 'number');
              acc = acc.concat(validItems);
            }
          });
        }
        return acc;
      }, []);
      
      console.log('Lan√ßamentos hoje:', entriesToday.length);
      console.log('Refei√ß√µes hoje:', mealsToday.length);
      
      // Soma macros s√≥ de hoje (NUNCA outros dias)
      const totals = { kcal: 0, prot: 0, carb: 0, fat: 0, fiber: 0 };
      
      for (const e of entriesToday) {
        totals.kcal += +e.kcal || 0;
        totals.prot += +e.prot || +e.protein || 0;
        totals.carb += +e.carb || +e.carbs || 0;
        totals.fat += +e.fat || 0;
        totals.fiber += +e.fiber || 0;
      }
      
      for (const m of mealsToday) {
        totals.kcal += +m.kcal || 0;
        totals.prot += +m.prot || +m.protein || 0;
        totals.carb += +m.carb || +m.carbs || 0;
        totals.fat += +m.fat || 0;
        totals.fiber += +m.fiber || 0;
      }
      
      console.log('Totais do dia:', totals);
      
      // Atualizar UI usando helpers robustos
      const goals = {
        kcal: nutritionGoals.kcal || 2000,
        prot: nutritionGoals.protein || 150,
        carb: nutritionGoals.carbs || 250,
        fat: nutritionGoals.fat || 67,
        fiber: nutritionGoals.fiber || 25
      };
      
      setHomeCard('kcal', totals.kcal, goals.kcal);
      setHomeCard('prot', totals.prot, goals.prot);
      setHomeCard('carb', totals.carb, goals.carb);
      setHomeCard('fat', totals.fat, goals.fat);
      setHomeCard('fiber', totals.fiber, goals.fiber);
      
      // T√≠tulo/data vis√≠vel
      const homeDateEl = el('homeDate');
      if (homeDateEl) {
        homeDateEl.textContent = formatDateForHuman(day);
      }
      
      console.log('Dashboard atualizado com sucesso');
      console.log('=== FIM UPDATE DASHBOARD ===');
    }
    
    /* Obter entradas para uma data espec√≠fica (formato YYYY-MM-DD) */
    function getEntriesForDate(date) {
      if (!state || !state.entries || !state.savedMeals) {
        return [];
      }
      
      let allEntries = [];
      
      // Adicionar lan√ßamentos individuais
      if (state.entries[date] && state.entries[date].length > 0) {
        const validEntries = state.entries[date].filter(entry => 
          entry && typeof entry === 'object' && typeof entry.kcal === 'number'
        );
        allEntries = allEntries.concat(validEntries);
      }
      
      // Adicionar itens das refei√ß√µes salvas
      if (state.savedMeals[date] && state.savedMeals[date].length > 0) {
        state.savedMeals[date].forEach(meal => {
          if (meal && meal.items && Array.isArray(meal.items)) {
            const validItems = meal.items.filter(item => 
              item && typeof item === 'object' && typeof item.kcal === 'number'
            );
            allEntries = allEntries.concat(validItems);
          }
        });
      }
      
      return allEntries;
    }

    /* Atualiza barra de progresso SVG (stroke-dasharray normalizado para 100) */
    function updateProgressBar(element, current, goal) {
      if (!element) return; // Guard: elemento n√£o existe
      
      // Clampar percentage entre 0 e 100 (SVG path normalizado para circumfer√™ncia 100)
      const percentage = Math.max(0, Math.min((current / goal) * 100, 100));
      
      // Para c√≠rculos SVG, usamos stroke-dasharray: <filled>, <total>
      const circumference = 100; // Path normalizado para 100
      const dashArray = `${percentage}, ${circumference}`;
      element.style.strokeDasharray = dashArray;
    }

    function getTodayEntries() {
      const today = getTodayString();
      
      // Verificar se state existe
      if (!state || !state.entries || !state.savedMeals) {
        console.log('State inv√°lido');
        return [];
      }
      
      // Verificar se h√° dados para hoje
      const hasEntries = state.entries[today] && state.entries[today].length > 0;
      const hasMeals = state.savedMeals[today] && state.savedMeals[today].length > 0;
      
      console.log('=== getTodayEntries ===');
      console.log('Data:', today);
      console.log('Tem entries?', hasEntries);
      console.log('Tem meals?', hasMeals);
      
      if (!hasEntries && !hasMeals) {
        console.log('Sem dados para hoje - retornando array vazio');
        return [];
      }
      
      let allEntries = [];
      
      // Adicionar lan√ßamentos individuais
      if (hasEntries) {
        const validEntries = state.entries[today].filter(entry => 
          entry && typeof entry === 'object' && typeof entry.kcal === 'number'
        );
        allEntries = allEntries.concat(validEntries);
        console.log('Entries v√°lidas adicionadas:', validEntries.length);
      }
      
      // Adicionar itens das refei√ß√µes salvas
      if (hasMeals) {
        state.savedMeals[today].forEach(meal => {
          if (meal && meal.items && Array.isArray(meal.items)) {
            const validItems = meal.items.filter(item => 
              item && typeof item === 'object' && typeof item.kcal === 'number'
            );
            allEntries = allEntries.concat(validItems);
            console.log('Items de refei√ß√£o adicionados:', validItems.length);
          }
        });
      }
      
      console.log('Total de entradas:', allEntries.length);
      console.log('=== FIM getTodayEntries ===');
      
      return allEntries;
    }

    /* === UTILIT√ÅRIOS DE DATA (local, n√£o UTC) === */
    function getTodayStringLocal(fmt = 'DD/MM/YYYY') {
      const d = new Date();
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      if (fmt === 'YYYY-MM-DD') return `${yyyy}-${mm}-${dd}`;
      return `${dd}/${mm}/${yyyy}`;
    }
    
    function sameDay(a, b) {
      // a e b no formato DD/MM/YYYY ou YYYY-MM-DD
      // normaliza para compara√ß√£o
      const normalize = (str) => {
        if (!str) return '';
        if (str.includes('/')) return str; // j√° DD/MM/YYYY
        // converter YYYY-MM-DD para DD/MM/YYYY
        const [y, m, d] = str.split('-');
        return `${d}/${m}/${y}`;
      };
      return normalize(a) === normalize(b);
    }
    
    function formatDateForHuman(dateStr) {
      if (!dateStr) return 'Data n√£o definida';
      
      let dd, mm, yy;
      
      // Detectar formato: DD/MM/YYYY ou YYYY-MM-DD
      if (dateStr.includes('/')) {
        // Formato DD/MM/YYYY
        [dd, mm, yy] = dateStr.split('/').map(x => +x);
      } else if (dateStr.includes('-')) {
        // Formato YYYY-MM-DD
        const [year, month, day] = dateStr.split('-').map(x => +x);
        dd = day;
        mm = month;
        yy = year;
      } else {
        return 'Data inv√°lida';
      }
      
      const meses = ['janeiro', 'fevereiro', 'mar√ßo', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
      
      // Validar valores
      if (!dd || !mm || !yy || mm < 1 || mm > 12) {
        return 'Data inv√°lida';
      }
      
      return `${dd} de ${meses[mm - 1]} de ${yy}`;
    }
    
    function getTodayString() {
      // mant√©m compatibilidade com c√≥digo legado que usa YYYY-MM-DD
      return getTodayStringLocal('YYYY-MM-DD');
    }
    
    // Nova fun√ß√£o para normalizar datas para formato padr√£o YYYY-MM-DD
    function normalizeDate(dateStr) {
      if (!dateStr) return getTodayString();
      
      // J√° est√° em YYYY-MM-DD
      if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
      
      // Converter DD/MM/YYYY para YYYY-MM-DD
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
        const [dd, mm, yyyy] = dateStr.split('/');
        return `${yyyy}-${mm}-${dd}`;
      }
      
      // Caso inv√°lido, retorna hoje
      console.warn('Data inv√°lida:', dateStr, '- usando hoje');
      return getTodayString();
    }
    
    // Aba Relat√≥rios
    const btnPorPeriodo=document.getElementById('btnPorPeriodo');
    const btnPorDia=document.getElementById('btnPorDia');
    const camposPeriodo=document.getElementById('camposPeriodo');
    const camposDia=document.getElementById('camposDia');
    const dataInicial=document.getElementById('dataInicial');
    const dataFinal=document.getElementById('dataFinal');
    const dataEspecifica=document.getElementById('dataEspecifica');
    const btnGerarRelatorio=document.getElementById('btnGerarRelatorio');
    const resultadosRelatorio=document.getElementById('resultadosRelatorio');
    const periodoRelatorio=document.getElementById('periodoRelatorio');
    const relatorioContainer=document.getElementById('relatorioContainer');
    const refeicoesDate=document.getElementById('refeicoesDate');
    const refeicoesContainer=document.getElementById('refeicoesContainer');

    // Aba Alimentos
    const alimentosTab=document.getElementById('alimentos-tab');
    const btnNovoAlimento=document.getElementById('btnNovoAlimento');
    const btnExibirLista=document.getElementById('btnExibirLista');
    const btnOcultarLista=document.getElementById('btnOcultarLista');
    const alimentosListWrapper=document.getElementById('alimentosListWrapper');
    const alimentosCounter=document.getElementById('alimentosCounter');
    const searchAlimentos=document.getElementById('searchAlimentos');
    const alimentosContainer=document.getElementById('alimentosContainer');
    const alimentoActions=document.getElementById('alimentoActions');
    const btnEditarAlimento=document.getElementById('btnEditarAlimento');
    const btnExcluirAlimento=document.getElementById('btnExcluirAlimento');
    
    // Modal Alimento
    const alimentoModal=document.getElementById('alimentoModal');
    const amTitle=document.getElementById('amTitle');
    const amName=document.getElementById('amName');
    const amUnitBase=document.getElementById('amUnitBase');
    const amKcal=document.getElementById('amKcal');
    const amProt=document.getElementById('amProt');
    const amCarb=document.getElementById('amCarb');
    const amFat=document.getElementById('amFat');
    const amFiber=document.getElementById('amFiber');
    const amCancel=document.getElementById('amCancel');
    const amSave=document.getElementById('amSave');

    // Fun√ß√£o de data removida - usar getTodayString() padronizada

    /* Storage */
    // State j√° inicializado no topo
    // goalKcalEl.textContent=state.goal; // COMENTADO - elemento n√£o existe ou ser√° definido depois

    /* Foods */
    builtinFoods=[
      // Cereais e Gr√£os
      { id:'f1', name:'Arroz branco', nameLower:'arroz branco', unitBase:'g', kcal100:130, prot100:2.5, carb100:28.0, fat100:0.3, fiber100:0.4, category:'Cereais e Gr√£os' },
      { id:'f2', name:'Arroz integral', nameLower:'arroz integral', unitBase:'g', kcal100:124, prot100:2.6, carb100:25.8, fat100:1.0, fiber100:1.6, category:'Cereais e Gr√£os' },
      { id:'f3', name:'Arroz parboilizado', nameLower:'arroz parboilizado', unitBase:'g', kcal100:123, prot100:2.6, carb100:26.0, fat100:0.8, fiber100:1.3, category:'Cereais e Gr√£os' },
      { id:'f4', name:'Arroz cateto', nameLower:'arroz cateto', unitBase:'g', kcal100:130, prot100:2.4, carb100:28.7, fat100:0.3, fiber100:0.5, category:'Cereais e Gr√£os' },
      { id:'f5', name:'Arroz negro', nameLower:'arroz negro', unitBase:'g', kcal100:335, prot100:7.5, carb100:72.0, fat100:2.8, fiber100:4.5, category:'Cereais e Gr√£os' },
      { id:'f6', name:'Arroz vermelho', nameLower:'arroz vermelho', unitBase:'g', kcal100:365, prot100:8.0, carb100:76.0, fat100:2.7, fiber100:3.5, category:'Cereais e Gr√£os' },
      { id:'f7', name:'Aveia em flocos', nameLower:'aveia em flocos', unitBase:'g', kcal100:389, prot100:16.9, carb100:66.0, fat100:6.9, fiber100:10.6, category:'Cereais e Gr√£os' },
      { id:'f8', name:'Aveia em flocos finos', nameLower:'aveia em flocos finos', unitBase:'g', kcal100:389, prot100:16.9, carb100:66.0, fat100:6.9, fiber100:10.6, category:'Cereais e Gr√£os' },
      { id:'f9', name:'Aveia em farelo', nameLower:'aveia em farelo', unitBase:'g', kcal100:246, prot100:17.3, carb100:66.2, fat100:7.0, fiber100:15.4, category:'Cereais e Gr√£os' },
      { id:'f10', name:'Cevada', nameLower:'cevada', unitBase:'g', kcal100:354, prot100:12.5, carb100:73.5, fat100:2.3, fiber100:17.3, category:'Cereais e Gr√£os' },
      { id:'f11', name:'Centeio', nameLower:'centeio', unitBase:'g', kcal100:338, prot100:10.3, carb100:75.9, fat100:1.6, fiber100:15.1, category:'Cereais e Gr√£os' },
      { id:'f12', name:'Quinoa branca', nameLower:'quinoa branca', unitBase:'g', kcal100:120, prot100:4.4, carb100:21.3, fat100:1.9, fiber100:2.8, category:'Cereais e Gr√£os' },
      { id:'f13', name:'Quinoa vermelha', nameLower:'quinoa vermelha', unitBase:'g', kcal100:120, prot100:4.4, carb100:21.3, fat100:1.9, fiber100:2.8, category:'Cereais e Gr√£os' },
      { id:'f14', name:'Quinoa preta', nameLower:'quinoa preta', unitBase:'g', kcal100:120, prot100:4.4, carb100:21.3, fat100:1.9, fiber100:2.8, category:'Cereais e Gr√£os' },
      { id:'f15', name:'Milho cozido', nameLower:'milho cozido', unitBase:'g', kcal100:96, prot100:3.4, carb100:21.0, fat100:1.5, fiber100:2.4, category:'Cereais e Gr√£os' },
      { id:'f16', name:'Milho verde enlatado', nameLower:'milho verde enlatado', unitBase:'g', kcal100:86, prot100:2.7, carb100:19.0, fat100:1.2, fiber100:2.7, category:'Cereais e Gr√£os' },
      { id:'f17', name:'Pipoca sem √≥leo', nameLower:'pipoca sem √≥leo', unitBase:'g', kcal100:387, prot100:12.9, carb100:78.0, fat100:4.5, fiber100:15.0, category:'Cereais e Gr√£os' },
      { id:'f18', name:'Pipoca com √≥leo', nameLower:'pipoca com √≥leo', unitBase:'g', kcal100:535, prot100:8.1, carb100:58.0, fat100:31.0, fiber100:10.0, category:'Cereais e Gr√£os' },
      { id:'f19', name:'Farinha de trigo', nameLower:'farinha de trigo', unitBase:'g', kcal100:364, prot100:10.3, carb100:76.0, fat100:1.0, fiber100:2.7, category:'Cereais e Gr√£os' },
      { id:'f20', name:'Farinha de aveia', nameLower:'farinha de aveia', unitBase:'g', kcal100:404, prot100:14.7, carb100:66.0, fat100:9.1, fiber100:6.5, category:'Cereais e Gr√£os' },
      { id:'f21', name:'Farinha de arroz', nameLower:'farinha de arroz', unitBase:'g', kcal100:366, prot100:6.0, carb100:80.0, fat100:1.5, fiber100:2.4, category:'Cereais e Gr√£os' },
      { id:'f22', name:'Farinha de am√™ndoas', nameLower:'farinha de am√™ndoas', unitBase:'g', kcal100:579, prot100:21.2, carb100:21.6, fat100:49.9, fiber100:12.5, category:'Cereais e Gr√£os' },
      { id:'f23', name:'Farinha de coco', nameLower:'farinha de coco', unitBase:'g', kcal100:400, prot100:18.0, carb100:60.0, fat100:14.0, fiber100:35.0, category:'Cereais e Gr√£os' },
      { id:'f24', name:'Tapioca', nameLower:'tapioca', unitBase:'g', kcal100:330, prot100:0.2, carb100:82.0, fat100:0.2, fiber100:0.9, category:'Cereais e Gr√£os' },
      { id:'f25', name:'Polvilho doce', nameLower:'polvilho doce', unitBase:'g', kcal100:351, prot100:0.2, carb100:87.0, fat100:0.3, fiber100:0.8, category:'Cereais e Gr√£os' },
      { id:'f26', name:'Polvilho azedo', nameLower:'polvilho azedo', unitBase:'g', kcal100:351, prot100:0.2, carb100:87.0, fat100:0.3, fiber100:0.8, category:'Cereais e Gr√£os' },
      { id:'f27', name:'Cuscuz de milho', nameLower:'cuscuz de milho', unitBase:'g', kcal100:112, prot100:3.8, carb100:24.0, fat100:0.6, fiber100:1.4, category:'Cereais e Gr√£os' },
      { id:'f28', name:'Macarr√£o comum', nameLower:'macarr√£o comum', unitBase:'g', kcal100:158, prot100:5.8, carb100:30.7, fat100:0.9, fiber100:1.8, category:'Cereais e Gr√£os' },
      { id:'f29', name:'Macarr√£o integral', nameLower:'macarr√£o integral', unitBase:'g', kcal100:149, prot100:6.3, carb100:31.0, fat100:1.2, fiber100:3.8, category:'Cereais e Gr√£os' },
      { id:'f30', name:'Macarr√£o de arroz', nameLower:'macarr√£o de arroz', unitBase:'g', kcal100:109, prot100:1.8, carb100:25.0, fat100:0.2, fiber100:0.9, category:'Cereais e Gr√£os' },
      { id:'f31', name:'Macarr√£o de gr√£o-de-bico', nameLower:'macarr√£o de gr√£o-de-bico', unitBase:'g', kcal100:157, prot100:8.0, carb100:27.0, fat100:3.0, fiber100:5.0, category:'Cereais e Gr√£os' },

      // Leguminosas
      { id:'f32', name:'Feij√£o carioca', nameLower:'feij√£o carioca', unitBase:'g', kcal100:77, prot100:4.8, carb100:14.0, fat100:0.5, fiber100:7.6, category:'Leguminosas' },
      { id:'f33', name:'Feij√£o preto', nameLower:'feij√£o preto', unitBase:'g', kcal100:91, prot100:6.0, carb100:16.0, fat100:0.5, fiber100:8.7, category:'Leguminosas' },
      { id:'f34', name:'Feij√£o branco', nameLower:'feij√£o branco', unitBase:'g', kcal100:114, prot100:7.3, carb100:20.0, fat100:0.5, fiber100:6.3, category:'Leguminosas' },
      { id:'f35', name:'Feij√£o fradinho', nameLower:'feij√£o fradinho', unitBase:'g', kcal100:116, prot100:8.0, carb100:20.0, fat100:0.5, fiber100:6.5, category:'Leguminosas' },
      { id:'f36', name:'Lentilha', nameLower:'lentilha', unitBase:'g', kcal100:116, prot100:9.0, carb100:20.1, fat100:0.4, fiber100:7.9, category:'Leguminosas' },
      { id:'f37', name:'Gr√£o-de-bico', nameLower:'gr√£o-de-bico', unitBase:'g', kcal100:164, prot100:8.9, carb100:27.4, fat100:2.6, fiber100:7.6, category:'Leguminosas' },
      { id:'f38', name:'Ervilha seca', nameLower:'ervilha seca', unitBase:'g', kcal100:81, prot100:5.4, carb100:14.5, fat100:0.4, fiber100:5.5, category:'Leguminosas' },
      { id:'f39', name:'Soja cozida', nameLower:'soja cozida', unitBase:'g', kcal100:173, prot100:18.2, carb100:9.9, fat100:9.0, fiber100:6.0, category:'Leguminosas' },
      { id:'f40', name:'Tofu firme', nameLower:'tofu firme', unitBase:'g', kcal100:76, prot100:8.0, carb100:1.9, fat100:4.8, fiber100:0.3, category:'Leguminosas' },
      { id:'f41', name:'Tofu macio', nameLower:'tofu macio', unitBase:'g', kcal100:55, prot100:5.3, carb100:1.5, fat100:3.0, fiber100:0.2, category:'Leguminosas' },
      { id:'f42', name:'Tempeh', nameLower:'tempeh', unitBase:'g', kcal100:193, prot100:20.3, carb100:9.4, fat100:10.8, fiber100:1.4, category:'Leguminosas' },

      // Carnes e Ovos
      { id:'f43', name:'Peito de frango', nameLower:'peito de frango', unitBase:'g', kcal100:165, prot100:31.0, carb100:0, fat100:3.6, fiber100:0, category:'Carnes e Ovos' },
      { id:'f44', name:'Coxa de frango', nameLower:'coxa de frango', unitBase:'g', kcal100:214, prot100:26.0, carb100:0, fat100:12.0, fiber100:0, category:'Carnes e Ovos' },
      { id:'f45', name:'Sobrecoxa de frango', nameLower:'sobrecoxa de frango', unitBase:'g', kcal100:229, prot100:25.0, carb100:0, fat100:14.0, fiber100:0, category:'Carnes e Ovos' },
      { id:'f46', name:'Fil√© de frango grelhado', nameLower:'fil√© de frango grelhado', unitBase:'g', kcal100:165, prot100:31.0, carb100:0, fat100:3.6, fiber100:0, category:'Carnes e Ovos' },
      { id:'f47', name:'Carne mo√≠da bovina', nameLower:'carne mo√≠da bovina', unitBase:'g', kcal100:250, prot100:26.0, carb100:0, fat100:17.0, fiber100:0, category:'Carnes e Ovos' },
      { id:'f48', name:'Patinho bovino', nameLower:'patinho bovino', unitBase:'g', kcal100:158, prot100:26.0, carb100:0, fat100:6.0, fiber100:0, category:'Carnes e Ovos' },
      { id:'f49', name:'Alcatra bovina', nameLower:'alcatra bovina', unitBase:'g', kcal100:195, prot100:29.0, carb100:0, fat100:8.0, fiber100:0, category:'Carnes e Ovos' },
      { id:'f50', name:'Maminha bovina', nameLower:'maminha bovina', unitBase:'g', kcal100:215, prot100:26.0, carb100:0, fat100:12.0, fiber100:0, category:'Carnes e Ovos' },
      { id:'f51', name:'Contra fil√© bovino', nameLower:'contra fil√© bovino', unitBase:'g', kcal100:242, prot100:28.0, carb100:0, fat100:14.0, fiber100:0, category:'Carnes e Ovos' },
      { id:'f52', name:'Fil√© mignon bovino', nameLower:'fil√© mignon bovino', unitBase:'g', kcal100:194, prot100:29.0, carb100:0, fat100:8.0, fiber100:0, category:'Carnes e Ovos' },
      { id:'f53', name:'Costela bovina', nameLower:'costela bovina', unitBase:'g', kcal100:315, prot100:24.0, carb100:0, fat100:24.0, fiber100:0, category:'Carnes e Ovos' },
      { id:'f54', name:'Lombo su√≠no', nameLower:'lombo su√≠no', unitBase:'g', kcal100:242, prot100:27.0, carb100:0, fat100:14.0, fiber100:0, category:'Carnes e Ovos' },
      { id:'f55', name:'Pernil su√≠no', nameLower:'pernil su√≠no', unitBase:'g', kcal100:259, prot100:25.0, carb100:0, fat100:17.0, fiber100:0, category:'Carnes e Ovos' },
      { id:'f56', name:'Lingui√ßa su√≠na', nameLower:'lingui√ßa su√≠na', unitBase:'g', kcal100:301, prot100:12.0, carb100:2.0, fat100:27.0, fiber100:0, category:'Carnes e Ovos' },
      { id:'f57', name:'Ovos inteiros', nameLower:'ovos inteiros', unitBase:'g', kcal100:143, prot100:12.6, carb100:0.7, fat100:9.5, fiber100:0, category:'Carnes e Ovos', unitMap:{un:50} },
      { id:'f58', name:'Clara de ovo', nameLower:'clara de ovo', unitBase:'g', kcal100:52, prot100:10.9, carb100:0.7, fat100:0.2, fiber100:0, category:'Carnes e Ovos', unitMap:{un:33} },
      { id:'f59', name:'Ovo cozido', nameLower:'ovo cozido', unitBase:'g', kcal100:155, prot100:13.0, carb100:1.1, fat100:11.0, fiber100:0, category:'Carnes e Ovos', unitMap:{un:50} },
      { id:'f60', name:'Ovo mexido', nameLower:'ovo mexido', unitBase:'g', kcal100:200, prot100:13.0, carb100:1.5, fat100:15.0, fiber100:0, category:'Carnes e Ovos' },
      { id:'f61', name:'Ovo frito', nameLower:'ovo frito', unitBase:'g', kcal100:240, prot100:14.0, carb100:1.2, fat100:19.0, fiber100:0, category:'Carnes e Ovos' },

      // Peixes e Frutos do Mar
      { id:'f62', name:'Salm√£o grelhado', nameLower:'salm√£o grelhado', unitBase:'g', kcal100:208, prot100:20.0, carb100:0, fat100:13.0, fiber100:0, category:'Peixes e Frutos do Mar' },
      { id:'f63', name:'Til√°pia grelhada', nameLower:'til√°pia grelhada', unitBase:'g', kcal100:129, prot100:26.0, carb100:0, fat100:2.7, fiber100:0, category:'Peixes e Frutos do Mar' },
      { id:'f64', name:'Sardinha em lata', nameLower:'sardinha em lata', unitBase:'g', kcal100:208, prot100:24.6, carb100:0, fat100:11.5, fiber100:0, category:'Peixes e Frutos do Mar' },
      { id:'f65', name:'Atum em lata', nameLower:'atum em lata', unitBase:'g', kcal100:132, prot100:28.0, carb100:0, fat100:1.0, fiber100:0, category:'Peixes e Frutos do Mar' },
      { id:'f66', name:'Atum fresco', nameLower:'atum fresco', unitBase:'g', kcal100:144, prot100:23.3, carb100:0, fat100:4.9, fiber100:0, category:'Peixes e Frutos do Mar' },
      { id:'f67', name:'Bacalhau dessalgado', nameLower:'bacalhau dessalgado', unitBase:'g', kcal100:131, prot100:28.0, carb100:0, fat100:1.3, fiber100:0, category:'Peixes e Frutos do Mar' },
      { id:'f68', name:'Camar√£o grelhado', nameLower:'camar√£o grelhado', unitBase:'g', kcal100:99, prot100:24.0, carb100:0.2, fat100:0.3, fiber100:0, category:'Peixes e Frutos do Mar' },
      { id:'f69', name:'Lula cozida', nameLower:'lula cozida', unitBase:'g', kcal100:175, prot100:18.0, carb100:7.0, fat100:8.0, fiber100:0, category:'Peixes e Frutos do Mar' },

      // Latic√≠nios e Derivados
      { id:'f70', name:'Leite integral', nameLower:'leite integral', unitBase:'ml', kcal100:61, prot100:3.2, carb100:4.8, fat100:3.3, fiber100:0, category:'Latic√≠nios e Derivados' },
      { id:'f71', name:'Leite desnatado', nameLower:'leite desnatado', unitBase:'ml', kcal100:34, prot100:3.4, carb100:5.0, fat100:0.1, fiber100:0, category:'Latic√≠nios e Derivados' },
      { id:'f72', name:'Leite semidesnatado', nameLower:'leite semidesnatado', unitBase:'ml', kcal100:47, prot100:3.4, carb100:4.9, fat100:1.6, fiber100:0, category:'Latic√≠nios e Derivados' },
      { id:'f73', name:'Leite vegetal de am√™ndoas', nameLower:'leite vegetal de am√™ndoas', unitBase:'ml', kcal100:17, prot100:0.6, carb100:0.6, fat100:1.5, fiber100:0.2, category:'Latic√≠nios e Derivados' },
      { id:'f74', name:'Leite vegetal de aveia', nameLower:'leite vegetal de aveia', unitBase:'ml', kcal100:43, prot100:1.0, carb100:6.7, fat100:1.4, fiber100:0.8, category:'Latic√≠nios e Derivados' },
      { id:'f75', name:'Leite vegetal de soja', nameLower:'leite vegetal de soja', unitBase:'ml', kcal100:54, prot100:3.3, carb100:6.3, fat100:1.8, fiber100:0.6, category:'Latic√≠nios e Derivados' },
      { id:'f76', name:'Iogurte natural', nameLower:'iogurte natural', unitBase:'g', kcal100:61, prot100:3.5, carb100:4.7, fat100:3.3, fiber100:0, category:'Latic√≠nios e Derivados' },
      { id:'f77', name:'Iogurte desnatado', nameLower:'iogurte desnatado', unitBase:'g', kcal100:41, prot100:4.3, carb100:4.9, fat100:0.2, fiber100:0, category:'Latic√≠nios e Derivados' },
      { id:'f78', name:'Iogurte grego tradicional', nameLower:'iogurte grego tradicional', unitBase:'g', kcal100:120, prot100:8.7, carb100:4.0, fat100:8.0, fiber100:0, category:'Latic√≠nios e Derivados' },
      { id:'f79', name:'Iogurte grego light', nameLower:'iogurte grego light', unitBase:'g', kcal100:73, prot100:8.5, carb100:3.8, fat100:2.2, fiber100:0, category:'Latic√≠nios e Derivados' },
      { id:'f80', name:'Queijo mu√ßarela', nameLower:'queijo mu√ßarela', unitBase:'g', kcal100:280, prot100:22.0, carb100:2.0, fat100:21.0, fiber100:0, category:'Latic√≠nios e Derivados' },
      { id:'f81', name:'Queijo minas frescal', nameLower:'queijo minas frescal', unitBase:'g', kcal100:264, prot100:18.6, carb100:3.2, fat100:20.2, fiber100:0, category:'Latic√≠nios e Derivados' },
      { id:'f82', name:'Queijo cottage', nameLower:'queijo cottage', unitBase:'g', kcal100:98, prot100:11.1, carb100:3.4, fat100:4.3, fiber100:0, category:'Latic√≠nios e Derivados' },
      { id:'f83', name:'Queijo ricota', nameLower:'queijo ricota', unitBase:'g', kcal100:174, prot100:11.3, carb100:3.0, fat100:13.0, fiber100:0, category:'Latic√≠nios e Derivados' },
      { id:'f84', name:'Requeij√£o light', nameLower:'requeij√£o light', unitBase:'g', kcal100:160, prot100:9.0, carb100:3.5, fat100:12.0, fiber100:0, category:'Latic√≠nios e Derivados' },

      // Vegetais e Legumes
      { id:'f85', name:'Alface', nameLower:'alface', unitBase:'g', kcal100:15, prot100:1.4, carb100:2.9, fat100:0.2, fiber100:1.3, category:'Vegetais e Legumes' },
      { id:'f86', name:'R√∫cula', nameLower:'r√∫cula', unitBase:'g', kcal100:25, prot100:2.6, carb100:3.7, fat100:0.7, fiber100:1.6, category:'Vegetais e Legumes' },
      { id:'f87', name:'Espinafre', nameLower:'espinafre', unitBase:'g', kcal100:23, prot100:2.9, carb100:3.6, fat100:0.4, fiber100:2.2, category:'Vegetais e Legumes' },
      { id:'f88', name:'Couve', nameLower:'couve', unitBase:'g', kcal100:49, prot100:4.3, carb100:9.0, fat100:0.9, fiber100:3.6, category:'Vegetais e Legumes' },
      { id:'f89', name:'Br√≥colis', nameLower:'br√≥colis', unitBase:'g', kcal100:35, prot100:2.4, carb100:7.2, fat100:0.4, fiber100:3.3, category:'Vegetais e Legumes' },
      { id:'f90', name:'Couve-flor', nameLower:'couve-flor', unitBase:'g', kcal100:25, prot100:2.0, carb100:5.0, fat100:0.3, fiber100:2.0, category:'Vegetais e Legumes' },
      { id:'f91', name:'Abobrinha', nameLower:'abobrinha', unitBase:'g', kcal100:17, prot100:1.2, carb100:3.1, fat100:0.3, fiber100:1.0, category:'Vegetais e Legumes' },
      { id:'f92', name:'Ab√≥bora', nameLower:'ab√≥bora', unitBase:'g', kcal100:26, prot100:1.0, carb100:6.5, fat100:0.1, fiber100:0.5, category:'Vegetais e Legumes' },
      { id:'f93', name:'Cenoura', nameLower:'cenoura', unitBase:'g', kcal100:41, prot100:0.9, carb100:9.6, fat100:0.2, fiber100:2.8, category:'Vegetais e Legumes' },
      { id:'f94', name:'Beterraba', nameLower:'beterraba', unitBase:'g', kcal100:43, prot100:1.6, carb100:10.0, fat100:0.2, fiber100:2.8, category:'Vegetais e Legumes' },
      { id:'f95', name:'Pepino', nameLower:'pepino', unitBase:'g', kcal100:16, prot100:0.7, carb100:3.6, fat100:0.1, fiber100:0.5, category:'Vegetais e Legumes' },
      { id:'f96', name:'Tomate', nameLower:'tomate', unitBase:'g', kcal100:18, prot100:0.9, carb100:3.9, fat100:0.2, fiber100:1.2, category:'Vegetais e Legumes' },
      { id:'f97', name:'Piment√£o vermelho', nameLower:'piment√£o vermelho', unitBase:'g', kcal100:31, prot100:1.0, carb100:6.0, fat100:0.3, fiber100:2.1, category:'Vegetais e Legumes' },
      { id:'f98', name:'Piment√£o verde', nameLower:'piment√£o verde', unitBase:'g', kcal100:20, prot100:0.9, carb100:4.6, fat100:0.2, fiber100:1.7, category:'Vegetais e Legumes' },
      { id:'f99', name:'Berinjela', nameLower:'berinjela', unitBase:'g', kcal100:25, prot100:1.0, carb100:5.9, fat100:0.2, fiber100:3.0, category:'Vegetais e Legumes' },
      { id:'f100', name:'Vagem', nameLower:'vagem', unitBase:'g', kcal100:31, prot100:1.8, carb100:7.1, fat100:0.1, fiber100:3.4, category:'Vegetais e Legumes' },
      { id:'f101', name:'Chuchu', nameLower:'chuchu', unitBase:'g', kcal100:19, prot100:0.8, carb100:4.5, fat100:0.2, fiber100:1.7, category:'Vegetais e Legumes' },
      { id:'f102', name:'Palmito', nameLower:'palmito', unitBase:'g', kcal100:29, prot100:2.7, carb100:6.2, fat100:0.4, fiber100:3.6, category:'Vegetais e Legumes' },
      { id:'f103', name:'Aspargos', nameLower:'aspargos', unitBase:'g', kcal100:20, prot100:2.2, carb100:3.9, fat100:0.1, fiber100:2.1, category:'Vegetais e Legumes' },

      // Frutas
      { id:'f104', name:'Banana prata', nameLower:'banana prata', unitBase:'g', kcal100:89, prot100:1.1, carb100:23.0, fat100:0.3, fiber100:2.6, category:'Frutas', unitMap:{un:80} },
      { id:'f105', name:'Banana nanica', nameLower:'banana nanica', unitBase:'g', kcal100:96, prot100:1.2, carb100:25.0, fat100:0.3, fiber100:2.6, category:'Frutas', unitMap:{un:90} },
      { id:'f106', name:'Ma√ß√£ vermelha', nameLower:'ma√ß√£ vermelha', unitBase:'g', kcal100:52, prot100:0.3, carb100:14.0, fat100:0.2, fiber100:2.4, category:'Frutas', unitMap:{un:130} },
      { id:'f107', name:'Ma√ß√£ verde', nameLower:'ma√ß√£ verde', unitBase:'g', kcal100:52, prot100:0.3, carb100:14.0, fat100:0.2, fiber100:2.4, category:'Frutas', unitMap:{un:130} },
      { id:'f108', name:'Laranja pera', nameLower:'laranja pera', unitBase:'g', kcal100:47, prot100:0.9, carb100:12.0, fat100:0.1, fiber100:2.4, category:'Frutas', unitMap:{un:150} },
      { id:'f109', name:'Laranja lima', nameLower:'laranja lima', unitBase:'g', kcal100:43, prot100:0.8, carb100:11.0, fat100:0.2, fiber100:2.0, category:'Frutas', unitMap:{un:150} },
      { id:'f110', name:'Manga', nameLower:'manga', unitBase:'g', kcal100:60, prot100:0.8, carb100:15.0, fat100:0.4, fiber100:1.6, category:'Frutas', unitMap:{un:200} },
      { id:'f111', name:'Mam√£o formosa', nameLower:'mam√£o formosa', unitBase:'g', kcal100:43, prot100:0.5, carb100:11.0, fat100:0.3, fiber100:1.7, category:'Frutas' },
      { id:'f112', name:'Mam√£o papaia', nameLower:'mam√£o papaia', unitBase:'g', kcal100:43, prot100:0.5, carb100:11.0, fat100:0.3, fiber100:1.7, category:'Frutas' },
      { id:'f113', name:'Melancia', nameLower:'melancia', unitBase:'g', kcal100:30, prot100:0.6, carb100:8.0, fat100:0.2, fiber100:0.4, category:'Frutas' },
      { id:'f114', name:'Mel√£o', nameLower:'mel√£o', unitBase:'g', kcal100:34, prot100:0.8, carb100:8.2, fat100:0.2, fiber100:0.9, category:'Frutas' },
      { id:'f115', name:'Abacaxi', nameLower:'abacaxi', unitBase:'g', kcal100:50, prot100:0.5, carb100:13.1, fat100:0.1, fiber100:1.4, category:'Frutas' },
      { id:'f116', name:'Kiwi', nameLower:'kiwi', unitBase:'g', kcal100:61, prot100:1.1, carb100:15.0, fat100:0.5, fiber100:3.0, category:'Frutas' },
      { id:'f117', name:'Morango', nameLower:'morango', unitBase:'g', kcal100:32, prot100:0.7, carb100:7.7, fat100:0.3, fiber100:2.0, category:'Frutas' },
      { id:'f118', name:'Uva roxa', nameLower:'uva roxa', unitBase:'g', kcal100:69, prot100:0.7, carb100:18.0, fat100:0.2, fiber100:0.9, category:'Frutas' },
      { id:'f119', name:'Uva verde', nameLower:'uva verde', unitBase:'g', kcal100:69, prot100:0.7, carb100:18.0, fat100:0.2, fiber100:0.9, category:'Frutas' },
      { id:'f120', name:'P√™ssego', nameLower:'p√™ssego', unitBase:'g', kcal100:39, prot100:0.9, carb100:9.5, fat100:0.3, fiber100:1.5, category:'Frutas' },
      { id:'f121', name:'Ameixa', nameLower:'ameixa', unitBase:'g', kcal100:46, prot100:0.7, carb100:11.4, fat100:0.3, fiber100:1.4, category:'Frutas' },
      { id:'f122', name:'Lim√£o tahiti', nameLower:'lim√£o tahiti', unitBase:'g', kcal100:29, prot100:1.1, carb100:9.3, fat100:0.3, fiber100:2.8, category:'Frutas' },

      // Oleaginosas e Sementes
      { id:'f123', name:'Castanha-do-par√°', nameLower:'castanha-do-par√°', unitBase:'g', kcal100:656, prot100:14.3, carb100:12.3, fat100:66.4, fiber100:7.5, category:'Oleaginosas e Sementes' },
      { id:'f124', name:'Castanha-de-caju', nameLower:'castanha-de-caju', unitBase:'g', kcal100:553, prot100:18.2, carb100:30.2, fat100:43.9, fiber100:3.3, category:'Oleaginosas e Sementes' },
      { id:'f125', name:'Nozes', nameLower:'nozes', unitBase:'g', kcal100:654, prot100:15.2, carb100:13.7, fat100:65.2, fiber100:6.7, category:'Oleaginosas e Sementes' },
      { id:'f126', name:'Am√™ndoas', nameLower:'am√™ndoas', unitBase:'g', kcal100:579, prot100:21.2, carb100:21.6, fat100:49.9, fiber100:12.5, category:'Oleaginosas e Sementes' },
      { id:'f127', name:'Pistache', nameLower:'pistache', unitBase:'g', kcal100:562, prot100:20.0, carb100:28.0, fat100:45.0, fiber100:10.3, category:'Oleaginosas e Sementes' },
      { id:'f128', name:'Semente de chia', nameLower:'semente de chia', unitBase:'g', kcal100:486, prot100:16.5, carb100:42.1, fat100:30.7, fiber100:34.4, category:'Oleaginosas e Sementes' },
      { id:'f129', name:'Semente de linha√ßa', nameLower:'semente de linha√ßa', unitBase:'g', kcal100:534, prot100:18.3, carb100:28.9, fat100:42.2, fiber100:27.3, category:'Oleaginosas e Sementes' },
      { id:'f130', name:'Semente de girassol', nameLower:'semente de girassol', unitBase:'g', kcal100:584, prot100:20.8, carb100:20.0, fat100:51.5, fiber100:8.6, category:'Oleaginosas e Sementes' },
      { id:'f131', name:'Pasta de amendoim', nameLower:'pasta de amendoim', unitBase:'g', kcal100:588, prot100:25.0, carb100:20.0, fat100:50.0, fiber100:6.0, category:'Oleaginosas e Sementes' },
      { id:'f132', name:'Pasta de castanha', nameLower:'pasta de castanha', unitBase:'g', kcal100:620, prot100:14.0, carb100:20.0, fat100:54.0, fiber100:7.0, category:'Oleaginosas e Sementes' },

      // Gorduras e √ìleos
      { id:'f133', name:'Azeite de oliva', nameLower:'azeite de oliva', unitBase:'g', kcal100:884, prot100:0, carb100:0, fat100:100.0, fiber100:0, category:'Gorduras e √ìleos' },
      { id:'f134', name:'√ìleo de coco', nameLower:'√≥leo de coco', unitBase:'g', kcal100:892, prot100:0, carb100:0, fat100:100.0, fiber100:0, category:'Gorduras e √ìleos' },
      { id:'f135', name:'√ìleo de girassol', nameLower:'√≥leo de girassol', unitBase:'g', kcal100:884, prot100:0, carb100:0, fat100:100.0, fiber100:0, category:'Gorduras e √ìleos' },
      { id:'f136', name:'√ìleo de soja', nameLower:'√≥leo de soja', unitBase:'g', kcal100:884, prot100:0, carb100:0, fat100:100.0, fiber100:0, category:'Gorduras e √ìleos' },
      { id:'f137', name:'Manteiga', nameLower:'manteiga', unitBase:'g', kcal100:717, prot100:0.9, carb100:0.1, fat100:81.1, fiber100:0, category:'Gorduras e √ìleos' },
      { id:'f138', name:'Margarina light', nameLower:'margarina light', unitBase:'g', kcal100:360, prot100:0.5, carb100:0.5, fat100:40.0, fiber100:0, category:'Gorduras e √ìleos' },
      { id:'f139', name:'Creme de leite', nameLower:'creme de leite', unitBase:'g', kcal100:340, prot100:2.0, carb100:3.0, fat100:36.0, fiber100:0, category:'Gorduras e √ìleos' },
      { id:'f140', name:'Leite de coco', nameLower:'leite de coco', unitBase:'ml', kcal100:230, prot100:2.3, carb100:3.4, fat100:24.0, fiber100:0, category:'Gorduras e √ìleos' }
    ];
    
    // Tornar builtinFoods acess√≠vel globalmente IMEDIATAMENTE
    window.builtinFoods = builtinFoods;
    console.log('‚úÖ builtinFoods inicializado com', builtinFoods.length, 'alimentos');
    console.log('‚úÖ window.builtinFoods definido. Total:', window.builtinFoods.length);
    
    // ‚ö†Ô∏è C√ìDIGO DO DB.JS DESABILITADO - USANDO APENAS OS 140 ALIMENTOS ACIMA
    /*
    // Carregar alimentos do db.js quando dispon√≠vel
    console.log('üîß Registrando listener NutriDB:ready...');
    window.addEventListener('NutriDB:ready', async function() {
      console.log('‚úÖ NutriDB:ready evento recebido!');
      try {
        console.log('window.NutriDB dispon√≠vel?', !!window.NutriDB);
        // Primeiro, popula o banco com o SEED se necess√°rio
        const result = await window.NutriDB.seedCompletarBase();
        console.log('‚úÖ Seed completo:', result);
        
        // Carrega todos os alimentos do banco
        const dbFoods = await window.NutriDB.listFoods();
        console.log('‚úÖ Alimentos carregados do banco:', dbFoods.length);
        
        // Converte formato do db.js para formato do app
        builtinFoods = dbFoods.map(f => ({
          id: 'db_' + f.id,
          name: f.name,
          nameLower: (f.nameCI || f.name.toLowerCase()),
          unitBase: f.baseUnit || 'g',
          kcal100: Math.round((f.kcal / (f.baseAmount || 100)) * 100),
          prot100: Math.round((f.prot / (f.baseAmount || 100)) * 100 * 10) / 10,
          carb100: Math.round((f.carb / (f.baseAmount || 100)) * 100 * 10) / 10,
          fat100: Math.round((f.fat / (f.baseAmount || 100)) * 100 * 10) / 10,
          fiber100: Math.round((f.fiber / (f.baseAmount || 100)) * 100 * 10) / 10,
          category: f.category
        }));
        
        console.log('‚úÖ builtinFoods atualizado com', builtinFoods.length, 'alimentos');
        
        // Atualizar refer√™ncia global
        window.builtinFoods = builtinFoods;
        
        // Atualizar contador
        updateAlimentosCounter();
        
        // Atualiza a lista de alimentos na tela se estiver vis√≠vel
        const alimentosTab = document.getElementById('alimentos-tab');
        if (alimentosTab && !alimentosTab.classList.contains('hidden')) {
          console.log('Renderizando lista de alimentos...');
          const listWrapper = document.getElementById('alimentosListWrapper');
          if (listWrapper && !listWrapper.classList.contains('hidden')) {
            renderAllFoodList();
          }
        }
      } catch (error) {
        console.error('‚ùå Erro ao carregar alimentos do banco:', error);
      }
    });
    
    // Fallback: tentar carregar ap√≥s 2 segundos se ainda n√£o carregou
    setTimeout(() => {
      console.log('‚è∞ Timeout 2s - Verificando estado...');
      console.log('  window.NutriDB:', !!window.NutriDB);
      console.log('  builtinFoods.length:', builtinFoods.length);
      
      if (window.NutriDB && builtinFoods.length <= 5) {
        console.log('‚è∞ Disparando NutriDB:ready manualmente...');
        window.dispatchEvent(new Event('NutriDB:ready'));
      } else if (!window.NutriDB) {
        console.warn('‚ö†Ô∏è NutriDB n√£o dispon√≠vel ap√≥s 2s. Verifique se db.js e Dexie foram carregados.');
        console.warn('   Usando apenas', builtinFoods.length, 'alimentos b√°sicos');
      } else {
        console.log('‚úÖ Alimentos j√° carregados:', builtinFoods.length);
      }
      
      // For√ßar atualiza√ß√£o do contador ap√≥s timeout
      updateAlimentosCounter();
    }, 2000);
    */ // FIM DO C√ìDIGO DB.JS DESABILITADO
    
    function allFoods(){ 
      console.log('üîç allFoods() chamado');
      console.log('  üì¶ builtinFoods:', builtinFoods ? builtinFoods.length : 'undefined');
      console.log('  üì¶ state.customFoods:', state?.customFoods ? state.customFoods.length : 'undefined');
      
      if (!builtinFoods) {
        console.error('‚ùå builtinFoods est√° undefined!');
        return [];
      }
      
      if (!state || !state.customFoods) {
        console.warn('‚ö†Ô∏è state.customFoods n√£o existe, usando apenas builtin');
        return [...builtinFoods];
      }
      
      const foods = builtinFoods.concat(state.customFoods);
      console.log('‚úÖ Total de alimentos:', foods.length);
      return foods;
    }

    /* Init */
    function initializeApp() {
      // Definir data atual usando formato local
      const today = getTodayStringLocal('YYYY-MM-DD');
      if (dateInput) {
        dateInput.value = today;
      }
      
      // Garantir que selectedDate seja hoje na inicializa√ß√£o
      state.selectedDate = today;
      saveState(state);
      
      console.log('Data inicializada:', today);
      
      // Atualizar displays
      if (dateInput) bindDay(dateInput.value);
      updateSelectedMealDisplay();
      
      // Carregar prefer√™ncias de dashboard
      loadDashboardPreferences();
      
      updateHomeDashboard();
      
      // Atualizar contador de alimentos (usa builtinFoods inicial)
      updateAlimentosCounter();
      
      // Inicializar modal de novo alimento
      initNewFoodModal();
      
      // Event listener para mudan√ßa de data
      if (dateInput) {
        dateInput.addEventListener('change',()=>{
          // Atualizar selectedDate quando usu√°rio mudar a data
          state.selectedDate = dateInput.value;
          saveState(state);
          bindDay(dateInput.value);
          updateHomeDashboard();
        });
      }
    }
    
    // Chamar inicializa√ß√£o quando DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
    foodSearch.addEventListener('input', onSearchFoods);
    
    // Adicionar eventos para melhorar a sele√ß√£o de alimentos
    foodSearch.addEventListener('keydown', (e) => {
      const isListVisible = !foodList.classList.contains('hidden');
      const listLength = window.currentFoodList ? window.currentFoodList.length : 0;
      
      // Fechar dropdown ao pressionar Escape
      if (e.key === 'Escape') {
        foodList.classList.add('hidden');
        selectedFood = null;
        highlightedIndex = -1;
        updatePreview();
        return;
      }
      
      if (isListVisible && listLength > 0) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          highlightedIndex = Math.min(highlightedIndex + 1, listLength - 1);
          updateHighlight();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          highlightedIndex = Math.max(highlightedIndex - 1, 0);
          updateHighlight();
        } else if (e.key === 'Enter' && highlightedIndex >= 0) {
          e.preventDefault();
          selectFood(window.currentFoodList[highlightedIndex]);
        }
      }
    });
    
    // Fechar lista quando clica fora (usar setTimeout para permitir clique nos itens)
    foodSearch.addEventListener('blur', () => {
      setTimeout(() => {
        if (!foodList.matches(':hover')) {
          foodList.classList.add('hidden');
        }
      }, 150);
    });
    
    // Reabrir lista quando foca no input (se h√° texto)
    foodSearch.addEventListener('focus', () => {
      if (foodSearch.value.trim()) {
        onSearchFoods();
      }
    });
    
    // Fechar dropdown ao clicar fora (handler global)
    document.addEventListener('click', (e) => {
      if (foodList && !foodList.classList.contains('hidden')) {
        const clickedInsideSearch = foodSearch && foodSearch.contains(e.target);
        const clickedInsideList = foodList.contains(e.target);
        
        if (!clickedInsideSearch && !clickedInsideList) {
          foodList.classList.add('hidden');
        }
      }
    });
    
    qtyInput.addEventListener('input', updatePreview);
    unitSelect.addEventListener('change', ()=>{ handleUnitChange(); updatePreview(); });
    mealSelect.addEventListener('change', ()=>{ 
      bindDay(dateInput.value); 
      updateSelectedMealDisplay();
    });
    
    // Fun√ß√£o para atualizar o display da refei√ß√£o selecionada
    function updateSelectedMealDisplay() {
      const selectedMealDisplay = document.getElementById('selectedMealDisplay');
      if (selectedMealDisplay && mealSelect) {
        const mealValue = mealSelect.value;
        const mealName = getMealName(mealValue);
        selectedMealDisplay.textContent = mealName;
      }
    }
    btnSaveGpu.addEventListener('click', ()=>{
      if(!selectedFood) return;
      const v=Number(inpGpu.value);
      if(!v||v<=0){alert('Informe um valor v√°lido em gramas.');return;}
      state.overrides[selectedFood.id]={...(state.overrides[selectedFood.id]||{}), gramsPerUnit:v};
      saveState(state); showUnTools(); updatePreview();
    });
    btnClearGpu.addEventListener('click', ()=>{
      if(!selectedFood) return;
      if(state.overrides[selectedFood.id]) delete state.overrides[selectedFood.id].gramsPerUnit;
      saveState(state); inpGpu.value=''; showUnTools(); updatePreview();
    });
    vmCancel.addEventListener('click', closeVariantModal);
    vmSave.addEventListener('click', saveVariant);
    
    
    // Salvar refei√ß√£o
    saveMealBtn.addEventListener('click', saveMeal);
    
    // Aba Alimentos (handlers movidos para se√ß√£o do novo modal)
    btnExibirLista.addEventListener('click', exibirListaAlimentos);
    btnOcultarLista.addEventListener('click', ocultarListaAlimentos);
    searchAlimentos.addEventListener('input', filterAlimentos);
    btnEditarAlimento.addEventListener('click', editSelectedAlimento);
    btnExcluirAlimento.addEventListener('click', deleteSelectedAlimento);
    
    // Aba Relat√≥rios
    btnPorPeriodo.addEventListener('click', () => setTipoRelatorio('periodo'));
    btnPorDia.addEventListener('click', () => setTipoRelatorio('dia'));
    btnGerarRelatorio.addEventListener('click', gerarRelatorio);

    /* Dia / Totais */
    function bindDay(d){
      // Garantir que state.entries existe
      if (!state.entries) state.entries = {};
      const items=state.entries[d]||[];
      renderItems(items); recalcTotals(items);
    }
    function renderItems(items){
      itemsList.innerHTML='';
      const currentMeal = mealSelect.value;
      
      // Filtrar apenas itens da refei√ß√£o atual
      const currentMealItems = items.filter(item => item.meal === currentMeal);
      
      if (currentMealItems.length === 0) {
        const li = document.createElement('li');
        li.className = 'p-4 text-center text-slate-400';
        li.innerHTML = `
          <div class="py-8">
            <div class="text-4xl mb-2">üçΩÔ∏è</div>
            <div>Nenhum alimento adicionado</div>
            <div class="text-xs mt-1">para ${getMealName(currentMeal)}</div>
          </div>
        `;
        itemsList.appendChild(li);
        return;
      }
      
      currentMealItems.forEach(item=>{
        const li=document.createElement('li');
        li.className='p-3 flex items-center justify-between hover:bg-white/5 rounded-xl transition-colors';
        li.innerHTML=`
          <div class="flex-1">
            <div class="font-medium text-sm">${item.foodName}</div>
            <div class="text-xs text-slate-400">${item.qty}${item.unit} ‚Ä¢ ${Math.round(item.kcal)} kcal</div>
            <div class="text-[10px] text-slate-500">P ${r1(item.prot)}g ‚Ä¢ C ${r1(item.carb)}g ‚Ä¢ G ${r1(item.fat)}g ‚Ä¢ F ${r1(item.fiber)}g</div>
          </div>
          <button class="text-sm px-3 py-1.5 rounded-lg chip hover:opacity-90 text-red-400 hover:bg-red-500/20 transition-colors">
            üóëÔ∏è
          </button>`;
        li.querySelector('button').addEventListener('click',()=>deleteItem(item.id));
        itemsList.appendChild(li);
      });
    }
    function recalcTotals(items){
      // Calcular totais mas n√£o atualizar elementos inexistentes
      const t=items.reduce((a,i)=>({kcal:a.kcal+(i.kcal||0),prot:a.prot+(i.prot||0),carb:a.carb+(i.carb||0),fat:a.fat+(i.fat||0),fiber:a.fiber+(i.fiber||0)}),{kcal:0,prot:0,carb:0,fat:0,fiber:0});
      
      // Atualizar dashboard home se estiver na home
      if (currentTab === 'home' || currentTab === 'lancamentos') {
        updateHomeDashboard();
      }
    }

    /* Preview */
    function updatePreview(){
      if(!selectedFood || !qtyInput.value || Number(qtyInput.value) <= 0){
        calcPreview.textContent = '‚Äî';
        return;
      }
      
      const qty = Number(qtyInput.value);
      const unit = unitSelect.value;
      
      if(unit === 'un' && !getGpu(selectedFood)){
        calcPreview.textContent = 'Informe gramas por unidade';
        return;
      }
      
      if(unit !== 'un' && unit !== selectedFood.unitBase){
        calcPreview.textContent = `Cadastre variante em ${unit.toUpperCase()}`;
        return;
      }
      
      let factor100 = (unit === 'un') ? (qty * getGpu(selectedFood)) / 100 : qty / 100;
      const kcal = Math.round(factor100 * selectedFood.kcal100);
      const prot = r1(factor100 * selectedFood.prot100);
      const carb = r1(factor100 * selectedFood.carb100);
      const fat = r1(factor100 * selectedFood.fat100);
      const fiber = r1(factor100 * selectedFood.fiber100);
      
      calcPreview.textContent = `${kcal} kcal ¬∑ P ${prot}g ¬∑ C ${carb}g ¬∑ G ${fat}g ¬∑ F ${fiber}g`;
    }

    /* Busca + sele√ß√£o */
    let selectedFood=null;
    let highlightedIndex = -1;
    
    function selectFood(food) {
      selectedFood = {...food};
      foodSearch.value = food.name;
      foodList.classList.add('hidden');
      highlightedIndex = -1;
      handleUnitChange(); 
      updatePreview();
    }
    
    function onSearchFoods(){
      const q=foodSearch.value.trim().toLowerCase();
      const list=allFoods().filter(f=>f.nameLower.includes(q)).slice(0,20);
      foodList.innerHTML='';
      highlightedIndex = -1;
      
      if(!q||!list.length){
        foodList.classList.add('hidden'); 
        selectedFood=null; 
        updatePreview(); 
        return;
      }
      
      list.forEach((f, index)=>{
        const row=document.createElement('div');
        row.className='px-3 py-2 hover:bg-white/5 cursor-pointer text-sm rounded-lg';
        row.setAttribute('data-index', index);
        row.innerHTML=`<div class="font-medium">${f.name} <span class="text-[10px] text-slate-400">(${f.unitBase})</span></div>
          <div class="text-[11px] text-slate-400">${f.kcal100} kcal/100${f.unitBase} ¬∑ P ${f.prot100} ¬∑ C ${f.carb100} ¬∑ G ${f.fat100} ¬∑ F ${f.fiber100}</div>`;
        
        // mousedown pega antes do blur/focusout
        row.addEventListener('mousedown', (e)=>{
          e.preventDefault(); e.stopPropagation();
          selectFood(f);
        });
        
        // hover para destacar
        row.addEventListener('mouseenter', () => {
          highlightedIndex = index;
          updateHighlight();
        });
        
        foodList.appendChild(row);
      });
      
      foodList.classList.remove('hidden');
      window.currentFoodList = list; // guardar lista atual para navega√ß√£o por teclado
    }
    
    function updateHighlight() {
      const rows = foodList.querySelectorAll('[data-index]');
      rows.forEach((row, index) => {
        if (index === highlightedIndex) {
          row.classList.add('bg-white/10');
        } else {
          row.classList.remove('bg-white/10');
        }
      });
    }

    /* Unidade / Preview */
    function handleUnitChange(){ showUnTools(); maybeAskVariant(); }
    function showUnTools(){
      if(!selectedFood || unitSelect.value!=='un'){ unTools.classList.add('hidden'); return; }
      const ov=state.overrides[selectedFood.id]; const gpu=ov&&ov.gramsPerUnit;
      unTools.classList.remove('hidden'); inpGpu.value=gpu?gpu:'';
    }
    function maybeAskVariant(){
      if(!selectedFood) return;
      const u=unitSelect.value;
      if(u==='un') return;
      if(u!==selectedFood.unitBase){ openVariantModal(selectedFood, u); } else { closeVariantModal(); }
    }

    /* Modal variante */
    function openVariantModal(food,targetBase){
      vmTitle.textContent=targetBase==='ml'?'Cadastrar variante em ML':'Cadastrar variante em GRAMAS';
      vmDesc.textContent=`‚Äú${food.name}‚Äù est√° cadastrado em ${food.unitBase}. Deseja criar uma variante em ${targetBase.toUpperCase()} (valores por 100 ${targetBase})?`;
      vmName.value=food.name+(targetBase==='ml'?' (ml)':' (g)'); vmBase.value=`100 ${targetBase}`;
      vmKcal.value=''; vmProt.value=''; vmCarb.value=''; vmFat.value=''; vmFib.value='';
      variantModal.style.display='flex'; variantModal.dataset.foodId=food.id; variantModal.dataset.targetBase=targetBase;
    }
    function closeVariantModal(){ variantModal.style.display='none'; delete variantModal.dataset.foodId; delete variantModal.dataset.targetBase; }
    function saveVariant(){
      const targetBase=variantModal.dataset.targetBase; const name=(vmName.value||'').trim();
      const kcal=Number(vmKcal.value||0), prot=Number(vmProt.value||0), carb=Number(vmCarb.value||0), fat=Number(vmFat.value||0), fib=Number(vmFib.value||0);
      if(!name||kcal<=0){ alert('Preencha ao menos Nome e Kcal v√°lidas.'); return; }
      const newFood={ id:'cf_'+crypto.randomUUID(), name, nameLower:name.toLowerCase(), unitBase:targetBase, kcal100:kcal, prot100:prot, carb100:carb, fat100:fat, fiber100:fib };
      state.customFoods.unshift(newFood); saveState(state); closeVariantModal();
      selectedFood={...newFood}; foodSearch.value=newFood.name; updatePreview();
    }

    /* Add / Delete */
    // Fun√ß√£o para adicionar item ao di√°rio
    function addItemToDiary() {
      console.log('=== ADICIONANDO ITEM ===');
      
      // Valida√ß√µes com guards
      if (!state) {
        console.error('‚ùå State n√£o inicializado');
        alert('Erro: aplica√ß√£o n√£o inicializada');
        return;
      }
      
      if (!selectedFood) {
        alert('‚ö†Ô∏è Escolha um alimento');
        return;
      }
      
      const q = Number(qtyInput?.value || 0);
      if (q <= 0) {
        alert('‚ö†Ô∏è Informe a quantidade');
        return;
      }
      
      const u = unitSelect?.value;
      const meal = mealSelect?.value;
      const d = dateInput?.value || getTodayString();
      
      if (u === 'un' && !getGpu(selectedFood)) {
        alert('‚ö†Ô∏è Informe e salve os gramas por unidade.');
        return;
      }
      
      // Calcular macros com base na unidade selecionada
      let factor100;
      
      if (u === 'un') {
        // Unidade: usar gramas por unidade
        factor100 = (q * getGpu(selectedFood)) / 100;
      } else if (u === selectedFood.unitBase) {
        // Mesma unidade base do alimento
        factor100 = q / 100;
      } else {
        // Unidade diferente: precisamos converter
        // Por exemplo: alimento em 'g' mas selecionou 'ml'
        // Neste caso, vamos assumir convers√£o 1:1 (pode ajustar se necess√°rio)
        console.warn(`‚ö†Ô∏è Convers√£o ${selectedFood.unitBase} ‚Üí ${u}: assumindo 1:1`);
        factor100 = q / 100;
      }
      
      const payload = {
        id: crypto.randomUUID(),
        foodId: selectedFood.id,
        foodName: selectedFood.name,
        qty: q,
        unit: u,
        meal: meal,
        kcal: Math.round(factor100 * selectedFood.kcal100 * 10) / 10,
        prot: Math.round(factor100 * selectedFood.prot100 * 10) / 10,
        carb: Math.round(factor100 * selectedFood.carb100 * 10) / 10,
        fat: Math.round(factor100 * selectedFood.fat100 * 10) / 10,
        fiber: Math.round(factor100 * selectedFood.fiber100 * 10) / 10
      };
      
      console.log('üì¶ Payload criado:', payload);
      
      // Garantir que entries[d] existe
      if (!state.entries[d]) {
        state.entries[d] = [];
      }
      
      state.entries[d].unshift(payload);
      state.selectedDate = d;
      
      // Salvar imediatamente (s√≠ncrono + ass√≠ncrono)
      saveState(state).then(() => {
        console.log('üíæ Estado salvo. Total de itens em', d, ':', state.entries[d].length);
      });
      
      // Limpar formul√°rio
      if (qtyInput) qtyInput.value = '';
      if (foodSearch) foodSearch.value = '';
      selectedFood = null;
      if (calcPreview) calcPreview.textContent = '‚Äî';
      if (unTools) unTools.classList.add('hidden');
      if (inpGpu) inpGpu.value = '';
      
      // Atualizar UI
      bindDay(d);
      updateHomeDashboard();
      
      console.log('‚úÖ ITEM ADICIONADO COM SUCESSO');
    }
    
    // Event listener para bot√£o adicionar
    if (addBtn) {
      addBtn.addEventListener('click', addItemToDiary);
    }
    function deleteItem(id){
      const d=dateInput.value; 
      
      // Filtrar item removido
      const oldEntries = state.entries[d] || [];
      state.entries[d] = oldEntries.filter(i => i.id !== id);
      
      // Se n√£o restaram itens, remover a entrada do dia completamente
      if (state.entries[d].length === 0) {
        delete state.entries[d];
      }
      
      // Salvar imediatamente
      saveState(state).then(() => {
        console.log('üíæ Item removido e estado salvo. Entradas restantes para', d, ':', state.entries[d]);
      });
      
      bindDay(d);
      updateHomeDashboard();
    }

    /* Utils */
    function getGpu(food){ const o=state.overrides[food.id]; return o&&o.gramsPerUnit?o.gramsPerUnit:null; }
    function r1(x){ return Math.round((x||0)*10)/10; }
    
    function getMealName(mealValue) {
      const mealNames = {
        'cafe': 'Caf√© da manh√£',
        'lanche_manha': 'Lanche da manh√£',
        'almoco': 'Almo√ßo',
        'lanche_tarde': 'Lanche da tarde',
        'jantar': 'Jantar',
        'ceia': 'Ceia'
      };
      return mealNames[mealValue] || mealValue;
    }
    
    /* Navega√ß√£o entre abas */
    function switchTab(tab) {
      console.log('=== SWITCH TAB:', tab, '===');
      
      // Atualizar bot√µes de navega√ß√£o
      document.querySelectorAll('nav button').forEach(btn => {
        btn.classList.remove('font-medium');
        btn.classList.add('opacity-80');
      });
      
      // Ocultar todas as abas
      const homePage = document.getElementById('homePage');
      const lancamentosPage = document.getElementById('lancamentosPage');
      const configPage = document.getElementById('configPage');
      const refeicoesTab = document.getElementById('refeicoes-tab');
      const alimentosTab = document.getElementById('alimentos-tab');
      const relatoriosTab = document.getElementById('relatorios-tab');
      
      if (homePage) homePage.classList.add('hidden');
      if (lancamentosPage) lancamentosPage.classList.add('hidden');
      if (configPage) configPage.classList.add('hidden');
      if (refeicoesTab) refeicoesTab.classList.add('hidden');
      if (alimentosTab) alimentosTab.classList.add('hidden');
      if (relatoriosTab) relatoriosTab.classList.add('hidden');
      
      if (tab === 'refeicoes') {
        const tabRefeicoes = document.getElementById('tabRefeicoes');
        if (tabRefeicoes) {
          tabRefeicoes.classList.add('font-medium');
          tabRefeicoes.classList.remove('opacity-80');
        }
        if (refeicoesTab) {
          refeicoesTab.classList.remove('hidden');
          loadRefeicoesTab();
        }
      } else if (tab === 'alimentos') {
        const tabAlimentos = document.getElementById('tabAlimentos');
        if (tabAlimentos) {
          tabAlimentos.classList.add('font-medium');
          tabAlimentos.classList.remove('opacity-80');
        }
        if (alimentosTab) {
          alimentosTab.classList.remove('hidden');
          loadAlimentosTab();
        }
      } else if (tab === 'relatorios') {
        const tabRelatorios = document.getElementById('tabRelatorios');
        if (tabRelatorios) {
          tabRelatorios.classList.add('font-medium');
          tabRelatorios.classList.remove('opacity-80');
        }
        if (relatoriosTab) {
          relatoriosTab.classList.remove('hidden');
          initRelatoriosTab();
        }
      }
      
      console.log('Tab ativada:', tab);
    }
    
    /* Salvar refei√ß√£o */
    function saveMeal() {
      const currentMeal = mealSelect.value;
      const currentDate = dateInput.value;
      const currentItems = state.entries[currentDate] || [];
      
      // Filtrar apenas itens da refei√ß√£o atual
      const mealItems = currentItems.filter(item => item.meal === currentMeal);
      
      if (mealItems.length === 0) {
        alert('Adicione pelo menos um alimento √† refei√ß√£o antes de salvar.');
        return;
      }
      
      // Calcular totais da refei√ß√£o
      const totals = mealItems.reduce((acc, item) => ({
        kcal: acc.kcal + (item.kcal || 0),
        prot: acc.prot + (item.prot || 0),
        carb: acc.carb + (item.carb || 0),
        fat: acc.fat + (item.fat || 0),
        fiber: acc.fiber + (item.fiber || 0)
      }), { kcal: 0, prot: 0, carb: 0, fat: 0, fiber: 0 });
      
      // Salvar refei√ß√£o
      if (!state.savedMeals[currentDate]) state.savedMeals[currentDate] = [];
      
      const mealData = {
        id: crypto.randomUUID(),
        meal: currentMeal,
        mealName: getMealName(currentMeal),
        items: mealItems,
        totals: totals,
        timestamp: new Date().toISOString()
      };
      
      state.savedMeals[currentDate].push(mealData);
      
      // Remover itens da refei√ß√£o dos lan√ßamentos individuais
      state.entries[currentDate] = currentItems.filter(item => item.meal !== currentMeal);
      
      saveState(state);
      
      // Limpar formul√°rio e atualizar interface
      clearMealForm();
      bindDay(currentDate);
      updateHomeDashboard(); // Atualizar dashboard ap√≥s salvar refei√ß√£o
      
      alert(`Refei√ß√£o "${getMealName(currentMeal)}" salva com sucesso!`);
    }
    
    function clearMealForm() {
      qtyInput.value = '';
      foodSearch.value = '';
      selectedFood = null;
      calcPreview.textContent = '‚Äî';
      unTools.classList.add('hidden');
      inpGpu.value = '';
      foodList.classList.add('hidden');
    }
    
    /* Aba de refei√ß√µes */
    function loadRefeicoesTab() {
      const currentDate = dateInput.value;
      // Corrigir formata√ß√£o da data para n√£o subtrair um dia
      const [year, month, day] = currentDate.split('-');
      const displayDate = new Date(year, month - 1, day).toLocaleDateString('pt-BR');
      refeicoesDate.textContent = displayDate;
      
      const savedMeals = state.savedMeals[currentDate] || [];
      
      if (savedMeals.length === 0) {
        refeicoesContainer.innerHTML = '<div class="text-center text-slate-400 py-8">Nenhuma refei√ß√£o salva ainda</div>';
        return;
      }
      
      // Agrupar refei√ß√µes do mesmo tipo
      const groupedMeals = {};
      savedMeals.forEach(meal => {
        if (!groupedMeals[meal.meal]) {
          groupedMeals[meal.meal] = {
            mealName: meal.mealName,
            items: [],
            totals: { kcal: 0, prot: 0, carb: 0, fat: 0, fiber: 0 },
            ids: []
          };
        }
        
        groupedMeals[meal.meal].items = groupedMeals[meal.meal].items.concat(meal.items);
        groupedMeals[meal.meal].totals.kcal += meal.totals.kcal;
        groupedMeals[meal.meal].totals.prot += meal.totals.prot;
        groupedMeals[meal.meal].totals.carb += meal.totals.carb;
        groupedMeals[meal.meal].totals.fat += meal.totals.fat;
        groupedMeals[meal.meal].totals.fiber += meal.totals.fiber;
        groupedMeals[meal.meal].ids.push(meal.id);
      });
      
      refeicoesContainer.innerHTML = '';
      
      Object.entries(groupedMeals).forEach(([mealType, meal]) => {
        const mealDiv = document.createElement('div');
        mealDiv.className = 'glass rounded-xl p-4 mb-4';
        
        const itemsHtml = meal.items.map(item => 
          `<div class="text-sm text-slate-300">${item.foodName} (${item.qty}${item.unit}) - ${Math.round(item.kcal)} kcal</div>`
        ).join('');
        
        mealDiv.innerHTML = `
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold">${meal.mealName}</h3>
            <button class="text-xs px-2 py-1 rounded chip hover:opacity-90 text-red-400 hover:bg-red-500/20" onclick="deleteGroupedMeal('${mealType}')">üóëÔ∏è Excluir</button>
          </div>
          <div class="space-y-1 mb-3">
            ${itemsHtml}
          </div>
          <div class="text-sm font-medium text-sky-400">
            Total: ${Math.round(meal.totals.kcal)} kcal ¬∑ P ${r1(meal.totals.prot)}g ¬∑ C ${r1(meal.totals.carb)}g ¬∑ G ${r1(meal.totals.fat)}g ¬∑ F ${r1(meal.totals.fiber)}g
          </div>
        `;
        
        refeicoesContainer.appendChild(mealDiv);
      });
    }
    
    // Tornar fun√ß√£o global
    window.loadRefeicoesTab = loadRefeicoesTab;
    
    // Fun√ß√£o global para excluir refei√ß√£o salva (usada no HTML)
    window.deleteSavedMeal = function(mealId) {
      const currentDate = dateInput.value;
      if (!state.savedMeals[currentDate]) return;
      
      state.savedMeals[currentDate] = state.savedMeals[currentDate].filter(meal => meal.id !== mealId);
      saveState(state);
      loadRefeicoesTab();
    }
    
    // Fun√ß√£o para excluir grupo de refei√ß√µes do mesmo tipo
    window.deleteGroupedMeal = function(mealType) {
      const currentDate = dateInput.value;
      if (!state.savedMeals[currentDate]) return;
      
      state.savedMeals[currentDate] = state.savedMeals[currentDate].filter(meal => meal.meal !== mealType);
      saveState(state);
      loadRefeicoesTab();
    }
    
    /* Aba de Alimentos */
    let selectedAlimento = null;
    let editingAlimentoId = null;
    
    function updateAlimentosCounter() {
      const counter = alimentosCounter || document.getElementById('alimentosCounter');
      if (counter) {
        const totalFoods = allFoods().length;
        counter.textContent = totalFoods;
        console.log('‚úÖ Contador atualizado:', totalFoods, 'alimentos');
      } else {
        console.error('‚ùå alimentosCounter n√£o encontrado no DOM!');
      }
    }
    
    // Tornar fun√ß√£o global
    window.updateAlimentosCounter = updateAlimentosCounter;
    
    function exibirListaAlimentos() {
      if (alimentosListWrapper) {
        alimentosListWrapper.classList.remove('hidden');
        btnExibirLista.classList.add('hidden');
        btnOcultarLista.classList.remove('hidden');
        loadAlimentosTab();
      }
    }
    
    function ocultarListaAlimentos() {
      if (alimentosListWrapper) {
        alimentosListWrapper.classList.add('hidden');
        btnExibirLista.classList.remove('hidden');
        btnOcultarLista.classList.add('hidden');
        // Limpar sele√ß√£o
        selectedAlimento = null;
        if (alimentoActions) alimentoActions.classList.add('hidden');
      }
    }
    
    function loadAlimentosTab() {
      console.log('loadAlimentosTab chamado');
      const foods = allFoods();
      console.log('Total de alimentos:', foods.length);
      displayAlimentos(foods);
      updateAlimentosCounter();
    }
    
    function renderAllFoodList() {
      console.log('renderAllFoodList chamado');
      displayAlimentos(allFoods());
      updateAlimentosCounter();
    }
    
    // Tornar fun√ß√µes globais
    window.loadAlimentosTab = loadAlimentosTab;
    window.renderAllFoodList = renderAllFoodList;
    
    function displayAlimentos(foods) {
      console.log('üé® displayAlimentos() chamado com', foods ? foods.length : 0, 'alimentos');
      
      // FALLBACK: Se foods vazio, pegar direto do window.builtinFoods
      if (!foods || foods.length === 0) {
        console.warn('‚ö†Ô∏è Foods vazio! Tentando window.builtinFoods...');
        if (window.builtinFoods && window.builtinFoods.length > 0) {
          console.log('‚úÖ Usando window.builtinFoods:', window.builtinFoods.length);
          foods = window.builtinFoods;
        }
      }
      
      const container = document.getElementById('alimentosContainer');
      if (!container) {
        console.error('‚ùå alimentosContainer n√£o encontrado!');
        return;
      }
      
      console.log('‚úÖ Container encontrado:', container);
      
      container.innerHTML = '';
      
      if (!foods || foods.length === 0) {
        console.error('‚ùå Nenhum alimento dispon√≠vel!');
        container.innerHTML = '<div class="text-center text-red-400 py-4">‚ùå Erro: Nenhum alimento encontrado. Verifique o Console (F12)</div>';
        return;
      }
      
      console.log('üî® Renderizando', foods.length, 'alimentos...');
      console.log('üìã Primeiros 3 alimentos a renderizar:', foods.slice(0, 3).map(f => ({id: f.id, name: f.name, kcal: f.kcal100})));
      
      foods.forEach(food => {
        const foodDiv = document.createElement('div');
        foodDiv.className = 'glass rounded-lg p-3 cursor-pointer hover:bg-white/5 transition-colors';
        foodDiv.setAttribute('data-food-id', food.id);
        
        const isBuiltin = builtinFoods.some(bf => bf.id === food.id);
        const typeTag = isBuiltin ? '<span class="tag text-[9px]">Sistema</span>' : '<span class="tag text-[9px]">Personalizado</span>';
        
        foodDiv.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <h4 class="font-medium text-sm">${food.name}</h4>
            ${typeTag}
          </div>
          <div class="text-xs text-slate-400">
            ${food.kcal100} kcal/100${food.unitBase} ¬∑ P ${food.prot100}g ¬∑ C ${food.carb100}g ¬∑ G ${food.fat100}g ¬∑ F ${food.fiber100}g
          </div>
        `;
        
        foodDiv.addEventListener('click', () => selectAlimento(food, foodDiv));
        container.appendChild(foodDiv);
      });
      
      console.log('‚úÖ Lista de alimentos renderizada:', foods.length, 'itens');
    }
    
    function selectAlimento(food, element) {
      // Remover sele√ß√£o anterior
      document.querySelectorAll('#alimentosContainer > div').forEach(div => {
        div.classList.remove('ring-2', 'ring-sky-400');
      });
      
      // Adicionar sele√ß√£o atual
      element.classList.add('ring-2', 'ring-sky-400');
      selectedAlimento = food;
      
      // Mostrar bot√µes de a√ß√£o (s√≥ para alimentos personalizados)
      const isBuiltin = builtinFoods.some(bf => bf.id === food.id);
      if (isBuiltin) {
        alimentoActions.classList.add('hidden');
      } else {
        alimentoActions.classList.remove('hidden');
      }
    }
    
    function filterAlimentos() {
      const query = searchAlimentos.value.trim().toLowerCase();
      const filtered = allFoods().filter(food => 
        food.nameLower.includes(query)
      );
      displayAlimentos(filtered);
      selectedAlimento = null;
      alimentoActions.classList.add('hidden');
    }
    
    // Tornar fun√ß√£o global para onclick funcionar
    // Redirecionar para o novo modal
    window.openAlimentoModal = function(editMode = false) {
      console.log('window.openAlimentoModal chamado, redirecionando para novo modal');
      // Se for edi√ß√£o, usar modal antigo (se existir), sen√£o usar o novo
      if (editMode && selectedAlimento) {
        const alimentoModal = document.getElementById('alimentoModal');
        if (alimentoModal) {
          // Usar modal antigo para edi√ß√£o (se ainda existir)
          const amTitle = document.getElementById('amTitle');
          const amName = document.getElementById('amName');
          const amUnitBase = document.getElementById('amUnitBase');
          const amKcal = document.getElementById('amKcal');
          const amProt = document.getElementById('amProt');
          const amCarb = document.getElementById('amCarb');
          const amFat = document.getElementById('amFat');
          const amFiber = document.getElementById('amFiber');
          
          editingAlimentoId = selectedAlimento.id;
          if (amTitle) amTitle.textContent = 'Editar alimento';
          if (amName) amName.value = selectedAlimento.name;
          if (amUnitBase) amUnitBase.value = selectedAlimento.unitBase;
          if (amKcal) amKcal.value = selectedAlimento.kcal100;
          if (amProt) amProt.value = selectedAlimento.prot100;
          if (amCarb) amCarb.value = selectedAlimento.carb100;
          if (amFat) amFat.value = selectedAlimento.fat100;
          if (amFiber) amFiber.value = selectedAlimento.fiber100;
          
          alimentoModal.style.display = 'flex';
          alimentoModal.classList.remove('hidden');
          return;
        }
      }
      
      // Usar novo modal para cadastro
      openNewFoodModal();
    }
    
    window.closeAlimentoModal = function() {
      const alimentoModal = document.getElementById('alimentoModal');
      alimentoModal.style.display = 'none';
      alimentoModal.classList.add('hidden');
      editingAlimentoId = null;
    }
    
    window.saveAlimento = function() {
      const amName = document.getElementById('amName');
      const amUnitBase = document.getElementById('amUnitBase');
      const amKcal = document.getElementById('amKcal');
      const amProt = document.getElementById('amProt');
      const amCarb = document.getElementById('amCarb');
      const amFat = document.getElementById('amFat');
      const amFiber = document.getElementById('amFiber');
      
      const name = amName.value.trim();
      const unitBase = amUnitBase.value;
      const kcal = Number(amKcal.value) || 0;
      const prot = Number(amProt.value) || 0;
      const carb = Number(amCarb.value) || 0;
      const fat = Number(amFat.value) || 0;
      const fiber = Number(amFiber.value) || 0;
      
      if (!name) {
        alert('Digite o nome do alimento');
        return;
      }
      
      if (kcal <= 0) {
        alert('Informe um valor v√°lido para as calorias');
        return;
      }
      
      if (editingAlimentoId) {
        // Editar alimento existente
        const index = state.customFoods.findIndex(f => f.id === editingAlimentoId);
        if (index >= 0) {
          state.customFoods[index] = {
            ...state.customFoods[index],
            name,
            nameLower: name.toLowerCase(),
            unitBase,
            kcal100: kcal,
            prot100: prot,
            carb100: carb,
            fat100: fat,
            fiber100: fiber
          };
        }
      } else {
        // Criar novo alimento
        const newFood = {
          id: 'cf_' + crypto.randomUUID(),
          name,
          nameLower: name.toLowerCase(),
          unitBase,
          kcal100: kcal,
          prot100: prot,
          carb100: carb,
          fat100: fat,
          fiber100: fiber
        };
        state.customFoods.push(newFood);
      }
      
      saveState(state);
      closeAlimentoModal();
      loadAlimentosTab();
      selectedAlimento = null;
      const alimentoActions = document.getElementById('alimentoActions');
      if (alimentoActions) alimentoActions.classList.add('hidden');
      
      const action = editingAlimentoId ? 'editado' : 'cadastrado';
      alert(`Alimento ${action} com sucesso!`);
    }
    
    function editSelectedAlimento() {
      if (!selectedAlimento) {
        alert('Selecione um alimento para editar');
        return;
      }
      
      const isBuiltin = builtinFoods.some(bf => bf.id === selectedAlimento.id);
      if (isBuiltin) {
        alert('Alimentos do sistema n√£o podem ser editados');
        return;
      }
      
      openAlimentoModal(true);
    }
    
    function deleteSelectedAlimento() {
      if (!selectedAlimento) {
        alert('Selecione um alimento para excluir');
        return;
      }
      
      const isBuiltin = builtinFoods.some(bf => bf.id === selectedAlimento.id);
      if (isBuiltin) {
        alert('Alimentos do sistema n√£o podem ser exclu√≠dos');
        return;
      }
      
      if (!confirm(`Deseja realmente excluir "${selectedAlimento.name}"?`)) {
        return;
      }
      
      state.customFoods = state.customFoods.filter(f => f.id !== selectedAlimento.id);
      saveState(state);
      loadAlimentosTab();
      updateAlimentosCounter();
      selectedAlimento = null;
      alimentoActions.classList.add('hidden');
      
      alert('‚úÖ Alimento exclu√≠do com sucesso!');
    }
    
    /* Aba de Relat√≥rios */
    let tipoRelatorioAtual = 'periodo';
    
    function initRelatoriosTab() {
      // Inicializar com data atual
      const hoje = getTodayString();
      dataEspecifica.value = hoje;
      dataFinal.value = hoje;
      
      // Setar data inicial como primeiro dia do m√™s
      const inicioMes = hoje.substring(0, 8) + '01';
      dataInicial.value = inicioMes;
      
      setTipoRelatorio('periodo');
    }
    
    function setTipoRelatorio(tipo) {
      tipoRelatorioAtual = tipo;
      
      // Atualizar bot√µes
      btnPorPeriodo.classList.remove('btn-primary', 'btn-ghost');
      btnPorDia.classList.remove('btn-primary', 'btn-ghost');
      
      if (tipo === 'periodo') {
        btnPorPeriodo.classList.add('btn-primary');
        btnPorDia.classList.add('btn-ghost');
        camposPeriodo.classList.remove('hidden');
        camposDia.classList.add('hidden');
      } else {
        btnPorDia.classList.add('btn-primary');
        btnPorPeriodo.classList.add('btn-ghost');
        camposPeriodo.classList.add('hidden');
        camposDia.classList.remove('hidden');
      }
      
      // Ocultar resultados
      resultadosRelatorio.classList.add('hidden');
    }
    
    function gerarRelatorio() {
      if (tipoRelatorioAtual === 'periodo') {
        const inicio = dataInicial.value;
        const fim = dataFinal.value;
        
        if (!inicio || !fim) {
          alert('Selecione as datas inicial e final');
          return;
        }
        
        if (inicio > fim) {
          alert('Data inicial n√£o pode ser maior que a final');
          return;
        }
        
        gerarRelatorioPeriodo(inicio, fim);
      } else {
        const data = dataEspecifica.value;
        
        if (!data) {
          alert('Selecione uma data');
          return;
        }
        
        gerarRelatorioDia(data);
      }
    }
    
    function gerarRelatorioPeriodo(inicio, fim) {
      const dados = coletarDadosPeriodo(inicio, fim);
      
      if (Object.keys(dados).length === 0) {
        relatorioContainer.innerHTML = '<div class="text-center text-slate-400 py-8">Nenhum dado encontrado no per√≠odo</div>';
        periodoRelatorio.textContent = `${formatarData(inicio)} - ${formatarData(fim)}`;
        resultadosRelatorio.classList.remove('hidden');
        return;
      }
      
      const estrutura = organizarDadosHierarquicos(dados);
      renderizarRelatorioHierarquico(estrutura);
      
      periodoRelatorio.textContent = `${formatarData(inicio)} - ${formatarData(fim)}`;
      resultadosRelatorio.classList.remove('hidden');
    }
    
    function gerarRelatorioDia(data) {
      const refeicoesSalvas = state.savedMeals[data] || [];
      const lancamentos = state.entries[data] || [];
      
      if (refeicoesSalvas.length === 0 && lancamentos.length === 0) {
        relatorioContainer.innerHTML = '<div class="text-center text-slate-400 py-8">Nenhum dado encontrado para este dia</div>';
        periodoRelatorio.textContent = formatarData(data);
        resultadosRelatorio.classList.remove('hidden');
        return;
      }
      
      renderizarRelatorioDia(data, refeicoesSalvas, lancamentos);
      periodoRelatorio.textContent = formatarData(data);
      resultadosRelatorio.classList.remove('hidden');
    }
    
    function coletarDadosPeriodo(inicio, fim) {
      const dados = {};
      
      // Coletar refei√ß√µes salvas
      Object.keys(state.savedMeals || {}).forEach(data => {
        if (data >= inicio && data <= fim) {
          if (!dados[data]) dados[data] = { refeicoes: [], lancamentos: [] };
          dados[data].refeicoes = state.savedMeals[data];
        }
      });
      
      // Coletar lan√ßamentos individuais
      Object.keys(state.entries || {}).forEach(data => {
        if (data >= inicio && data <= fim && state.entries[data].length > 0) {
          if (!dados[data]) dados[data] = { refeicoes: [], lancamentos: [] };
          dados[data].lancamentos = state.entries[data];
        }
      });
      
      return dados;
    }
    
    function organizarDadosHierarquicos(dados) {
      const estrutura = {};
      
      Object.keys(dados).forEach(data => {
        const [ano, mes, dia] = data.split('-');
        
        if (!estrutura[ano]) estrutura[ano] = {};
        if (!estrutura[ano][mes]) estrutura[ano][mes] = {};
        
        // Calcular totais do dia
        const totalDia = calcularTotaisDia(dados[data]);
        estrutura[ano][mes][dia] = {
          data: data,
          dados: dados[data],
          totais: totalDia
        };
      });
      
      return estrutura;
    }
    
    function calcularTotaisDia(dadosDia) {
      let totais = { kcal: 0, prot: 0, carb: 0, fat: 0, fiber: 0 };
      
      // Somar refei√ß√µes salvas
      dadosDia.refeicoes.forEach(refeicao => {
        totais.kcal += refeicao.totals.kcal || 0;
        totais.prot += refeicao.totals.prot || 0;
        totais.carb += refeicao.totals.carb || 0;
        totais.fat += refeicao.totals.fat || 0;
        totais.fiber += refeicao.totals.fiber || 0;
      });
      
      // Somar lan√ßamentos individuais
      dadosDia.lancamentos.forEach(item => {
        totais.kcal += item.kcal || 0;
        totais.prot += item.prot || 0;
        totais.carb += item.carb || 0;
        totais.fat += item.fat || 0;
        totais.fiber += item.fiber || 0;
      });
      
      return totais;
    }
    
    function renderizarRelatorioHierarquico(estrutura) {
      const anos = Object.keys(estrutura).sort((a, b) => b - a);
      
      if (anos.length === 0) {
        relatorioContainer.innerHTML = '<div class="text-center text-slate-400 py-8">Nenhum dado encontrado</div>';
        return;
      }
      
      let html = '';
      
      // Se mais de um ano, mostrar por ano
      if (anos.length > 1) {
        anos.forEach(ano => {
          const totaisAno = calcularTotaisAno(estrutura[ano]);
          html += `
            <div class="mb-4">
              <div class="glass rounded-lg p-3 cursor-pointer hover:bg-white/5" onclick="toggleAno('${ano}')">
                <div class="flex justify-between items-center">
                  <h4 class="font-semibold">${ano}</h4>
                  <div class="text-sm text-sky-400">${Math.round(totaisAno.kcal)} kcal</div>
                </div>
                <div class="text-xs text-slate-400">P ${r1(totaisAno.prot)}g ¬∑ C ${r1(totaisAno.carb)}g ¬∑ G ${r1(totaisAno.fat)}g ¬∑ F ${r1(totaisAno.fiber)}g</div>
              </div>
              <div id="ano-${ano}" class="hidden ml-4 mt-2 space-y-2">
                ${renderizarMeses(estrutura[ano], ano)}
              </div>
            </div>
          `;
        });
      } else {
        // Um ano s√≥, mostrar meses diretamente
        const ano = anos[0];
        html = renderizarMeses(estrutura[ano], ano);
      }
      
      relatorioContainer.innerHTML = html;
    }
    
    function renderizarMeses(dadosAno, ano) {
      const meses = Object.keys(dadosAno).sort((a, b) => b - a);
      const nomesMeses = ['', 'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
      
      let html = '';
      
      meses.forEach(mes => {
        const totaisMes = calcularTotaisMes(dadosAno[mes]);
        const nomeMes = nomesMeses[parseInt(mes)];
        
        html += `
          <div class="mb-3">
            <div class="glass rounded-lg p-3 cursor-pointer hover:bg-white/5" onclick="toggleMes('${ano}-${mes}')">
              <div class="flex justify-between items-center">
                <h5 class="font-medium">${nomeMes} ${ano}</h5>
                <div class="text-sm text-sky-400">${Math.round(totaisMes.kcal)} kcal</div>
              </div>
              <div class="text-xs text-slate-400">P ${r1(totaisMes.prot)}g ¬∑ C ${r1(totaisMes.carb)}g ¬∑ G ${r1(totaisMes.fat)}g ¬∑ F ${r1(totaisMes.fiber)}g</div>
            </div>
            <div id="mes-${ano}-${mes}" class="hidden ml-4 mt-2 space-y-1">
              ${renderizarDias(dadosAno[mes])}
            </div>
          </div>
        `;
      });
      
      return html;
    }
    
    function renderizarDias(dadosMes) {
      const dias = Object.keys(dadosMes).sort((a, b) => b - a);
      
      let html = '';
      
      dias.forEach(dia => {
        const dadosDia = dadosMes[dia];
        const dataFormatada = formatarData(dadosDia.data);
        
        html += `
          <div class="glass rounded-lg p-2 cursor-pointer hover:bg-white/5" onclick="mostrarDetalhesDia('${dadosDia.data}')">
            <div class="flex justify-between items-center">
              <span class="text-sm">${dataFormatada}</span>
              <div class="text-sm text-sky-400">${Math.round(dadosDia.totais.kcal)} kcal</div>
            </div>
            <div class="text-xs text-slate-400">P ${r1(dadosDia.totais.prot)}g ¬∑ C ${r1(dadosDia.totais.carb)}g ¬∑ G ${r1(dadosDia.totais.fat)}g ¬∑ F ${r1(dadosDia.totais.fiber)}g</div>
          </div>
        `;
      });
      
      return html;
    }
    
    function renderizarRelatorioDia(data, refeicoesSalvas, lancamentos) {
      let html = '<div class="space-y-4">';
      
      // Agrupar refei√ß√µes por tipo
      const refeicoesAgrupadas = {};
      refeicoesSalvas.forEach(refeicao => {
        if (!refeicoesAgrupadas[refeicao.meal]) {
          refeicoesAgrupadas[refeicao.meal] = {
            nome: refeicao.mealName,
            itens: [],
            totais: { kcal: 0, prot: 0, carb: 0, fat: 0, fiber: 0 }
          };
        }
        
        refeicoesAgrupadas[refeicao.meal].itens = refeicoesAgrupadas[refeicao.meal].itens.concat(refeicao.items);
        refeicoesAgrupadas[refeicao.meal].totais.kcal += refeicao.totals.kcal;
        refeicoesAgrupadas[refeicao.meal].totais.prot += refeicao.totals.prot;
        refeicoesAgrupadas[refeicao.meal].totais.carb += refeicao.totals.carb;
        refeicoesAgrupadas[refeicao.meal].totais.fat += refeicao.totals.fat;
        refeicoesAgrupadas[refeicao.meal].totais.fiber += refeicao.totals.fiber;
      });
      
      // Adicionar lan√ßamentos individuais por refei√ß√£o
      lancamentos.forEach(item => {
        if (!refeicoesAgrupadas[item.meal]) {
          refeicoesAgrupadas[item.meal] = {
            nome: getMealName(item.meal),
            itens: [],
            totais: { kcal: 0, prot: 0, carb: 0, fat: 0, fiber: 0 }
          };
        }
        
        refeicoesAgrupadas[item.meal].itens.push(item);
        refeicoesAgrupadas[item.meal].totais.kcal += item.kcal || 0;
        refeicoesAgrupadas[item.meal].totais.prot += item.prot || 0;
        refeicoesAgrupadas[item.meal].totais.carb += item.carb || 0;
        refeicoesAgrupadas[item.meal].totais.fat += item.fat || 0;
        refeicoesAgrupadas[item.meal].totais.fiber += item.fiber || 0;
      });
      
      // Renderizar cada refei√ß√£o
      Object.entries(refeicoesAgrupadas).forEach(([mealType, refeicao]) => {
        html += `
          <div class="glass rounded-lg p-4">
            <h4 class="font-semibold mb-2">${refeicao.nome}</h4>
            <div class="space-y-1 mb-3">
              ${refeicao.itens.map(item => 
                `<div class="text-sm text-slate-300">${item.foodName} (${item.qty}${item.unit}) - ${Math.round(item.kcal)} kcal</div>`
              ).join('')}
            </div>
            <div class="text-sm font-medium text-sky-400">
              Total: ${Math.round(refeicao.totais.kcal)} kcal ¬∑ P ${r1(refeicao.totais.prot)}g ¬∑ C ${r1(refeicao.totais.carb)}g ¬∑ G ${r1(refeicao.totais.fat)}g ¬∑ F ${r1(refeicao.totais.fiber)}g
            </div>
          </div>
        `;
      });
      
      // Total geral do dia
      const totalGeral = Object.values(refeicoesAgrupadas).reduce((acc, ref) => ({
        kcal: acc.kcal + ref.totais.kcal,
        prot: acc.prot + ref.totais.prot,
        carb: acc.carb + ref.totais.carb,
        fat: acc.fat + ref.totais.fat,
        fiber: acc.fiber + ref.totais.fiber
      }), { kcal: 0, prot: 0, carb: 0, fat: 0, fiber: 0 });
      
      html += `
        <div class="glass rounded-lg p-4 border-2 border-sky-400/50">
          <h4 class="font-semibold text-sky-400 mb-2">Total do dia</h4>
          <div class="text-lg font-bold text-sky-400">
            ${Math.round(totalGeral.kcal)} kcal
          </div>
          <div class="text-sm text-slate-300">
            P ${r1(totalGeral.prot)}g ¬∑ C ${r1(totalGeral.carb)}g ¬∑ G ${r1(totalGeral.fat)}g ¬∑ F ${r1(totalGeral.fiber)}g
          </div>
        </div>
      `;
      
      html += '</div>';
      relatorioContainer.innerHTML = html;
    }
    
    function calcularTotaisAno(dadosAno) {
      let totais = { kcal: 0, prot: 0, carb: 0, fat: 0, fiber: 0 };
      
      Object.values(dadosAno).forEach(dadosMes => {
        Object.values(dadosMes).forEach(dadosDia => {
          totais.kcal += dadosDia.totais.kcal;
          totais.prot += dadosDia.totais.prot;
          totais.carb += dadosDia.totais.carb;
          totais.fat += dadosDia.totais.fat;
          totais.fiber += dadosDia.totais.fiber;
        });
      });
      
      return totais;
    }
    
    function calcularTotaisMes(dadosMes) {
      let totais = { kcal: 0, prot: 0, carb: 0, fat: 0, fiber: 0 };
      
      Object.values(dadosMes).forEach(dadosDia => {
        totais.kcal += dadosDia.totais.kcal;
        totais.prot += dadosDia.totais.prot;
        totais.carb += dadosDia.totais.carb;
        totais.fat += dadosDia.totais.fat;
        totais.fiber += dadosDia.totais.fiber;
      });
      
      return totais;
    }
    
    function formatarData(data) {
      const [ano, mes, dia] = data.split('-');
      return `${dia}/${mes}/${ano}`;
    }
    
    // Fun√ß√µes globais para os eventos de clique
    window.toggleAno = function(ano) {
      const elemento = document.getElementById(`ano-${ano}`);
      elemento.classList.toggle('hidden');
    }
    
    window.toggleMes = function(anoMes) {
      const elemento = document.getElementById(`mes-${anoMes}`);
      elemento.classList.toggle('hidden');
    }
    
    window.mostrarDetalhesDia = function(data) {
      dataEspecifica.value = data;
      setTipoRelatorio('dia');
      gerarRelatorioDia(data);
    }

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      // LIMPEZA AGRESSIVA AUTOM√ÅTICA
      console.log('=== LIMPEZA AUTOM√ÅTICA INICIADA ===');
      
      // Limpar TUDO primeiro
      localStorage.clear();
      
      // Reinicializar estado completamente limpo
      state = {
        entries: {},
        goal: 2000,
        customFoods: [],
        overrides: {},
        savedMeals: {}
      };
      
      // Resetar configura√ß√µes para padr√£o
      nutritionGoals = {
        kcal: 2000,
        protein: 150,
        carbs: 250,
        fat: 67,
        fiber: 25
      };
      
      mealTypes = [
        'üåÖ Caf√© da Manh√£',
        'ü•™ Lanche da Manh√£', 
        'üçΩÔ∏è Almo√ßo',
        'üç∞ Lanche da Tarde',
        'üåô Jantar',
        'üåú Ceia'
      ];
      
      // Salvar estado limpo
      saveState(state);
      localStorage.setItem('nutritionGoals', JSON.stringify(nutritionGoals));
      localStorage.setItem('mealTypes', JSON.stringify(mealTypes));
      
      console.log('Estado ap√≥s limpeza autom√°tica:', state);
      console.log('=== LIMPEZA AUTOM√ÅTICA CONCLU√çDA ===');
      
      loadConfiguration();
      loadMealTypes();
      
      // FOR√áAR ZEROS NO DASHBOARD
      forceZeroDashboard();
      
      // Configurar navega√ß√£o ap√≥s DOM estar carregado
      setupNavigation();
      
      showTab('home');
      
      // Event listener para adicionar tipo de refei√ß√£o com Enter
      const newMealTypeInput = document.getElementById('newMealType');
      if (newMealTypeInput) {
        newMealTypeInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            addMealType();
          }
        });
      }
    });

    // Fun√ß√£o global para navega√ß√£o (usada pelos onclick)
    window.navigateToTab = function(tabName) {
      console.log('=== NAVEGA√á√ÉO ONCLICK:', tabName, '===');
      
      if (tabName === 'home' || tabName === 'lancamentos') {
        showTab(tabName);
      } else {
        switchTab(tabName);
      }
    };

    // Fun√ß√£o para configurar navega√ß√£o
    function setupNavigation() {
      console.log('=== CONFIGURANDO NAVEGA√á√ÉO ===');
      
      // Verificar se os elementos existem
      const tabHome = document.getElementById('tabHome');
      const tabLancamentos = document.getElementById('tabLancamentos');
      const tabRefeicoes = document.getElementById('tabRefeicoes');
      const tabAlimentos = document.getElementById('tabAlimentos');
      const tabRelatorios = document.getElementById('tabRelatorios');
      
      console.log('Elementos encontrados:', {
        tabHome: !!tabHome,
        tabLancamentos: !!tabLancamentos,
        tabRefeicoes: !!tabRefeicoes,
        tabAlimentos: !!tabAlimentos,
        tabRelatorios: !!tabRelatorios
      });
      
      console.log('=== NAVEGA√á√ÉO CONFIGURADA COM ONCLICK ===');
    }

    // Fun√ß√£o para for√ßar zeros no dashboard
    function forceZeroDashboard() {
      console.log('=== FOR√áANDO ZEROS NO DASHBOARD ===');
      
      // Zerar TODOS os valores usando elHome (com guards)
      if (elHome.kcal.cur) elHome.kcal.cur.textContent = '0';
      if (elHome.prot.cur) elHome.prot.cur.textContent = '0';
      if (elHome.carb.cur) elHome.carb.cur.textContent = '0';
      if (elHome.fat.cur) elHome.fat.cur.textContent = '0';
      if (elHome.fiber.cur) elHome.fiber.cur.textContent = '0';
      
      // Zerar barras de progresso usando elHome (com guards)
      if (elHome.kcal.bar) elHome.kcal.bar.style.strokeDasharray = '0, 100';
      if (elHome.prot.bar) elHome.prot.bar.style.strokeDasharray = '0, 100';
      if (elHome.carb.bar) elHome.carb.bar.style.strokeDasharray = '0, 100';
      if (elHome.fat.bar) elHome.fat.bar.style.strokeDasharray = '0, 100';
      if (elHome.fiber.bar) elHome.fiber.bar.style.strokeDasharray = '0, 100';
      
      // Definir metas usando elHome (com guards)
      if (elHome.kcal.goal) elHome.kcal.goal.textContent = nutritionGoals.kcal;
      if (elHome.prot.goal) elHome.prot.goal.textContent = nutritionGoals.protein;
      if (elHome.carb.goal) elHome.carb.goal.textContent = nutritionGoals.carbs;
      if (elHome.fat.goal) elHome.fat.goal.textContent = nutritionGoals.fat;
      if (elHome.fiber.goal) elHome.fiber.goal.textContent = nutritionGoals.fiber;
      
      // Atualizar data
      const today = new Date();
      const homeDateEl = el('homeDate');
      if (homeDateEl) {
        homeDateEl.textContent = today.toLocaleDateString('pt-BR', {
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
      }
      
      console.log('Dashboard zerado for√ßadamente');
    }

    // Fun√ß√£o para limpar dados antigos
    function cleanOldData() {
      console.log('=== LIMPANDO DADOS ANTIGOS ===');
      
      // Remover keys antigos que podem estar causando problemas
      const oldKeys = [
        'caloria-pwa',
        'caloria-pwa-v1',
        'caloria-pwa-v2', 
        'caloria-pwa-v3',
        'caloria-pwa-v4',
        'hydrationData',
        'waterContainers',
        'dailyWaterGoal',
        'waterLog'
      ];
      
      oldKeys.forEach(key => {
        if (localStorage.getItem(key)) {
          console.log('Removendo key antiga:', key);
          localStorage.removeItem(key);
        }
      });
      
      // Mostrar todas as keys do localStorage
      console.log('Keys no localStorage:', Object.keys(localStorage));
      
      // Verificar se h√° dados corrompidos na chave atual
      try {
        const currentData = localStorage.getItem(LS_KEY);
        if (currentData) {
          console.log('Dados atuais brutos:', currentData);
          JSON.parse(currentData); // Testar se √© v√°lido
        }
      } catch (e) {
        console.log('Dados corrompidos detectados, removendo...');
        // Se houver erro no parse, remover dados corrompidos
        localStorage.removeItem(LS_KEY);
      }
      
      console.log('=== FIM LIMPEZA ===');
    }

    // Fun√ß√£o para limpar todos os dados
    // Testar capacidade de armazenamento
    async function testStorage() {
      const statusDiv = document.getElementById('storageStatus');
      const detailsDiv = document.getElementById('storageDetails');
      
      if (!statusDiv || !detailsDiv) return;
      
      statusDiv.classList.remove('hidden');
      detailsDiv.innerHTML = '<div class="text-yellow-400">‚è≥ Testando...</div>';
      
      const results = [];
      
      // Testar localStorage
      try {
        const testKey = 'test-storage-' + Date.now();
        const testData = JSON.stringify({ test: 'data' });
        localStorage.setItem(testKey, testData);
        const retrieved = localStorage.getItem(testKey);
        localStorage.removeItem(testKey);
        
        if (retrieved === testData) {
          results.push('‚úÖ <strong>localStorage:</strong> Funcionando');
        } else {
          results.push('‚ö†Ô∏è <strong>localStorage:</strong> Leitura inconsistente');
        }
      } catch(e) {
        results.push(`‚ùå <strong>localStorage:</strong> ${e.name}`);
      }
      
      // Testar IndexedDB
      try {
        const testDB = await initDB();
        if (testDB) {
          const testKey = 'test-' + Date.now();
          const testData = { test: 'data', timestamp: Date.now() };
          
          const saved = await saveToIndexedDB(testKey, testData);
          const loaded = await loadFromIndexedDB(testKey);
          
          if (saved && loaded && loaded.test === 'data') {
            results.push('‚úÖ <strong>IndexedDB:</strong> Funcionando');
          } else {
            results.push('‚ö†Ô∏è <strong>IndexedDB:</strong> Leitura inconsistente');
          }
        } else {
          results.push('‚ùå <strong>IndexedDB:</strong> N√£o dispon√≠vel');
        }
      } catch(e) {
        results.push(`‚ùå <strong>IndexedDB:</strong> ${e.message}`);
      }
      
      // Verificar modo privado
      try {
        const isPrivate = !window.indexedDB || 
                         (localStorage.length === 0 && sessionStorage.length === 0);
        if (isPrivate) {
          results.push('‚ö†Ô∏è <strong>Modo Privado:</strong> Poss√≠vel');
        } else {
          results.push('‚úÖ <strong>Modo Privado:</strong> N√£o detectado');
        }
      } catch(e) {
        results.push('‚ö†Ô∏è <strong>Modo Privado:</strong> N√£o foi poss√≠vel verificar');
      }
      
      // Verificar tamanho dos dados
      try {
        const dataSize = JSON.stringify(state).length;
        const dataSizeKB = (dataSize / 1024).toFixed(2);
        results.push(`‚ÑπÔ∏è <strong>Tamanho dos dados:</strong> ${dataSizeKB} KB`);
        
        const entriesDays = Object.keys(state.entries || {}).length;
        const mealsDays = Object.keys(state.savedMeals || {}).length;
        results.push(`‚ÑπÔ∏è <strong>Dias com dados:</strong> ${entriesDays} lan√ßamentos, ${mealsDays} refei√ß√µes`);
      } catch(e) {
        results.push('‚ö†Ô∏è N√£o foi poss√≠vel calcular tamanho');
      }
      
      detailsDiv.innerHTML = results.join('<br>');
      
      console.log('üîç Teste de armazenamento conclu√≠do:', results);
    }
    
    // For√ßar salvamento completo
    async function forceFullSave() {
      const btn = event.target;
      const originalText = btn.textContent;
      
      try {
        btn.disabled = true;
        btn.textContent = 'üíæ Salvando...';
        
        console.log('üöÄ FOR√áANDO SALVAMENTO COMPLETO');
        await saveState(state);
        
        btn.textContent = '‚úÖ Salvo!';
        btn.className = btn.className.replace('bg-green-500', 'bg-green-600');
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.className = btn.className.replace('bg-green-600', 'bg-green-500');
          btn.disabled = false;
        }, 2000);
        
      } catch(e) {
        console.error('‚ùå Erro ao for√ßar salvamento:', e);
        btn.textContent = '‚ùå Erro!';
        btn.className = btn.className.replace('bg-green-500', 'bg-red-500');
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.className = btn.className.replace('bg-red-500', 'bg-green-500');
          btn.disabled = false;
        }, 2000);
      }
    }

    // Sincroniza√ß√£o manual para o servidor (Supabase)
    async function manualSyncToServer() {
      const btn = event.target;
      const originalText = btn.textContent;
      
      try {
        btn.disabled = true;
        btn.textContent = '‚òÅÔ∏è Enviando...';
        
        console.log('üöÄ SINCRONIZA√á√ÉO MANUAL PARA SERVIDOR');
        
        if (!navigator.onLine) {
          throw new Error('Voc√™ est√° offline! Conecte-se √† internet para sincronizar.');
        }
        
        if (!state.user || !state.user.id) {
          throw new Error('Usu√°rio n√£o autenticado!');
        }
        
        await syncToSupabase();
        
        btn.textContent = '‚úÖ Enviado!';
        btn.className = btn.className.replace('bg-purple-500', 'bg-green-500');
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.className = btn.className.replace('bg-green-500', 'bg-purple-500');
          btn.disabled = false;
        }, 2000);
        
      } catch(e) {
        console.error('‚ùå Erro na sincroniza√ß√£o para servidor:', e);
        btn.textContent = '‚ùå ' + (e.message || 'Erro!');
        btn.className = btn.className.replace('bg-purple-500', 'bg-red-500');
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.className = btn.className.replace('bg-red-500', 'bg-purple-500');
          btn.disabled = false;
        }, 3000);
      }
    }

    // Sincroniza√ß√£o manual do servidor (Supabase)
    async function manualSyncFromServer() {
      const btn = event.target;
      const originalText = btn.textContent;
      
      try {
        btn.disabled = true;
        btn.textContent = 'üì• Buscando...';
        
        console.log('üöÄ SINCRONIZA√á√ÉO MANUAL DO SERVIDOR');
        
        if (!navigator.onLine) {
          throw new Error('Voc√™ est√° offline! Conecte-se √† internet para sincronizar.');
        }
        
        if (!state.user || !state.user.id) {
          throw new Error('Usu√°rio n√£o autenticado!');
        }
        
        await syncFromSupabase();
        
        // Atualizar interface para refletir dados sincronizados
        if (currentPage === 'home') {
          renderHome();
        } else if (currentPage === 'meals') {
          renderMeals();
        } else if (currentPage === 'history') {
          renderHistory();
        }
        
        btn.textContent = '‚úÖ Atualizado!';
        btn.className = btn.className.replace('bg-blue-500', 'bg-green-500');
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.className = btn.className.replace('bg-green-500', 'bg-blue-500');
          btn.disabled = false;
        }, 2000);
        
      } catch(e) {
        console.error('‚ùå Erro na sincroniza√ß√£o do servidor:', e);
        btn.textContent = '‚ùå ' + (e.message || 'Erro!');
        btn.className = btn.className.replace('bg-blue-500', 'bg-red-500');
        
        setTimeout(() => {
          btn.textContent = originalText;
          btn.className = btn.className.replace('bg-red-500', 'bg-blue-500');
          btn.disabled = false;
        }, 3000);
      }
    }

    function clearAllData() {
      if (!confirm('ATEN√á√ÉO: Isso ir√° remover TODOS os dados do aplicativo (lan√ßamentos, refei√ß√µes, configura√ß√µes). Tem certeza?')) {
        return;
      }
      
      if (!confirm('√öltima confirma√ß√£o: Todos os dados ser√£o perdidos permanentemente. Continuar?')) {
        return;
      }
      
      // Limpar localStorage completamente
      localStorage.clear();
      
      // Reinicializar estado
      state = {
        entries: {},
        goal: 2000,
        customFoods: [],
        overrides: {},
        savedMeals: {}
      };
      
      // Resetar configura√ß√µes
      nutritionGoals = {
        kcal: 2000,
        protein: 150,
        carbs: 250,
        fat: 67,
        fiber: 25
      };
      
      mealTypes = [
        'üåÖ Caf√© da Manh√£',
        'ü•™ Lanche da Manh√£', 
        'üçΩÔ∏è Almo√ßo',
        'üç∞ Lanche da Tarde',
        'üåô Jantar',
        'üåú Ceia'
      ];
      
      // Salvar estado limpo
      saveState(state);
      localStorage.setItem('nutritionGoals', JSON.stringify(nutritionGoals));
      localStorage.setItem('mealTypes', JSON.stringify(mealTypes));
      
      // Recarregar p√°gina para aplicar mudan√ßas
      window.location.reload();
    }

    // Fun√ß√£o para limpeza imediata (pode ser chamada no console)
    window.forceCleanData = function() {
      console.log('=== LIMPEZA FOR√áADA ===');
      
      // Mostrar estado atual
      console.log('Estado antes da limpeza:', state);
      console.log('localStorage keys:', Object.keys(localStorage));
      
      // Limpar completamente
      localStorage.clear();
      console.log('localStorage limpo');
      
      // Reinicializar
      state = {
        entries: {},
        goal: 2000,
        customFoods: [],
        overrides: {},
        savedMeals: {}
      };
      
      saveState(state);
      console.log('Estado reinicializado:', state);
      
      // Atualizar dashboard
      updateHomeDashboard();
      console.log('Dashboard atualizado');
      
      console.log('=== LIMPEZA CONCLU√çDA ===');
    };

    // Fun√ß√£o para limpar dados de hoje especificamente
    window.clearTodayData = function() {
      console.log('=== LIMPANDO DADOS DE HOJE ===');
      const today = getTodayString();
      console.log('Data de hoje:', today);
      
      // Remover dados de hoje
      if (state.entries[today]) {
        delete state.entries[today];
        console.log('Lan√ßamentos de hoje removidos');
      }
      
      if (state.savedMeals[today]) {
        delete state.savedMeals[today];
        console.log('Refei√ß√µes salvas de hoje removidas');
      }
      
      saveState(state);
      updateHomeDashboard();
      
      console.log('Estado ap√≥s limpeza:', state);
      console.log('=== LIMPEZA DE HOJE CONCLU√çDA ===');
    };

    /* === MODAL NOVO ALIMENTO === */
    let newFoodModal, newFoodBackdrop, nfName, nfKcal, nfProt, nfCarb, nfFat, nfFiber;
    
    function initNewFoodModal() {
      console.log('=== INICIALIZANDO MODAL NOVO ALIMENTO ===');
      newFoodModal = el('newFoodModal');
      newFoodBackdrop = el('newFoodBackdrop');
      nfName = el('nfName');
      nfKcal = el('nfKcal');
      nfProt = el('nfProt');
      nfCarb = el('nfCarb');
      nfFat = el('nfFat');
      nfFiber = el('nfFiber');
      
      console.log('newFoodModal encontrado:', !!newFoodModal);
      console.log('Elementos do formul√°rio:', {nfName: !!nfName, nfKcal: !!nfKcal});
      
      // Bot√£o "Novo alimento"
      const btnNewFood = el('btnNovoAlimento');
      console.log('btnNewFood encontrado:', !!btnNewFood);
      
      if (btnNewFood) {
        btnNewFood.onclick = null; // Remover onclick antigo
        btnNewFood.addEventListener('click', (e) => {
          console.log('üîµ Bot√£o Novo Alimento clicado!');
          e.preventDefault();
          e.stopPropagation();
          openNewFoodModal();
        }, false);
        console.log('‚úÖ Event listener adicionado ao bot√£o Novo Alimento');
      } else {
        console.error('‚ùå Bot√£o btnNovoAlimento n√£o encontrado no DOM!');
      }
      
      // Fechar por backdrop
      if (newFoodBackdrop) {
        newFoodBackdrop.addEventListener('click', closeNewFoodModal);
      }
      
      // Fechar por bot√£o Desistir
      const nfCancel = el('nfCancel');
      if (nfCancel) {
        nfCancel.addEventListener('click', closeNewFoodModal);
      }
      
      // Fechar por ESC
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && newFoodModal && !newFoodModal.classList.contains('hidden')) {
          closeNewFoodModal();
        }
      });
      
      // Salvar alimento
      const nfSave = el('nfSave');
      if (nfSave) {
        nfSave.addEventListener('click', saveNewFood);
      }
      
      console.log('=== MODAL INICIALIZADO ===');
    }
    
    function openNewFoodModal() {
      console.log('=== ABRINDO MODAL NOVO ALIMENTO ===');
      const modal = newFoodModal || document.getElementById('newFoodModal');
      if (!modal) {
        console.error('‚ùå Modal n√£o encontrado!');
        alert('Erro: Modal n√£o encontrado. Recarregue a p√°gina.');
        return;
      }
      // Limpar campos
      [nfName, nfKcal, nfProt, nfCarb, nfFat, nfFiber].forEach(elem => {
        if (elem) elem.value = '';
      });
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      console.log('‚úÖ Modal aberto');
      if (nfName) nfName.focus();
    }
    
    // Tornar fun√ß√£o global dispon√≠vel imediatamente
    window.abrirModalNovoAlimento = openNewFoodModal;
    
    function closeNewFoodModal() {
      if (!newFoodModal) return;
      newFoodModal.classList.add('hidden');
      newFoodModal.classList.remove('flex');
      console.log('‚úÖ Modal fechado');
    }
    
    function saveNewFood() {
      console.log('=== SALVANDO NOVO ALIMENTO ===');
      const name = (nfName?.value || '').trim();
      const kcal = parseFloat(nfKcal?.value || '0') || 0;
      const prot = parseFloat(nfProt?.value || '0') || 0;
      const carb = parseFloat(nfCarb?.value || '0') || 0;
      const fat = parseFloat(nfFat?.value || '0') || 0;
      const fiber = parseFloat(nfFiber?.value || '0') || 0;
      
      console.log('Dados coletados:', {name, kcal, prot, carb, fat, fiber});
      
      if (!name) {
        alert('‚ö†Ô∏è Informe o nome do alimento');
        if (nfName) nfName.focus();
        return;
      }
      
      // Gerar ID est√°vel (slug)
      const id = 'cf_' + name.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_|_$/g, '');
      
      // Criar alimento
      const newFood = {
        id,
        name,
        nameLower: name.toLowerCase(),
        unitBase: 'g',
        kcal100: kcal,
        prot100: prot,
        carb100: carb,
        fat100: fat,
        fiber100: fiber
      };
      
      console.log('Novo alimento criado:', newFood);
      
      // Adicionar ao state
      if (!Array.isArray(state.customFoods)) {
        state.customFoods = [];
      }
      
      // Verificar se j√° existe e substituir, ou adicionar novo
      const existingIndex = state.customFoods.findIndex(f => f.id === id);
      if (existingIndex >= 0) {
        state.customFoods[existingIndex] = newFood;
        console.log('Alimento existente atualizado');
      } else {
        state.customFoods.push(newFood);
        console.log('Novo alimento adicionado ao array');
      }
      
      // Salvar no localStorage
      saveState(state);
      console.log('Estado salvo no localStorage');
      
      // Fechar modal
      closeNewFoodModal();
      
      // Feedback visual
      alert('‚úÖ Alimento salvo com sucesso!');
      
      // Atualizar contador e lista se estiver vis√≠vel
      updateAlimentosCounter();
      
      if (alimentosListWrapper && !alimentosListWrapper.classList.contains('hidden')) {
        if (typeof loadAlimentosTab === 'function') {
          loadAlimentosTab();
        }
      }
      
      console.log('=== ALIMENTO SALVO COM SUCESSO ===');
    }
    
    // Fun√ß√£o para diagn√≥stico (pode ser chamada no console)
    window.diagnoseDirtyData = function() {
      console.log('=== DIAGN√ìSTICO ===');
      console.log('Data atual:', getTodayString());
      console.log('Estado completo:', state);
      console.log('Todas as keys do localStorage:', Object.keys(localStorage));
      
      // Verificar cada key do localStorage
      Object.keys(localStorage).forEach(key => {
        console.log(`${key}:`, localStorage.getItem(key));
      });
      
      // Verificar dados de hoje
      const today = getTodayString();
      console.log('Entradas de hoje:', state.entries[today]);
      console.log('Refei√ß√µes salvas hoje:', state.savedMeals[today]);
      
      // Verificar dados calculados
      const todayEntries = getTodayEntries();
      console.log('Entradas processadas:', todayEntries);
      
      let totalKcal = 0;
      todayEntries.forEach(entry => {
        totalKcal += entry.kcal || 0;
        console.log('Entry kcal:', entry.kcal, 'Acumulado:', totalKcal);
      });
      
      console.log('Total final de kcal:', totalKcal);
      console.log('=== FIM DIAGN√ìSTICO ===');
    };
    
    // Fun√ß√£o de teste r√°pido para debug
    window.testarApp = function() {
      console.log('=== TESTE DO APP ===');
      console.log('1. Dexie dispon√≠vel?', typeof Dexie !== 'undefined');
      console.log('2. NutriDB dispon√≠vel?', !!window.NutriDB);
      console.log('3. builtinFoods.length:', builtinFoods.length);
      console.log('4. state.customFoods.length:', state.customFoods.length);
      console.log('5. allFoods().length:', allFoods().length);
      console.log('6. alimentosCounter existe?', !!document.getElementById('alimentosCounter'));
      console.log('7. btnNovoAlimento existe?', !!document.getElementById('btnNovoAlimento'));
      console.log('8. newFoodModal existe?', !!document.getElementById('newFoodModal'));
      console.log('9. abrirModalNovoAlimento definido?', typeof window.abrirModalNovoAlimento);
      
      // Tentar atualizar contador
      console.log('10. Tentando atualizar contador...');
      updateAlimentosCounter();
      
      console.log('=== FIM DO TESTE ===');
      console.log('Digite window.abrirModalNovoAlimento() para testar o modal');
    };
    
    // Fun√ß√£o para verificar status da sess√£o Supabase
    window.verificarSessaoSupabase = async function() {
      console.log('=== VERIFICA√á√ÉO SESS√ÉO SUPABASE ===');
      
      if (!supabase) {
        console.error('‚ùå Supabase n√£o inicializado');
        return;
      }
      
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
          console.error('‚ùå Erro ao obter sess√£o:', error);
          return;
        }
        
        if (!session) {
          console.warn('‚ö†Ô∏è Nenhuma sess√£o ativa');
          console.warn('üí° Fa√ßa login novamente para criar uma sess√£o');
          return;
        }
        
        console.log('‚úÖ Sess√£o ativa encontrada!');
        console.log('üìß Email:', session.user.email);
        console.log('üÜî User ID:', session.user.id);
        console.log('üìÖ Email confirmado:', session.user.email_confirmed_at || 'N√ÉO CONFIRMADO');
        console.log('üîë Token JWT:', session.access_token ? 'Presente (v√°lido)' : 'Ausente');
        console.log('‚è∞ Expira em:', new Date(session.expires_at * 1000).toLocaleString());
        
        // Verificar se o usu√°rio local coincide
        if (currentUser) {
          console.log('üë§ Usu√°rio local:', currentUser.email);
          if (currentUser.supabaseId === session.user.id) {
            console.log('‚úÖ Usu√°rio local COINCIDE com sess√£o Supabase');
          } else {
            console.warn('‚ö†Ô∏è Usu√°rio local N√ÉO coincide com sess√£o Supabase');
            console.warn('   Local ID:', currentUser.id);
            console.warn('   Supabase ID:', session.user.id);
          }
        } else {
          console.warn('‚ö†Ô∏è Nenhum usu√°rio local (currentUser √© null)');
        }
        
      } catch(e) {
        console.error('‚ùå Erro ao verificar sess√£o:', e);
      }
      
      console.log('=== FIM VERIFICA√á√ÉO ===');
      console.log('üí° Se o email N√ÉO est√° confirmado, veja SUPABASE-CONFIG.md');
    };
    
    console.log('üí° Digite window.testarApp() no console para diagnosticar problemas');
    console.log('üí° Digite window.verificarSessaoSupabase() para verificar autentica√ß√£o');
    console.log('üí° Digite window.diagnosticoPWA() para verificar instala√ß√£o PWA');
  </script>

  <!-- Modal: Trocar Senha -->
  <div id="changePasswordModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/50" onclick="closeChangePasswordModal()"></div>
    <div class="relative w-full max-w-md mx-auto p-6 rounded-2xl shadow-xl glass">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold">üîë Trocar Senha</h3>
        <button onclick="closeChangePasswordModal()" class="text-slate-400 hover:text-white text-2xl leading-none">√ó</button>
      </div>
      
      <form id="changePasswordForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">
            Senha Atual
          </label>
          <input 
            type="password" 
            id="currentPassword" 
            required
            class="w-full px-4 py-3 rounded-lg bg-slate-800/50 border border-slate-700 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all outline-none"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">
            Nova Senha
          </label>
          <input 
            type="password" 
            id="newPassword" 
            required
            minlength="6"
            class="w-full px-4 py-3 rounded-lg bg-slate-800/50 border border-slate-700 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all outline-none"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          />
          <p class="text-xs text-slate-400 mt-1">M√≠nimo de 6 caracteres</p>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">
            Confirmar Nova Senha
          </label>
          <input 
            type="password" 
            id="confirmNewPassword" 
            required
            minlength="6"
            class="w-full px-4 py-3 rounded-lg bg-slate-800/50 border border-slate-700 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 transition-all outline-none"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          />
        </div>
        
        <div id="changePasswordMessage" class="hidden p-3 rounded-lg text-sm text-center"></div>
        
        <div class="flex gap-3">
          <button 
            type="button"
            onclick="closeChangePasswordModal()"
            class="flex-1 px-4 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 transition-all"
          >
            Cancelar
          </button>
          <button 
            type="submit"
            class="flex-1 btn-gradient py-3 rounded-lg font-semibold"
          >
            Confirmar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Novo Alimento -->
  <div id="newFoodModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/50" id="newFoodBackdrop"></div>
    <div class="relative w-full max-w-md mx-auto p-6 rounded-2xl shadow-xl glass">
      <h3 class="text-xl font-semibold mb-4">Novo alimento</h3>
      <div class="space-y-3">
        <input id="nfName" type="text" placeholder="Nome do alimento" class="nf-input" />
        <div class="grid grid-cols-2 gap-3">
          <input id="nfKcal" type="number" step="0.01" placeholder="Calorias (kcal)" class="nf-input" />
          <input id="nfProt" type="number" step="0.01" placeholder="Prote√≠nas (g)" class="nf-input" />
          <input id="nfCarb" type="number" step="0.01" placeholder="Carboidratos (g)" class="nf-input" />
          <input id="nfFat" type="number" step="0.01" placeholder="Gorduras (g)" class="nf-input" />
          <input id="nfFiber" type="number" step="0.01" placeholder="Fibras (g)" class="nf-input" />
        </div>
      </div>
      <div class="mt-6 flex gap-3 justify-end">
        <button id="nfCancel" class="btn btn-ghost" onclick="window.fecharModalNovoAlimento && window.fecharModalNovoAlimento()">Desistir</button>
        <button id="nfSave" class="btn btn-primary" onclick="window.salvarNovoAlimento && window.salvarNovoAlimento()">Salvar</button>
      </div>
    </div>
  </div>

  <style>
    .nf-input {
      background: var(--bg-glass);
      border: 1px solid var(--border-glass);
      padding: 0.75rem;
      border-radius: 0.75rem;
      width: 100%;
      color: var(--text-primary);
    }
    .nf-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }
  </style>
</body>
</html>

